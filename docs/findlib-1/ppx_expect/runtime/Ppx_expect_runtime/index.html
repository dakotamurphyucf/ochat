<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Ppx_expect_runtime (docs.findlib-1.ppx_expect.runtime.Ppx_expect_runtime)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../../../';
let search_urls = ['../../../../db.js','../../../../sherlodoc.js'];
</script><script src="../../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../../index.html">Index</a> &#x00BB; <a href="../../../../index.html">docs</a> &#x00BB; <a href="../../../index.html">findlib-1</a> &#x00BB; <a href="../../index.html">ppx_expect</a> &#x00BB; <a href="../index.html">runtime</a> &#x00BB; Ppx_expect_runtime</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Ppx_expect_runtime</span></code></h1><p>This library provides the runtime representation of expect tests and much of the logic for running them.</p><p>The <code>Test_block</code> module defines the runtime representation of the whole <code>let%expect_test</code> block. It exports a <code>Make</code> functor that is used in generated code to produce a module from the locally bound <code>Expect_test_config</code>. <code>run_suite</code> from the resulting module takes in remaining information about the expect test, including inline test configurations, information about the contained expectations, and a callback containing the body of the test.</p><p>The <code>~expectations</code> argument to <code>run_suite</code> is an assoc list mapping unique ids to <code>Test_node.t</code>s. A <code>Test_node.t</code> stores the representation of a single <code>[%expect]</code> test AST node and collects the results of tests that reach this node.</p><p>In the body of the test, the <code>[%expect]</code> AST nodes are replaced by calls to <code>run_test</code>, with the appropriate id passed as an argument.</p><p>For an example, consider a file that contains just the simple <code>let%expect_test</code> below:</p><pre class="language-ocaml"><code>  let%expect_test _ =
    print_string &quot;Hello&quot;;
    [%expect {| Hello |}];
    print_string &quot;world&quot;;
    [%expect_exact {x|world|x}]
  ;;</code></pre><p>It will expand to code that looks something like this:</p><pre class="language-ocaml"><code>  (* This statement is added to the top of each rewritten file; it is used to make
     sure tests are only run from the files in which they are declared. *)
  let () =
    Ppx_expect_runtime.Current_file.set
      ~filename_rel_to_project_root:&quot;foo/bar/test/test.ml&quot;

  (* Each test expands into something that looks approximately like this. Some of the
     arguments to [Ppx_expect_test_block.run_suite] are elided for clarity. *)
  let () =
    (* Prepare to read test output using the settings from [Expect_test_config] *)
    let module Ppx_expect_test_block =
      Ppx_expect_runtime.Make_test_block(Expect_test_config) in
    Ppx_expect_test_block.run_suite
      (* The name of the file in which the test is defined. This lets the runtime
         check that the filename set here at ppx-time matches the one that is set by
         the block above at runtime. If the test were defined in a functor and that
         functor invoked from another file, the filenames would not match. *)
      ~filename_rel_to_project_root:&quot;foo/bar/test/test.ml&quot;
      (* The ids that should be used when registering the trailing output test and the
         uncaught exception tests. They are minted at ppx time because that is the
         time that it is easiest to guarantee their uniqueness. *)
      ~trailing_test_id:(Ppx_expect_runtime.Expectation_id.of_int 2)
      ~exn_test_id:(Ppx_expect_runtime.Expectation_id.of_int 3)
      (* An assoc list mapping ids to representations of expect nodes that appear in
         this test. Later, when encountering expect nodes, information about them is
         looked up in this table. *)
      ~expectations:(([(Ppx_expect_runtime.Expectation_id.of_int 1,
                        Ppx_expect_runtime.Test_node.Create.expect_exact
                          { contents = &quot;world&quot;; tag = (Tag &quot;x&quot;) }
                          { start_bol = ...; start_pos = ...; end_pos = ... });
                       (Ppx_expect_runtime.Expectation_id.of_int 0,
                        Ppx_expect_runtime.Test_node.Create.expect
                          { contents = &quot; Hello &quot;; tag = (Tag &quot;&quot;) }
                          { start_bol = ...; start_pos = ...; end_pos = ... })])
                    )
      (* The body of the let binding is passed as a callback. *)
      (fun () -&gt;
         print_string &quot;Hello&quot;;
         (* Tests are run by passing in the id of the encountered test node. *)
         Ppx_expect_test_block.run_test
           ~test_id:(Ppx_expect_runtime.Expectation_id.of_int 0);
         print_string &quot;world&quot;;
         Ppx_expect_test_block.run_test
           ~test_id:(Ppx_expect_runtime.Expectation_id.of_int 1))

  (* This statement is added to the end of each file so that the expect test runtime
     knows the file is finished executing and a new one can be set as current. *)
  let () = Ppx_expect_runtime.Current_file.unset ()</code></pre></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-Expect_node_formatting"><a href="#module-Expect_node_formatting" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Expect_node_formatting/index.html">Expect_node_formatting</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Compact_loc"><a href="#module-Compact_loc" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Compact_loc/index.html">Compact_loc</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Expectation_id"><a href="#module-Expectation_id" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Expectation_id/index.html">Expectation_id</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Delimiter"><a href="#module-Delimiter" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Delimiter/index.html">Delimiter</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Payload"><a href="#module-Payload" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Payload/index.html">Payload</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Current_file"><a href="#module-Current_file" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Current_file/index.html">Current_file</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Test_node"><a href="#module-Test_node" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Test_node/index.html">Test_node</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Write_corrected_file"><a href="#module-Write_corrected_file" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Write_corrected_file/index.html">Write_corrected_file</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Make_test_block"><a href="#module-Make_test_block" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Make_test_block/index.html">Make_test_block</a></span><span> (<a href="Make_test_block/argument-1-C/index.html">C</a> : <a href="../../config_types/Expect_test_config_types/module-type-S/index.html">Expect_test_config_types.S</a>) : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-For_external"><a href="#module-For_external" class="anchor"></a><code><span><span class="keyword">module</span> <a href="For_external/index.html">For_external</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Functions for other libraries to interact with expect tests.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-For_apply_style"><a href="#module-For_apply_style" class="anchor"></a><code><span><span class="keyword">module</span> <a href="For_apply_style/index.html">For_apply_style</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
