<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Relevance_judge (ochat.Context_compaction.Relevance_judge)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Context_compaction</a> &#x00BB; Relevance_judge</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Context_compaction.Relevance_judge</span></code></h1><p>Messageâ€“relevance scorer used by the <a href="../Compactor/index.html"><code>Context_compaction.Compactor</code></a> when deciding which chat messages to keep below a token budget.</p><p>At its core the module wraps a <code>Meta_prompting.Evaluator.t</code> that contains a single <em>judge</em>. The judge runs OpenAIâ€™s public *grader* endpoint with a purpose-built system prompt that asks the model to rate the <b>importance</b> of a message on a continuous scale from <code>0</code> (irrelevant) to <code>1</code> (crucial). The grader call is memoised and â€“ if the environment variable <code>b[OPENAI_API_KEY]</code> is missing â€“ replaced by a deterministic offline fallback that always yields <code>0.5</code>. This makes unit tests reproducible and keeps the compaction pipeline usable in fully offline settings.</p><p>The public surface is intentionally small: callers can obtain the raw floating-point relevance score via <a href="#val-score_relevance"><code>score_relevance</code></a> or apply the user-configurable threshold check via <a href="#val-is_relevant"><code>is_relevant</code></a>. All other implementation details (self-consistency aggregation, exception guards, etc.) are private.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-score_relevance"><a href="#val-score_relevance" class="anchor"></a><code><span><span class="keyword">val</span> score_relevance : 
  <span><span class="optlabel">?env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Config/index.html#type-t">Config.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">prompt</span>:string <span class="arrow">&#45;&gt;</span></span>
  float</span></code></div><div class="spec-doc"><p><code>score_relevance ?env cfg ~prompt</code> scores the importance of <code>prompt</code> on the closed interval </p><pre class="language-ocaml"><code>0,1</code></pre><p>.</p><p>â€¢ A score of <code>0.</code> indicates the message can be dropped without harming the assistantâ€™s ability to resume the conversation.</p><p>â€¢ A score of <code>1.</code> marks the message as indispensable.</p><p>The evaluation strategy is determined by <code>cfg</code> (see <a href="../Config/index.html"><code>Context_compaction.Config</code></a>). Currently only the threshold value is used â€“ the function always consumes the full message text and does not look at <code>cfg.context_limit</code>.</p><p>The optional <code>env</code> parameter provides the Eio capabilities needed for network access. If omitted or if the <code>b[OPENAI_API_KEY]</code> variable is not set, the function falls back to the deterministic value <code>0.5</code>. This is exactly the midpoint of the default threshold and therefore preserves the original semantics in unit tests.</p><p>Example (offline default):</p><pre class="language-ocaml"><code> let score = Relevance_judge.score_relevance Config.default ~prompt:&quot;Hello&quot; in
   Float.round_decimal score ~decimal_digits:3 (* =&gt; 0.5 *) </code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_relevant"><a href="#val-is_relevant" class="anchor"></a><code><span><span class="keyword">val</span> is_relevant : 
  <span><span class="optlabel">?env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Config/index.html#type-t">Config.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">prompt</span>:string <span class="arrow">&#45;&gt;</span></span>
  bool</span></code></div><div class="spec-doc"><p><code>is_relevant ?env cfg ~prompt</code> returns <code>true</code> when the importance score is <code>&gt;=</code> <code>cfg.relevance_threshold</code>. It is a thin wrapper around <a href="#val-score_relevance"><code>score_relevance</code></a> that saves the caller from manually comparing against the threshold.</p><p>Example using a stricter custom threshold:</p><pre class="language-ocaml"><code> let cfg = { Config.default with relevance_threshold = 0.8 } in
   Relevance_judge.is_relevant cfg ~prompt:&quot;FYI, lunch break&quot; (* =&gt; false *) </code></pre></div></div></div></body></html>
