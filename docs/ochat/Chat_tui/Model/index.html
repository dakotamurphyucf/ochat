<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Model (ochat.Chat_tui.Model)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_tui</a> &#x00BB; Model</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_tui.Model</span></code></h1><p>Mutable snapshot of the TUI state.</p><p>The <a href="#"><code>Chat_tui.Model</code></a> module concentrates every piece of information that the Ochat terminal UI needs to render the current session and to react to user input. The record is still <b>mutable</b> because the refactor towards a pure Elm-style architecture (immutable model + explicit patches) is carried out incrementally. A future change will turn <code>t</code> into an immutable value that gets rebuilt by <a href="#val-apply_patch"><code>apply_patch</code></a> instead of modified in place.</p><p>Until then the module provides two things:</p><p>‚Ä¢ a thin constructor <a href="#val-create"><code>create</code></a> that packs pre-existing references into a single bundle so they can be passed around conveniently; and ‚Ä¢ a set of *helper* functions that encapsulate common mutations such as toggling Vim-style modes, pushing undo states or applying the high-level <a href="../Types/index.html#type-patch"><code>Types.patch</code></a> commands emitted by the controller.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#command-mode-helpers">Command-mode helpers</a></li><li><a href="#command-line-helpers">Command-line helpers</a></li><li><a href="#fork-helpers">Fork helpers</a></li><li><a href="#undo-/-redo-helpers">Undo / Redo helpers</a></li><li><a href="#applying-patches">Applying patches</a></li></ul></nav></div><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = </span><span>{</span></code><ol><li id="type-t.history_items" class="def record field anchored"><a href="#type-t.history_items" class="anchor"></a><code><span><span class="keyword">mutable</span> history_items : <span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> list</span>;</span></code></li><li id="type-t.messages" class="def record field anchored"><a href="#type-t.messages" class="anchor"></a><code><span><span class="keyword">mutable</span> messages : <span><a href="../Types/index.html#type-message">Types.message</a> list</span>;</span></code></li><li id="type-t.input_line" class="def record field anchored"><a href="#type-t.input_line" class="anchor"></a><code><span><span class="keyword">mutable</span> input_line : string;</span></code></li><li id="type-t.auto_follow" class="def record field anchored"><a href="#type-t.auto_follow" class="anchor"></a><code><span><span class="keyword">mutable</span> auto_follow : bool;</span></code></li><li id="type-t.msg_buffers" class="def record field anchored"><a href="#type-t.msg_buffers" class="anchor"></a><code><span>msg_buffers : <span><span>(string, <a href="../Types/index.html#type-msg_buffer">Types.msg_buffer</a>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.function_name_by_id" class="def record field anchored"><a href="#type-t.function_name_by_id" class="anchor"></a><code><span>function_name_by_id : <span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.reasoning_idx_by_id" class="def record field anchored"><a href="#type-t.reasoning_idx_by_id" class="anchor"></a><code><span>reasoning_idx_by_id : <span><span>(string, <span>int <span class="xref-unresolved">Stdlib</span>.ref</span>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.tasks" class="def record field anchored"><a href="#type-t.tasks" class="anchor"></a><code><span><span class="keyword">mutable</span> tasks : <span><a href="../../Session/Task/index.html#type-t">Session.Task.t</a> list</span>;</span></code></li><li id="type-t.kv_store" class="def record field anchored"><a href="#type-t.kv_store" class="anchor"></a><code><span>kv_store : <span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.fetch_sw" class="def record field anchored"><a href="#type-t.fetch_sw" class="anchor"></a><code><span><span class="keyword">mutable</span> fetch_sw : <span><span class="xref-unresolved">Eio</span>.Switch.t option</span>;</span></code></li><li id="type-t.scroll_box" class="def record field anchored"><a href="#type-t.scroll_box" class="anchor"></a><code><span>scroll_box : <a href="../../Notty_scroll_box/index.html#type-t">Notty_scroll_box.t</a>;</span></code></li><li id="type-t.cursor_pos" class="def record field anchored"><a href="#type-t.cursor_pos" class="anchor"></a><code><span><span class="keyword">mutable</span> cursor_pos : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Current position inside <code>input_line</code> (bytes).</p><span class="comment-delim">*)</span></div></li><li id="type-t.selection_anchor" class="def record field anchored"><a href="#type-t.selection_anchor" class="anchor"></a><code><span><span class="keyword">mutable</span> selection_anchor : <span>int option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Anchor position for active selection.</p><span class="comment-delim">*)</span></div></li><li id="type-t.mode" class="def record field anchored"><a href="#type-t.mode" class="anchor"></a><code><span><span class="keyword">mutable</span> mode : <a href="#type-editor_mode">editor_mode</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Current editor mode (Insert/Normal).</p><span class="comment-delim">*)</span></div></li><li id="type-t.draft_mode" class="def record field anchored"><a href="#type-t.draft_mode" class="anchor"></a><code><span><span class="keyword">mutable</span> draft_mode : <a href="#type-draft_mode">draft_mode</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Whether the draft buffer is plain text or raw XML.</p><span class="comment-delim">*)</span></div></li><li id="type-t.selected_msg" class="def record field anchored"><a href="#type-t.selected_msg" class="anchor"></a><code><span><span class="keyword">mutable</span> selected_msg : <span>int option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Currently selected message (Normal mode), if any.</p><span class="comment-delim">*)</span></div></li><li id="type-t.undo_stack" class="def record field anchored"><a href="#type-t.undo_stack" class="anchor"></a><code><span><span class="keyword">mutable</span> undo_stack : <span><span>(string * int)</span> list</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Undo ring ‚Äì previous states (line, cursor)</p><span class="comment-delim">*)</span></div></li><li id="type-t.redo_stack" class="def record field anchored"><a href="#type-t.redo_stack" class="anchor"></a><code><span><span class="keyword">mutable</span> redo_stack : <span><span>(string * int)</span> list</span>;</span></code></li><li id="type-t.cmdline" class="def record field anchored"><a href="#type-t.cmdline" class="anchor"></a><code><span><span class="keyword">mutable</span> cmdline : string;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Current command-line buffer (&quot;:&quot;-prefix excluded).</p><span class="comment-delim">*)</span></div></li><li id="type-t.cmdline_cursor" class="def record field anchored"><a href="#type-t.cmdline_cursor" class="anchor"></a><code><span><span class="keyword">mutable</span> cmdline_cursor : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Cursor position inside <code>cmdline</code>.</p><span class="comment-delim">*)</span></div></li><li id="type-t.active_fork" class="def record field anchored"><a href="#type-t.active_fork" class="anchor"></a><code><span><span class="keyword">mutable</span> active_fork : <span>string option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Currently running fork tool call-id, if any.</p><span class="comment-delim">*)</span></div></li><li id="type-t.fork_start_index" class="def record field anchored"><a href="#type-t.fork_start_index" class="anchor"></a><code><span><span class="keyword">mutable</span> fork_start_index : <span>int option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>History length when fork started.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-editor_mode"><a href="#type-editor_mode" class="anchor"></a><code><span><span class="keyword">and</span> editor_mode</span><span> = </span></code><ol><li id="type-editor_mode.Insert" class="def variant constructor anchored"><a href="#type-editor_mode.Insert" class="anchor"></a><code><span>| </span><span><span class="constructor">Insert</span></span></code></li><li id="type-editor_mode.Normal" class="def variant constructor anchored"><a href="#type-editor_mode.Normal" class="anchor"></a><code><span>| </span><span><span class="constructor">Normal</span></span></code></li><li id="type-editor_mode.Cmdline" class="def variant constructor anchored"><a href="#type-editor_mode.Cmdline" class="anchor"></a><code><span>| </span><span><span class="constructor">Cmdline</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-draft_mode"><a href="#type-draft_mode" class="anchor"></a><code><span><span class="keyword">and</span> draft_mode</span><span> = </span></code><ol><li id="type-draft_mode.Plain" class="def variant constructor anchored"><a href="#type-draft_mode.Plain" class="anchor"></a><code><span>| </span><span><span class="constructor">Plain</span></span></code></li><li id="type-draft_mode.Raw_xml" class="def variant constructor anchored"><a href="#type-draft_mode.Raw_xml" class="anchor"></a><code><span>| </span><span><span class="constructor">Raw_xml</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-redo_stack"><a href="#val-redo_stack" class="anchor"></a><code><span><span class="keyword">val</span> redo_stack : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string * int)</span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_redo_stack"><a href="#val-set_redo_stack" class="anchor"></a><code><span><span class="keyword">val</span> set_redo_stack : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(string * int)</span> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-undo_stack"><a href="#val-undo_stack" class="anchor"></a><code><span><span class="keyword">val</span> undo_stack : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string * int)</span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_undo_stack"><a href="#val-set_undo_stack" class="anchor"></a><code><span><span class="keyword">val</span> set_undo_stack : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(string * int)</span> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-selected_msg"><a href="#val-selected_msg" class="anchor"></a><code><span><span class="keyword">val</span> selected_msg : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_selected_msg"><a href="#val-set_selected_msg" class="anchor"></a><code><span><span class="keyword">val</span> set_selected_msg : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>int option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-draft_mode"><a href="#val-draft_mode" class="anchor"></a><code><span><span class="keyword">val</span> draft_mode : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-draft_mode">draft_mode</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mode"><a href="#val-mode" class="anchor"></a><code><span><span class="keyword">val</span> mode : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-editor_mode">editor_mode</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_mode"><a href="#val-set_mode" class="anchor"></a><code><span><span class="keyword">val</span> set_mode : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-editor_mode">editor_mode</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_cursor_pos"><a href="#val-set_cursor_pos" class="anchor"></a><code><span><span class="keyword">val</span> set_cursor_pos : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-scroll_box"><a href="#val-scroll_box" class="anchor"></a><code><span><span class="keyword">val</span> scroll_box : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Notty_scroll_box/index.html#type-t">Notty_scroll_box.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fetch_sw"><a href="#val-fetch_sw" class="anchor"></a><code><span><span class="keyword">val</span> fetch_sw : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Eio</span>.Switch.t option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_fetch_sw"><a href="#val-set_fetch_sw" class="anchor"></a><code><span><span class="keyword">val</span> set_fetch_sw : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="xref-unresolved">Eio</span>.Switch.t option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_tasks"><a href="#val-set_tasks" class="anchor"></a><code><span><span class="keyword">val</span> set_tasks : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../Session/Task/index.html#type-t">Session.Task.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reasoning_idx_by_id"><a href="#val-reasoning_idx_by_id" class="anchor"></a><code><span><span class="keyword">val</span> reasoning_idx_by_id : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string, <span>int <span class="xref-unresolved">Stdlib</span>.ref</span>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-function_name_by_id"><a href="#val-function_name_by_id" class="anchor"></a><code><span><span class="keyword">val</span> function_name_by_id : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-msg_buffers"><a href="#val-msg_buffers" class="anchor"></a><code><span><span class="keyword">val</span> msg_buffers : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string, <a href="../Types/index.html#type-msg_buffer">Types.msg_buffer</a>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_auto_follow"><a href="#val-set_auto_follow" class="anchor"></a><code><span><span class="keyword">val</span> set_auto_follow : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_input_line"><a href="#val-set_input_line" class="anchor"></a><code><span><span class="keyword">val</span> set_input_line : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_messages"><a href="#val-set_messages" class="anchor"></a><code><span><span class="keyword">val</span> set_messages : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../Types/index.html#type-message">Types.message</a> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-history_items"><a href="#val-history_items" class="anchor"></a><code><span><span class="keyword">val</span> history_items : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_history_items"><a href="#val-set_history_items" class="anchor"></a><code><span><span class="keyword">val</span> set_history_items : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><p>Editor-mode of the input area.</p><p>‚Ä¢ <code>Insert</code> ‚Äì default; printable keys modify <a href="#val-input_line"><code>input_line</code></a> and move the cursor. ‚Ä¢ <code>Normal</code> ‚Äì Vim-style command mode. Keystrokes operate on messages or selections instead of inserting characters. ‚Ä¢ <code>Cmdline</code> ‚Äì a ':' prompt is active at the bottom. The content is kept in <a href="#val-cmdline"><code>cmdline</code></a> / <a href="#val-cmdline_cursor"><code>cmdline_cursor</code></a>. Leaving the prompt returns to <code>Insert</code>.</p><p>Draft representation of the <i>scratch</i> buffer that will be sent to the assistant next.</p><p>‚Ä¢ <code>Plain</code> ‚Äì regular markdown that goes straight to the OpenAI API. ‚Ä¢ <code>Raw_xml</code> ‚Äì low-level XML encoded function call. This mode is used by the command palette to prepare structured tool invocations.</p><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="label">history_items</span>:<span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">messages</span>:<span><a href="../Types/index.html#type-message">Types.message</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">input_line</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">auto_follow</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">msg_buffers</span>:<span><span>(string, <a href="../Types/index.html#type-msg_buffer">Types.msg_buffer</a>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">function_name_by_id</span>:<span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">reasoning_idx_by_id</span>:<span><span>(string, <span>int <span class="xref-unresolved">Stdlib</span>.ref</span>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">tasks</span>:<span><a href="../../Session/Task/index.html#type-t">Session.Task.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">kv_store</span>:<span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">fetch_sw</span>:<span><span class="xref-unresolved">Eio</span>.Switch.t option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">scroll_box</span>:<a href="../../Notty_scroll_box/index.html#type-t">Notty_scroll_box.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cursor_pos</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">selection_anchor</span>:<span>int option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">mode</span>:<a href="#type-editor_mode">editor_mode</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">draft_mode</span>:<a href="#type-draft_mode">draft_mode</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">selected_msg</span>:<span>int option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">undo_stack</span>:<span><span>(string * int)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">redo_stack</span>:<span><span>(string * int)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cmdline</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cmdline_cursor</span>:int <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ‚Ä¶</code> bundles the many independent references that make up the current application state into a single record. The constructor is deliberately <em>shallow</em>: it stores the arguments <i>as-is</i> without copying or validating them so mutating the original reference later still affects the model.</p><p>The function is expected to disappear once the codebase migrates to an immutable model.</p></div></div><p>Convenience accessors ‚Äì added on demand.</p><div class="odoc-spec"><div class="spec value anchored" id="val-input_line"><a href="#val-input_line" class="anchor"></a><code><span><span class="keyword">val</span> input_line : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>input_line t</code> returns the editable contents of the prompt at the bottom of the screen. The value is never <code>\n</code>-terminated.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cursor_pos"><a href="#val-cursor_pos" class="anchor"></a><code><span><span class="keyword">val</span> cursor_pos : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>cursor_pos t</code> is the <em>byte</em> index of the caret inside <a href="#val-input_line"><code>input_line</code></a>. The value is always between <code>0</code> and <code>String.length (input_line t)</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-selection_anchor"><a href="#val-selection_anchor" class="anchor"></a><code><span><span class="keyword">val</span> selection_anchor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p>Position at which the current selection started, if any. <code>None</code> means no active selection.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear_selection"><a href="#val-clear_selection" class="anchor"></a><code><span><span class="keyword">val</span> clear_selection : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>clear_selection t</code> drops any active selection and resets <a href="#val-selection_anchor"><code>selection_anchor</code></a> to <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_selection_anchor"><a href="#val-set_selection_anchor" class="anchor"></a><code><span><span class="keyword">val</span> set_selection_anchor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_selection_anchor t p</code> marks byte‚Äêoffset <code>p</code> as the start of a text selection. Calling the function implicitly enables selection mode.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-selection_active"><a href="#val-selection_active" class="anchor"></a><code><span><span class="keyword">val</span> selection_active : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>selection_active t</code> is <code>true</code> when a selection anchor is set.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-messages"><a href="#val-messages" class="anchor"></a><code><span><span class="keyword">val</span> messages : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Types/index.html#type-message">Types.message</a> list</span></span></code></div><div class="spec-doc"><p><code>messages t</code> returns the list of renderable messages in top-down order. Each element is a <code>(role, text)</code> pair as defined in <a href="../Types/index.html#type-message"><code>Types.message</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-tasks"><a href="#val-tasks" class="anchor"></a><code><span><span class="keyword">val</span> tasks : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Session/Task/index.html#type-t">Session.Task.t</a> list</span></span></code></div><div class="spec-doc"><p>List of tasks currently associated with the session.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-kv_store"><a href="#val-kv_store" class="anchor"></a><code><span><span class="keyword">val</span> kv_store : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div><div class="spec-doc"><p>Key‚Äìvalue store for arbitrary plugin data.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-auto_follow"><a href="#val-auto_follow" class="anchor"></a><code><span><span class="keyword">val</span> auto_follow : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Auto-scroll flag. When <code>true</code> the view follows new incoming messages automatically; otherwise the scroll position stays unchanged.</p></div></div><h2 id="command-mode-helpers"><a href="#command-mode-helpers" class="anchor"></a>Command-mode helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-toggle_mode"><a href="#val-toggle_mode" class="anchor"></a><code><span><span class="keyword">val</span> toggle_mode : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>toggle_mode t</code> switches between <code>Insert</code> and <code>Normal</code>. Calling the function while in <code>Cmdline</code> also returns to <code>Insert</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_draft_mode"><a href="#val-set_draft_mode" class="anchor"></a><code><span><span class="keyword">val</span> set_draft_mode : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-draft_mode">draft_mode</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_draft_mode t m</code> sets the interpretation of the prompt to <code>m</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-select_message"><a href="#val-select_message" class="anchor"></a><code><span><span class="keyword">val</span> select_message : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>int option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>select_message t idx</code> marks message <code>idx</code> as the focussed item in normal mode. <code>None</code> clears the selection. The index is zero-based and refers to the list returned by <a href="#val-messages"><code>messages</code></a>.</p></div></div><h2 id="command-line-helpers"><a href="#command-line-helpers" class="anchor"></a>Command-line helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-cmdline"><a href="#val-cmdline" class="anchor"></a><code><span><span class="keyword">val</span> cmdline : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Current contents of the ':' command-line buffer (without the leading ':').</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cmdline_cursor"><a href="#val-cmdline_cursor" class="anchor"></a><code><span><span class="keyword">val</span> cmdline_cursor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>cmdline_cursor t</code> is the byte offset of the caret inside <a href="#val-cmdline"><code>cmdline</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_cmdline"><a href="#val-set_cmdline" class="anchor"></a><code><span><span class="keyword">val</span> set_cmdline : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Overwrites the command-line buffer.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_cmdline_cursor"><a href="#val-set_cmdline_cursor" class="anchor"></a><code><span><span class="keyword">val</span> set_cmdline_cursor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Moves the cursor inside the command-line buffer.</p></div></div><h2 id="fork-helpers"><a href="#fork-helpers" class="anchor"></a>Fork helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-active_fork"><a href="#val-active_fork" class="anchor"></a><code><span><span class="keyword">val</span> active_fork : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p>Identifier of a long-running <a href="../../Functions/index.html#val-fork"><code>Functions.fork</code></a> call that streams into the UI, or <code>None</code> if no fork is active.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_active_fork"><a href="#val-set_active_fork" class="anchor"></a><code><span><span class="keyword">val</span> set_active_fork : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>string option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Updates <a href="#val-active_fork"><code>active_fork</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fork_start_index"><a href="#val-fork_start_index" class="anchor"></a><code><span><span class="keyword">val</span> fork_start_index : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p>Index into the message list that marked the boundary when the current fork started. Used to highlight new assistant output.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_fork_start_index"><a href="#val-set_fork_start_index" class="anchor"></a><code><span><span class="keyword">val</span> set_fork_start_index : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>int option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Updates <a href="#val-fork_start_index"><code>fork_start_index</code></a>.</p></div></div><h2 id="undo-/-redo-helpers"><a href="#undo-/-redo-helpers" class="anchor"></a>Undo / Redo helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-push_undo"><a href="#val-push_undo" class="anchor"></a><code><span><span class="keyword">val</span> push_undo : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>push_undo t</code> stores the current <code>input_line</code> / <code>cursor_pos</code> pair at the top of the undo ring. Any redo history is cleared.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-undo"><a href="#val-undo" class="anchor"></a><code><span><span class="keyword">val</span> undo : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>undo t</code> reverts the most recent change to the prompt. Returns <code>true</code> when a state was restored, <code>false</code> if the stack was empty.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-redo"><a href="#val-redo" class="anchor"></a><code><span><span class="keyword">val</span> redo : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>redo t</code> reapplies the last undone change. Returns <code>true</code> on success.</p></div></div><h2 id="applying-patches"><a href="#applying-patches" class="anchor"></a>Applying patches</h2><p>Refactoring step 6 introduces a <em>patch</em> based update mechanism that abstracts over concrete mutations to the UI state. For the time being the implementation still performs inplace updates to the interior <code>ref</code> values ‚Äì later steps will turn <code>t</code> into an immutable record and rebuild a fresh value instead.</p><div class="odoc-spec"><div class="spec value anchored" id="val-apply_patch"><a href="#val-apply_patch" class="anchor"></a><code><span><span class="keyword">val</span> apply_patch : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Types/index.html#type-patch">Types.patch</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>apply_patch t p</code> executes the pure <a href="../Types/index.html#type-patch"><code>Types.patch</code></a> command <code>p</code> by mutating <code>t</code> in place and returns the same value for ergonomic piping.</p><p>Example ‚Äì append a streamed delta to an assistant message:</p><pre class="language-ocaml"><code>  let patch = Types.Append_text { id; role = &quot;assistant&quot;; text = &quot;‚Ä¶&quot; } in
  ignore (Model.apply_patch model patch)</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_patches"><a href="#val-apply_patches" class="anchor"></a><code><span><span class="keyword">val</span> apply_patches : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../Types/index.html#type-patch">Types.patch</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Folds <a href="#val-apply_patch"><code>apply_patch</code></a> over a list of commands.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_history_item"><a href="#val-add_history_item" class="anchor"></a><code><span><span class="keyword">val</span> add_history_item : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Appends a raw OpenAI history item to the canonical list and returns the (mutated) model. Unlike <code>Add_user_message</code> the helper bypasses any UI manipulation.</p></div></div></div></body></html>
