<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Model (ochat.Chat_tui.Model)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_tui</a> &#x00BB; Model</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_tui.Model</span></code></h1><p>Mutable snapshot of the TUI state.</p><p>The <a href="#"><code>Chat_tui.Model</code></a> module concentrates every piece of information that the Ochat terminal UI needs to render the current session and to react to user input. The record is still <b>mutable</b> because the refactor towards a pure Elm-style architecture (immutable model + explicit patches) is carried out incrementally. A future change will turn <code>t</code> into an immutable value that gets rebuilt by <a href="#val-apply_patch"><code>apply_patch</code></a> instead of modified in place.</p><p>Until then the module provides two things:</p><p>‚Ä¢ a thin constructor <a href="#val-create"><code>create</code></a> that packs pre-existing references into a single bundle so they can be passed around conveniently; and ‚Ä¢ a set of *helper* functions that encapsulate common mutations such as toggling Vim-style modes, pushing undo states or applying the high-level <a href="../Types/index.html#type-patch"><code>Types.patch</code></a> commands emitted by the controller.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#pages-and-page-local-renderer-state">Pages and page-local renderer state</a></li><li><a href="#command-mode-helpers">Command-mode helpers</a></li><li><a href="#command-line-helpers">Command-line helpers</a></li><li><a href="#fork-helpers">Fork helpers</a></li><li><a href="#undo-/-redo-helpers">Undo / Redo helpers</a></li><li><a href="#type-ahead-completion-helpers">Type-ahead completion helpers</a></li><li><a href="#applying-patches">Applying patches</a></li><li><a href="#rendering-cache-helpers">Rendering cache helpers</a></li></ul></nav></div><div class="odoc-content"><h2 id="pages-and-page-local-renderer-state"><a href="#pages-and-page-local-renderer-state" class="anchor"></a>Pages and page-local renderer state</h2><p>The full-screen UI is rendered as a <em>page</em> chosen by <a href="#val-active_page"><code>active_page</code></a>. Page-local renderer state (scroll boxes, selection, and render caches) is stored under <a href="#val-pages"><code>pages</code></a>. Today the only page is <a href="Page_id/index.html#type-t.Chat"><code>Page_id.t.Chat</code></a> with state <a href="Chat_page_state/index.html#type-t"><code>Chat_page_state.t</code></a> stored at <code>pages.chat</code>.</p><div class="odoc-spec"><div class="spec type anchored" id="type-msg_img_cache"><a href="#type-msg_img_cache" class="anchor"></a><code><span><span class="keyword">type</span> msg_img_cache</span><span> = </span><span>{</span></code><ol><li id="type-msg_img_cache.width" class="def record field anchored"><a href="#type-msg_img_cache.width" class="anchor"></a><code><span>width : int;</span></code></li><li id="type-msg_img_cache.text" class="def record field anchored"><a href="#type-msg_img_cache.text" class="anchor"></a><code><span>text : string;</span></code></li><li id="type-msg_img_cache.img_unselected" class="def record field anchored"><a href="#type-msg_img_cache.img_unselected" class="anchor"></a><code><span>img_unselected : <span class="xref-unresolved">Notty</span>.I.t;</span></code></li><li id="type-msg_img_cache.height_unselected" class="def record field anchored"><a href="#type-msg_img_cache.height_unselected" class="anchor"></a><code><span>height_unselected : int;</span></code></li><li id="type-msg_img_cache.img_selected" class="def record field anchored"><a href="#type-msg_img_cache.img_selected" class="anchor"></a><code><span>img_selected : <span><span class="xref-unresolved">Notty</span>.I.t option</span>;</span></code></li><li id="type-msg_img_cache.height_selected" class="def record field anchored"><a href="#type-msg_img_cache.height_selected" class="anchor"></a><code><span>height_selected : <span>int option</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Cached render for a single history message at a fixed history-pane width.</p><p>The record stores the original <code>text</code> together with pre-rendered <code>Notty.I.t</code> images for unselected and (optionally) selected states, plus their heights in terminal cells. Selected images are constructed lazily on first use.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Page_id"><a href="#module-Page_id" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Page_id/index.html">Page_id</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Chat_page_state"><a href="#module-Chat_page_state" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Chat_page_state/index.html">Chat_page_state</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Pages"><a href="#module-Pages" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Pages/index.html">Pages</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-typeahead_completion"><a href="#type-typeahead_completion" class="anchor"></a><code><span><span class="keyword">type</span> typeahead_completion</span><span> = </span><span>{</span></code><ol><li id="type-typeahead_completion.text" class="def record field anchored"><a href="#type-typeahead_completion.text" class="anchor"></a><code><span>text : string;</span></code></li><li id="type-typeahead_completion.base_input" class="def record field anchored"><a href="#type-typeahead_completion.base_input" class="anchor"></a><code><span>base_input : string;</span></code></li><li id="type-typeahead_completion.base_cursor" class="def record field anchored"><a href="#type-typeahead_completion.base_cursor" class="anchor"></a><code><span>base_cursor : int;</span></code></li><li id="type-typeahead_completion.generation" class="def record field anchored"><a href="#type-typeahead_completion.generation" class="anchor"></a><code><span>generation : int;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Type-ahead completion state</p><p>A type-ahead completion is a single candidate suffix computed for the current prompt. The completion is never merged into <a href="#val-input_line"><code>input_line</code></a> unless explicitly accepted by the controller.</p><p>The <code>base_*</code> fields snapshot the prompt state at computation time; they are used to detect whether a completion is still applicable after further edits/movement.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = </span><span>{</span></code><ol><li id="type-t.history_items" class="def record field anchored"><a href="#type-t.history_items" class="anchor"></a><code><span><span class="keyword">mutable</span> history_items : <span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> list</span>;</span></code></li><li id="type-t.messages" class="def record field anchored"><a href="#type-t.messages" class="anchor"></a><code><span><span class="keyword">mutable</span> messages : <span><a href="../Types/index.html#type-message">Types.message</a> list</span>;</span></code></li><li id="type-t.input_line" class="def record field anchored"><a href="#type-t.input_line" class="anchor"></a><code><span><span class="keyword">mutable</span> input_line : string;</span></code></li><li id="type-t.auto_follow" class="def record field anchored"><a href="#type-t.auto_follow" class="anchor"></a><code><span><span class="keyword">mutable</span> auto_follow : bool;</span></code></li><li id="type-t.msg_buffers" class="def record field anchored"><a href="#type-t.msg_buffers" class="anchor"></a><code><span>msg_buffers : <span><span>(string, <a href="../Types/index.html#type-msg_buffer">Types.msg_buffer</a>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.function_name_by_id" class="def record field anchored"><a href="#type-t.function_name_by_id" class="anchor"></a><code><span>function_name_by_id : <span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.reasoning_idx_by_id" class="def record field anchored"><a href="#type-t.reasoning_idx_by_id" class="anchor"></a><code><span>reasoning_idx_by_id : <span><span>(string, <span>int <span class="xref-unresolved">Stdlib</span>.ref</span>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.tool_output_by_index" class="def record field anchored"><a href="#type-t.tool_output_by_index" class="anchor"></a><code><span>tool_output_by_index : <span><span>(int, <a href="../Types/index.html#type-tool_output_kind">Types.tool_output_kind</a>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.call_id_by_item_id" class="def record field anchored"><a href="#type-t.call_id_by_item_id" class="anchor"></a><code><span>call_id_by_item_id : <span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.tool_path_by_call_id" class="def record field anchored"><a href="#type-t.tool_path_by_call_id" class="anchor"></a><code><span>tool_path_by_call_id : <span><span>(string, <span>string option</span>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.active_page" class="def record field anchored"><a href="#type-t.active_page" class="anchor"></a><code><span><span class="keyword">mutable</span> active_page : <a href="Page_id/index.html#type-t">Page_id.t</a>;</span></code></li><li id="type-t.pages" class="def record field anchored"><a href="#type-t.pages" class="anchor"></a><code><span>pages : <a href="Pages/index.html#type-t">Pages.t</a>;</span></code></li><li id="type-t.tasks" class="def record field anchored"><a href="#type-t.tasks" class="anchor"></a><code><span><span class="keyword">mutable</span> tasks : <span><a href="../../Session/Task/index.html#type-t">Session.Task.t</a> list</span>;</span></code></li><li id="type-t.kv_store" class="def record field anchored"><a href="#type-t.kv_store" class="anchor"></a><code><span>kv_store : <span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span>;</span></code></li><li id="type-t.fetch_sw" class="def record field anchored"><a href="#type-t.fetch_sw" class="anchor"></a><code><span><span class="keyword">mutable</span> fetch_sw : <span><span class="xref-unresolved">Eio</span>.Switch.t option</span>;</span></code></li><li id="type-t.cursor_pos" class="def record field anchored"><a href="#type-t.cursor_pos" class="anchor"></a><code><span><span class="keyword">mutable</span> cursor_pos : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Current position inside <code>input_line</code> (bytes).</p><span class="comment-delim">*)</span></div></li><li id="type-t.selection_anchor" class="def record field anchored"><a href="#type-t.selection_anchor" class="anchor"></a><code><span><span class="keyword">mutable</span> selection_anchor : <span>int option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Anchor position for active selection.</p><span class="comment-delim">*)</span></div></li><li id="type-t.mode" class="def record field anchored"><a href="#type-t.mode" class="anchor"></a><code><span><span class="keyword">mutable</span> mode : <a href="#type-editor_mode">editor_mode</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Current editor mode (Insert/Normal).</p><span class="comment-delim">*)</span></div></li><li id="type-t.draft_mode" class="def record field anchored"><a href="#type-t.draft_mode" class="anchor"></a><code><span><span class="keyword">mutable</span> draft_mode : <a href="#type-draft_mode">draft_mode</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Whether the draft buffer is plain text or raw XML.</p><span class="comment-delim">*)</span></div></li><li id="type-t.undo_stack" class="def record field anchored"><a href="#type-t.undo_stack" class="anchor"></a><code><span><span class="keyword">mutable</span> undo_stack : <span><span>(string * int)</span> list</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Undo ring ‚Äì previous states (line, cursor)</p><span class="comment-delim">*)</span></div></li><li id="type-t.redo_stack" class="def record field anchored"><a href="#type-t.redo_stack" class="anchor"></a><code><span><span class="keyword">mutable</span> redo_stack : <span><span>(string * int)</span> list</span>;</span></code></li><li id="type-t.cmdline" class="def record field anchored"><a href="#type-t.cmdline" class="anchor"></a><code><span><span class="keyword">mutable</span> cmdline : string;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Current command-line buffer (&quot;:&quot;-prefix excluded).</p><span class="comment-delim">*)</span></div></li><li id="type-t.cmdline_cursor" class="def record field anchored"><a href="#type-t.cmdline_cursor" class="anchor"></a><code><span><span class="keyword">mutable</span> cmdline_cursor : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Cursor position inside <code>cmdline</code>.</p><span class="comment-delim">*)</span></div></li><li id="type-t.active_fork" class="def record field anchored"><a href="#type-t.active_fork" class="anchor"></a><code><span><span class="keyword">mutable</span> active_fork : <span>string option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Currently running fork tool call-id, if any.</p><span class="comment-delim">*)</span></div></li><li id="type-t.fork_start_index" class="def record field anchored"><a href="#type-t.fork_start_index" class="anchor"></a><code><span><span class="keyword">mutable</span> fork_start_index : <span>int option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>History length when fork started.</p><span class="comment-delim">*)</span></div></li><li id="type-t.typeahead_completion" class="def record field anchored"><a href="#type-t.typeahead_completion" class="anchor"></a><code><span><span class="keyword">mutable</span> typeahead_completion : <span><a href="#type-typeahead_completion">typeahead_completion</a> option</span>;</span></code></li><li id="type-t.typeahead_preview_open" class="def record field anchored"><a href="#type-t.typeahead_preview_open" class="anchor"></a><code><span><span class="keyword">mutable</span> typeahead_preview_open : bool;</span></code></li><li id="type-t.typeahead_preview_scroll" class="def record field anchored"><a href="#type-t.typeahead_preview_scroll" class="anchor"></a><code><span><span class="keyword">mutable</span> typeahead_preview_scroll : int;</span></code></li><li id="type-t.typeahead_generation" class="def record field anchored"><a href="#type-t.typeahead_generation" class="anchor"></a><code><span><span class="keyword">mutable</span> typeahead_generation : int;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-editor_mode"><a href="#type-editor_mode" class="anchor"></a><code><span><span class="keyword">and</span> editor_mode</span><span> = </span></code><ol><li id="type-editor_mode.Insert" class="def variant constructor anchored"><a href="#type-editor_mode.Insert" class="anchor"></a><code><span>| </span><span><span class="constructor">Insert</span></span></code></li><li id="type-editor_mode.Normal" class="def variant constructor anchored"><a href="#type-editor_mode.Normal" class="anchor"></a><code><span>| </span><span><span class="constructor">Normal</span></span></code></li><li id="type-editor_mode.Cmdline" class="def variant constructor anchored"><a href="#type-editor_mode.Cmdline" class="anchor"></a><code><span>| </span><span><span class="constructor">Cmdline</span></span></code></li></ol></div><div class="spec-doc"><p>Editor-mode of the input area.</p><p>‚Ä¢ <code>Insert</code> ‚Äì default; printable keys modify <a href="#val-input_line"><code>input_line</code></a> and move the cursor. ‚Ä¢ <code>Normal</code> ‚Äì Vim-style command mode. Keystrokes operate on messages or selections instead of inserting characters. ‚Ä¢ <code>Cmdline</code> ‚Äì a ':' prompt is active at the bottom. The content is kept in <a href="#val-cmdline"><code>cmdline</code></a> / <a href="#val-cmdline_cursor"><code>cmdline_cursor</code></a>. Leaving the prompt returns to <code>Insert</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-draft_mode"><a href="#type-draft_mode" class="anchor"></a><code><span><span class="keyword">and</span> draft_mode</span><span> = </span></code><ol><li id="type-draft_mode.Plain" class="def variant constructor anchored"><a href="#type-draft_mode.Plain" class="anchor"></a><code><span>| </span><span><span class="constructor">Plain</span></span></code></li><li id="type-draft_mode.Raw_xml" class="def variant constructor anchored"><a href="#type-draft_mode.Raw_xml" class="anchor"></a><code><span>| </span><span><span class="constructor">Raw_xml</span></span></code></li></ol></div><div class="spec-doc"><p>Draft representation of the <i>scratch</i> buffer that will be sent to the assistant next.</p><p>‚Ä¢ <code>Plain</code> ‚Äì regular markdown that goes straight to the OpenAI API. ‚Ä¢ <code>Raw_xml</code> ‚Äì low-level XML encoded function call. This mode is used by the command palette to prepare structured tool invocations.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-typeahead_generation"><a href="#val-typeahead_generation" class="anchor"></a><code><span><span class="keyword">val</span> typeahead_generation : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_typeahead_generation"><a href="#val-set_typeahead_generation" class="anchor"></a><code><span><span class="keyword">val</span> set_typeahead_generation : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-redo_stack"><a href="#val-redo_stack" class="anchor"></a><code><span><span class="keyword">val</span> redo_stack : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string * int)</span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_redo_stack"><a href="#val-set_redo_stack" class="anchor"></a><code><span><span class="keyword">val</span> set_redo_stack : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(string * int)</span> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-undo_stack"><a href="#val-undo_stack" class="anchor"></a><code><span><span class="keyword">val</span> undo_stack : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string * int)</span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_undo_stack"><a href="#val-set_undo_stack" class="anchor"></a><code><span><span class="keyword">val</span> set_undo_stack : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(string * int)</span> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-draft_mode"><a href="#val-draft_mode" class="anchor"></a><code><span><span class="keyword">val</span> draft_mode : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-draft_mode">draft_mode</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mode"><a href="#val-mode" class="anchor"></a><code><span><span class="keyword">val</span> mode : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-editor_mode">editor_mode</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_mode"><a href="#val-set_mode" class="anchor"></a><code><span><span class="keyword">val</span> set_mode : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-editor_mode">editor_mode</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_cursor_pos"><a href="#val-set_cursor_pos" class="anchor"></a><code><span><span class="keyword">val</span> set_cursor_pos : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fetch_sw"><a href="#val-fetch_sw" class="anchor"></a><code><span><span class="keyword">val</span> fetch_sw : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Eio</span>.Switch.t option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_fetch_sw"><a href="#val-set_fetch_sw" class="anchor"></a><code><span><span class="keyword">val</span> set_fetch_sw : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="xref-unresolved">Eio</span>.Switch.t option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_tasks"><a href="#val-set_tasks" class="anchor"></a><code><span><span class="keyword">val</span> set_tasks : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../Session/Task/index.html#type-t">Session.Task.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pages"><a href="#val-pages" class="anchor"></a><code><span><span class="keyword">val</span> pages : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="Pages/index.html#type-t">Pages.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-tool_path_by_call_id"><a href="#val-tool_path_by_call_id" class="anchor"></a><code><span><span class="keyword">val</span> tool_path_by_call_id : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string, <span>string option</span>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-call_id_by_item_id"><a href="#val-call_id_by_item_id" class="anchor"></a><code><span><span class="keyword">val</span> call_id_by_item_id : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reasoning_idx_by_id"><a href="#val-reasoning_idx_by_id" class="anchor"></a><code><span><span class="keyword">val</span> reasoning_idx_by_id : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string, <span>int <span class="xref-unresolved">Stdlib</span>.ref</span>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-function_name_by_id"><a href="#val-function_name_by_id" class="anchor"></a><code><span><span class="keyword">val</span> function_name_by_id : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-msg_buffers"><a href="#val-msg_buffers" class="anchor"></a><code><span><span class="keyword">val</span> msg_buffers : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string, <a href="../Types/index.html#type-msg_buffer">Types.msg_buffer</a>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_auto_follow"><a href="#val-set_auto_follow" class="anchor"></a><code><span><span class="keyword">val</span> set_auto_follow : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_input_line"><a href="#val-set_input_line" class="anchor"></a><code><span><span class="keyword">val</span> set_input_line : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_messages"><a href="#val-set_messages" class="anchor"></a><code><span><span class="keyword">val</span> set_messages : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../Types/index.html#type-message">Types.message</a> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-history_items"><a href="#val-history_items" class="anchor"></a><code><span><span class="keyword">val</span> history_items : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_history_items"><a href="#val-set_history_items" class="anchor"></a><code><span><span class="keyword">val</span> set_history_items : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="label">history_items</span>:<span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">messages</span>:<span><a href="../Types/index.html#type-message">Types.message</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">input_line</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">auto_follow</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">msg_buffers</span>:<span><span>(string, <a href="../Types/index.html#type-msg_buffer">Types.msg_buffer</a>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">function_name_by_id</span>:<span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">reasoning_idx_by_id</span>:<span><span>(string, <span>int <span class="xref-unresolved">Stdlib</span>.ref</span>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">tool_output_by_index</span>:<span><span>(int, <a href="../Types/index.html#type-tool_output_kind">Types.tool_output_kind</a>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">tasks</span>:<span><a href="../../Session/Task/index.html#type-t">Session.Task.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">kv_store</span>:<span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">fetch_sw</span>:<span><span class="xref-unresolved">Eio</span>.Switch.t option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">scroll_box</span>:<a href="../../Notty_scroll_box/index.html#type-t">Notty_scroll_box.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cursor_pos</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">selection_anchor</span>:<span>int option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">mode</span>:<a href="#type-editor_mode">editor_mode</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">draft_mode</span>:<a href="#type-draft_mode">draft_mode</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">selected_msg</span>:<span>int option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">undo_stack</span>:<span><span>(string * int)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">redo_stack</span>:<span><span>(string * int)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cmdline</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cmdline_cursor</span>:int <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ‚Ä¶</code> bundles the many independent references that make up the current application state into a single record. The constructor is deliberately <em>shallow</em>: it stores the arguments <i>as-is</i> without copying or validating them so mutating the original reference later still affects the model.</p><p>The function is expected to disappear once the codebase migrates to an immutable model.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">history_items</span> <p>Raw OpenAI history items (canonical source of truth).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">messages</span> <p>Renderable transcript derived from <code>history_items</code>.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">input_line</span> <p>Current insert buffer (without trailing newline).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">auto_follow</span> <p>Auto-scroll flag for the history viewport.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">msg_buffers</span> <p>Per-stream buffers keyed by OpenAI stream id.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">function_name_by_id</span> <p>Tool/function name by call id for streaming.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">reasoning_idx_by_id</span> <p>Per-call reasoning token counters (streaming).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">tool_output_by_index</span> <p>Classification metadata for tool outputs keyed by message index.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">tasks</span> <p>Session task list.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">kv_store</span> <p>Mutable key/value store for ad-hoc metadata.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">fetch_sw</span> <p>Optional switch used to cancel in-flight background fetches.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">scroll_box</span> <p>Scroll box backing the history viewport.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">cursor_pos</span> <p>Byte offset of the caret inside <code>input_line</code> (or the active buffer).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">selection_anchor</span> <p>Optional selection anchor (byte offset).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">mode</span> <p>Current editor mode.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">draft_mode</span> <p>Current draft-mode flag (Plain vs Raw XML).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">selected_msg</span> <p>Optional selected message index (Normal mode).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">undo_stack</span> <p>Undo history (line, cursor) pairs.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">redo_stack</span> <p>Redo history (line, cursor) pairs.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">cmdline</span> <p>Command-line buffer (without the leading ':').</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">cmdline_cursor</span> <p>Cursor position inside <code>cmdline</code> (byte offset).</p></li></ul></div></div><p>Convenience accessors ‚Äì added on demand.</p><div class="odoc-spec"><div class="spec value anchored" id="val-active_page"><a href="#val-active_page" class="anchor"></a><code><span><span class="keyword">val</span> active_page : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="Page_id/index.html#type-t">Page_id.t</a></span></code></div><div class="spec-doc"><p><code>active_page t</code> indicates which full-screen page is currently shown. Initially this is always <a href="Page_id/index.html#type-t.Chat"><code>Page_id.t.Chat</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_active_page"><a href="#val-set_active_page" class="anchor"></a><code><span><span class="keyword">val</span> set_active_page : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="Page_id/index.html#type-t">Page_id.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_active_page t page</code> changes the active page.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-chat_page"><a href="#val-chat_page" class="anchor"></a><code><span><span class="keyword">val</span> chat_page : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="Chat_page_state/index.html#type-t">Chat_page_state.t</a></span></code></div><div class="spec-doc"><p><code>chat_page t</code> returns the chat page's renderer state/caches. This is the authoritative location for chat-only scroll state and render caches.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-scroll_box"><a href="#val-scroll_box" class="anchor"></a><code><span><span class="keyword">val</span> scroll_box : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Notty_scroll_box/index.html#type-t">Notty_scroll_box.t</a></span></code></div><div class="spec-doc"><p><code>scroll_box t</code> is the chat page's scroll box used by history virtualisation and scrolling commands.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-selected_msg"><a href="#val-selected_msg" class="anchor"></a><code><span><span class="keyword">val</span> selected_msg : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p><code>selected_msg t</code> is the currently selected message (Normal mode), if any. The index is zero-based and refers to the list returned by <a href="#val-messages"><code>messages</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-input_line"><a href="#val-input_line" class="anchor"></a><code><span><span class="keyword">val</span> input_line : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>input_line t</code> returns the editable contents of the prompt at the bottom of the screen. The value is never <code>\n</code>-terminated.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cursor_pos"><a href="#val-cursor_pos" class="anchor"></a><code><span><span class="keyword">val</span> cursor_pos : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>cursor_pos t</code> is the <em>byte</em> index of the caret inside <a href="#val-input_line"><code>input_line</code></a>. The value is always between <code>0</code> and <code>String.length (input_line t)</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-selection_anchor"><a href="#val-selection_anchor" class="anchor"></a><code><span><span class="keyword">val</span> selection_anchor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p><code>selection_anchor t</code> is the position at which the current selection started, if any. <code>None</code> means no active selection.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear_selection"><a href="#val-clear_selection" class="anchor"></a><code><span><span class="keyword">val</span> clear_selection : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>clear_selection t</code> drops any active selection and resets <a href="#val-selection_anchor"><code>selection_anchor</code></a> to <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_selection_anchor"><a href="#val-set_selection_anchor" class="anchor"></a><code><span><span class="keyword">val</span> set_selection_anchor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_selection_anchor t p</code> marks byte‚Äêoffset <code>p</code> as the start of a text selection. Calling the function implicitly enables selection mode.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-selection_active"><a href="#val-selection_active" class="anchor"></a><code><span><span class="keyword">val</span> selection_active : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>selection_active t</code> is <code>true</code> when a selection anchor is set.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-messages"><a href="#val-messages" class="anchor"></a><code><span><span class="keyword">val</span> messages : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Types/index.html#type-message">Types.message</a> list</span></span></code></div><div class="spec-doc"><p><code>messages t</code> returns the list of renderable messages in top-down order. Each element is a <code>(role, text)</code> pair as defined in <a href="../Types/index.html#type-message"><code>Types.message</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-tasks"><a href="#val-tasks" class="anchor"></a><code><span><span class="keyword">val</span> tasks : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Session/Task/index.html#type-t">Session.Task.t</a> list</span></span></code></div><div class="spec-doc"><p><code>tasks t</code> returns the list of tasks currently associated with the session.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-kv_store"><a href="#val-kv_store" class="anchor"></a><code><span><span class="keyword">val</span> kv_store : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string, string)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div><div class="spec-doc"><p><code>kv_store t</code> returns the mutable key‚Äìvalue store used by plugins and tools to stash arbitrary metadata.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-tool_output_by_index"><a href="#val-tool_output_by_index" class="anchor"></a><code><span><span class="keyword">val</span> tool_output_by_index : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(int, <a href="../Types/index.html#type-tool_output_kind">Types.tool_output_kind</a>)</span> <span class="xref-unresolved">Base</span>.Hashtbl.t</span></span></code></div><div class="spec-doc"><p><code>tool_output_by_index t</code> returns classification metadata for tool-output messages keyed by message index in <a href="#val-messages"><code>messages</code></a>.</p><p>Entries are present only for messages whose <code>role</code> is tool-like and for which the TUI managed to infer the corresponding tool call; the stored values are <a href="../Types/index.html#type-tool_output_kind"><code>Types.tool_output_kind</code></a> tags that guide specialised rendering of built-in tools (for example, path-aware styling for <code>read_file</code>).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-auto_follow"><a href="#val-auto_follow" class="anchor"></a><code><span><span class="keyword">val</span> auto_follow : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>auto_follow t</code> is the auto-scroll flag. When <code>true</code> the view follows new incoming messages automatically; otherwise the scroll position stays unchanged.</p></div></div><h2 id="command-mode-helpers"><a href="#command-mode-helpers" class="anchor"></a>Command-mode helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-toggle_mode"><a href="#val-toggle_mode" class="anchor"></a><code><span><span class="keyword">val</span> toggle_mode : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>toggle_mode t</code> switches between <code>Insert</code> and <code>Normal</code>. Calling the function while in <code>Cmdline</code> also returns to <code>Insert</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_draft_mode"><a href="#val-set_draft_mode" class="anchor"></a><code><span><span class="keyword">val</span> set_draft_mode : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-draft_mode">draft_mode</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_draft_mode t m</code> sets the interpretation of the prompt to <code>m</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-select_message"><a href="#val-select_message" class="anchor"></a><code><span><span class="keyword">val</span> select_message : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>int option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>select_message t idx</code> marks message <code>idx</code> as the focussed item in normal mode. <code>None</code> clears the selection. The index is zero-based and refers to the list returned by <a href="#val-messages"><code>messages</code></a>.</p></div></div><h2 id="command-line-helpers"><a href="#command-line-helpers" class="anchor"></a>Command-line helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-cmdline"><a href="#val-cmdline" class="anchor"></a><code><span><span class="keyword">val</span> cmdline : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>cmdline t</code> returns the current contents of the ':' command-line buffer (without the leading ':').</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cmdline_cursor"><a href="#val-cmdline_cursor" class="anchor"></a><code><span><span class="keyword">val</span> cmdline_cursor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>cmdline_cursor t</code> is the byte offset of the caret inside <a href="#val-cmdline"><code>cmdline</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_cmdline"><a href="#val-set_cmdline" class="anchor"></a><code><span><span class="keyword">val</span> set_cmdline : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_cmdline t s</code> overwrites the ':' command-line buffer with <code>s</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_cmdline_cursor"><a href="#val-set_cmdline_cursor" class="anchor"></a><code><span><span class="keyword">val</span> set_cmdline_cursor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_cmdline_cursor t n</code> moves the cursor inside the ':' command-line buffer to byte offset <code>n</code>.</p></div></div><h2 id="fork-helpers"><a href="#fork-helpers" class="anchor"></a>Fork helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-active_fork"><a href="#val-active_fork" class="anchor"></a><code><span><span class="keyword">val</span> active_fork : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p><code>active_fork t</code> is the identifier of a long-running <a href="../../Functions/index.html#val-fork"><code>Functions.fork</code></a> call that streams into the UI, or <code>None</code> if no fork is active.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_active_fork"><a href="#val-set_active_fork" class="anchor"></a><code><span><span class="keyword">val</span> set_active_fork : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>string option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_active_fork t id</code> updates <a href="#val-active_fork"><code>active_fork</code></a> to <code>id</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fork_start_index"><a href="#val-fork_start_index" class="anchor"></a><code><span><span class="keyword">val</span> fork_start_index : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p><code>fork_start_index t</code> is the index into the message list that marked the boundary when the current fork started. Used to highlight new assistant output.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_fork_start_index"><a href="#val-set_fork_start_index" class="anchor"></a><code><span><span class="keyword">val</span> set_fork_start_index : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>int option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_fork_start_index t idx</code> updates <a href="#val-fork_start_index"><code>fork_start_index</code></a> to <code>idx</code>.</p></div></div><h2 id="undo-/-redo-helpers"><a href="#undo-/-redo-helpers" class="anchor"></a>Undo / Redo helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-push_undo"><a href="#val-push_undo" class="anchor"></a><code><span><span class="keyword">val</span> push_undo : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>push_undo t</code> stores the current <code>input_line</code> / <code>cursor_pos</code> pair at the top of the undo ring. Any redo history is cleared.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-undo"><a href="#val-undo" class="anchor"></a><code><span><span class="keyword">val</span> undo : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>undo t</code> reverts the most recent change to the prompt. Returns <code>true</code> when a state was restored, <code>false</code> if the stack was empty.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-redo"><a href="#val-redo" class="anchor"></a><code><span><span class="keyword">val</span> redo : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>redo t</code> reapplies the last undone change. Returns <code>true</code> on success.</p></div></div><h2 id="type-ahead-completion-helpers"><a href="#type-ahead-completion-helpers" class="anchor"></a>Type-ahead completion helpers</h2><p>Type-ahead completion augments the prompt editor with a single-candidate suffix:</p><ul><li>the reducer triggers background requests (debounced after edits) and publishes results into <a href="#val-typeahead_completion"><code>typeahead_completion</code></a>;</li><li>the controller handles key bindings to accept/dismiss completions and to open/scroll/close the preview popup; and</li><li>the renderer shows a dim inline &quot;ghost&quot; suffix, optional hint text, and a preview overlay.</li></ul><p>Invariants:</p><ul><li>The completion must be a suffix to insert at <code>base_cursor</code> in <code>base_input</code>; it must not repeat the prefix before the cursor.</li><li>A completion is considered relevant only when <code>base_input</code> / <code>base_cursor</code> still match the current editor state (see <a href="#val-typeahead_is_relevant"><code>typeahead_is_relevant</code></a>).</li></ul><div class="odoc-spec"><div class="spec value anchored" id="val-typeahead_completion"><a href="#val-typeahead_completion" class="anchor"></a><code><span><span class="keyword">val</span> typeahead_completion : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-typeahead_completion">typeahead_completion</a> option</span></span></code></div><div class="spec-doc"><p><code>typeahead_completion t</code> is the current inline completion candidate, if any.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_typeahead_completion"><a href="#val-set_typeahead_completion" class="anchor"></a><code><span><span class="keyword">val</span> set_typeahead_completion : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-typeahead_completion">typeahead_completion</a> option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_typeahead_completion t c</code> overwrites the current completion candidate.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear_typeahead"><a href="#val-clear_typeahead" class="anchor"></a><code><span><span class="keyword">val</span> clear_typeahead : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>clear_typeahead t</code> drops the completion candidate and resets preview state.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-typeahead_preview_open"><a href="#val-typeahead_preview_open" class="anchor"></a><code><span><span class="keyword">val</span> typeahead_preview_open : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>typeahead_preview_open t</code> is <code>true</code> when the preview popup should be shown.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_typeahead_preview_open"><a href="#val-set_typeahead_preview_open" class="anchor"></a><code><span><span class="keyword">val</span> set_typeahead_preview_open : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_typeahead_preview_open t b</code> opens/closes the preview popup.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-typeahead_preview_scroll"><a href="#val-typeahead_preview_scroll" class="anchor"></a><code><span><span class="keyword">val</span> typeahead_preview_scroll : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>typeahead_preview_scroll t</code> is the preview popup scroll offset (lines).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_typeahead_preview_scroll"><a href="#val-set_typeahead_preview_scroll" class="anchor"></a><code><span><span class="keyword">val</span> set_typeahead_preview_scroll : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_typeahead_preview_scroll t n</code> updates the preview scroll offset.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bump_typeahead_generation"><a href="#val-bump_typeahead_generation" class="anchor"></a><code><span><span class="keyword">val</span> bump_typeahead_generation : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>bump_typeahead_generation t</code> increments the generation counter and returns the updated value.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-typeahead_is_relevant"><a href="#val-typeahead_is_relevant" class="anchor"></a><code><span><span class="keyword">val</span> typeahead_is_relevant : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>typeahead_is_relevant t</code> is <code>true</code> iff:</p><ul><li>the editor mode is <code>Insert</code>, and</li><li>a completion exists, and</li><li>the completion's <code>base_input</code> and <code>base_cursor</code> still match the current <a href="#val-input_line"><code>input_line</code></a> / <a href="#val-cursor_pos"><code>cursor_pos</code></a>.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-accept_typeahead_all"><a href="#val-accept_typeahead_all" class="anchor"></a><code><span><span class="keyword">val</span> accept_typeahead_all : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>accept_typeahead_all t</code> inserts the current relevant completion at the cursor and clears the completion state.</p><p>Returns <code>true</code> if a completion was accepted, <code>false</code> otherwise.</p><p>The operation:</p><ul><li>sanitises the completion text with <a href="../Util/index.html#val-sanitize"><code>Util.sanitize</code></a> <code>[~strip:false]</code></li><li>calls <a href="#val-push_undo"><code>push_undo</code></a> exactly once</li><li>clears any active selection</li><li>inserts the completion at <a href="#val-cursor_pos"><code>cursor_pos</code></a> and advances the cursor</li><li>clears the completion and closes the preview</li><li>bumps the type-ahead generation counter</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-accept_typeahead_line"><a href="#val-accept_typeahead_line" class="anchor"></a><code><span><span class="keyword">val</span> accept_typeahead_line : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>accept_typeahead_line t</code> inserts the first line of the relevant completion at the cursor and keeps the remainder as a new completion (progressive accept).</p><p>Returns <code>true</code> if a completion was accepted, <code>false</code> otherwise.</p><p>The inserted segment is the prefix up to and including the first <code>'\n'</code> if present; otherwise the whole completion is inserted.</p><p>The operation calls <a href="#val-push_undo"><code>push_undo</code></a> exactly once, clears any active selection, closes the preview, and bumps the generation counter.</p></div></div><h2 id="applying-patches"><a href="#applying-patches" class="anchor"></a>Applying patches</h2><p>Refactoring step 6 introduces a <em>patch</em> based update mechanism that abstracts over concrete mutations to the UI state. For the time being the implementation still performs inplace updates to the interior <code>ref</code> values ‚Äì later steps will turn <code>t</code> into an immutable record and rebuild a fresh value instead.</p><div class="odoc-spec"><div class="spec value anchored" id="val-apply_patch"><a href="#val-apply_patch" class="anchor"></a><code><span><span class="keyword">val</span> apply_patch : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Types/index.html#type-patch">Types.patch</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>apply_patch t p</code> executes the pure <a href="../Types/index.html#type-patch"><code>Types.patch</code></a> command <code>p</code> by mutating <code>t</code> in place and returns the same value for ergonomic piping.</p><p>Example ‚Äì append a streamed delta to an assistant message:</p><pre class="language-ocaml"><code>  let patch = Types.Append_text { id; role = &quot;assistant&quot;; text = &quot;‚Ä¶&quot; } in
  ignore (Model.apply_patch model patch)</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_patches"><a href="#val-apply_patches" class="anchor"></a><code><span><span class="keyword">val</span> apply_patches : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../Types/index.html#type-patch">Types.patch</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Folds <a href="#val-apply_patch"><code>apply_patch</code></a> over a list of commands.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_history_item"><a href="#val-add_history_item" class="anchor"></a><code><span><span class="keyword">val</span> add_history_item : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>add_history_item t item</code> appends the raw OpenAI history <code>item</code> to the canonical list and returns the (mutated) model. Unlike the <code>Add_user_message</code> patch the helper bypasses any UI manipulation and does not touch <a href="#val-messages"><code>messages</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rebuild_tool_output_index"><a href="#val-rebuild_tool_output_index" class="anchor"></a><code><span><span class="keyword">val</span> rebuild_tool_output_index : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>rebuild_tool_output_index t</code> recomputes <a href="#val-tool_output_by_index"><code>tool_output_by_index</code></a> from the current <a href="#val-history_items"><code>history_items</code></a>.</p><p>The helper walks the OpenAI history, pairs each renderable item (as determined by <a href="../Conversation/index.html#val-pair_of_item"><code>Chat_tui.Conversation.pair_of_item</code></a>) with its message index in <a href="#val-messages"><code>messages</code></a>, and populates the map with <a href="../Types/index.html#type-tool_output_kind"><code>Types.tool_output_kind</code></a> values for corresponding <code>Function_call_output</code> entries.</p><p>Use this when the entire history is replaced at once (initial model construction, history compaction, or handling of a <code>`Replace_history</code> event). Streaming updates do not need this helper ‚Äì they classify tool outputs incrementally via the <code>Set_function_output</code> patch.</p></div></div><h2 id="rendering-cache-helpers"><a href="#rendering-cache-helpers" class="anchor"></a>Rendering cache helpers</h2><p>Low-level helpers for the renderer. Callers outside the rendering path should not need these.</p><div class="odoc-spec"><div class="spec value anchored" id="val-last_history_width"><a href="#val-last_history_width" class="anchor"></a><code><span><span class="keyword">val</span> last_history_width : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p><code>last_history_width t</code> is the width (in terminal cells) for which the chat page's cached message images and heights are currently valid, or <code>None</code> if no cache has been built yet.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_last_history_width"><a href="#val-set_last_history_width" class="anchor"></a><code><span><span class="keyword">val</span> set_last_history_width : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>int option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_last_history_width t w</code> updates <a href="#val-last_history_width"><code>last_history_width</code></a>. Calling the function does **not** invalidate individual entries ‚Äì that is done by the renderer which knows whether a global flush or targeted invalidations are cheaper.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear_all_img_caches"><a href="#val-clear_all_img_caches" class="anchor"></a><code><span><span class="keyword">val</span> clear_all_img_caches : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>clear_all_img_caches t</code> completely clears <a href="#type-msg_img_cache"><code>msg_img_cache</code></a> and the associated height caches. Use this when the terminal has been resized and *all* cached images are now stale.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-invalidate_img_cache_index"><a href="#val-invalidate_img_cache_index" class="anchor"></a><code><span><span class="keyword">val</span> invalidate_img_cache_index : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">idx</span>:int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>invalidate_img_cache_index t ~idx</code> removes the cache entry for the message at index <code>idx</code>. Called whenever the underlying text changes (e.g. when streaming deltas arrive).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_img_cache"><a href="#val-find_img_cache" class="anchor"></a><code><span><span class="keyword">val</span> find_img_cache : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">idx</span>:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-msg_img_cache">msg_img_cache</a> option</span></span></code></div><div class="spec-doc"><p><code>find_img_cache t ~idx</code> returns the cached render of the message at <code>idx</code> or <code>None</code> if no entry exists or the cache was invalidated.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_img_cache"><a href="#val-set_img_cache" class="anchor"></a><code><span><span class="keyword">val</span> set_img_cache : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">idx</span>:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-msg_img_cache">msg_img_cache</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_img_cache t ~idx entry</code> stores <code>entry</code> in the per-message cache. Existing data for the same index is overwritten.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-take_and_clear_dirty_height_indices"><a href="#val-take_and_clear_dirty_height_indices" class="anchor"></a><code><span><span class="keyword">val</span> take_and_clear_dirty_height_indices : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int list</span></span></code></div><div class="spec-doc"><p><code>take_and_clear_dirty_height_indices t</code> returns and clears the list of indices whose heights may be stale. The list may contain duplicates and is not guaranteed to be ordered.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-msg_heights"><a href="#val-msg_heights" class="anchor"></a><code><span><span class="keyword">val</span> msg_heights : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int array</span></span></code></div><div class="spec-doc"><p><code>msg_heights t</code> are the cached rendered heights (in cells) for the chat transcript at <a href="#val-last_history_width"><code>last_history_width</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_msg_heights"><a href="#val-set_msg_heights" class="anchor"></a><code><span><span class="keyword">val</span> set_msg_heights : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>int array</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_msg_heights t a</code> updates <a href="#val-msg_heights"><code>msg_heights</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-height_prefix"><a href="#val-height_prefix" class="anchor"></a><code><span><span class="keyword">val</span> height_prefix : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int array</span></span></code></div><div class="spec-doc"><p><code>height_prefix t</code> are prefix sums of <a href="#val-msg_heights"><code>msg_heights</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_height_prefix"><a href="#val-set_height_prefix" class="anchor"></a><code><span><span class="keyword">val</span> set_height_prefix : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>int array</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_height_prefix t a</code> updates <a href="#val-height_prefix"><code>height_prefix</code></a>.</p></div></div></div></body></html>
