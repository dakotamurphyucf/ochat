<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Controller_normal (ochat.Chat_tui.Controller_normal)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_tui</a> &#x00BB; Controller_normal</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_tui.Controller_normal</span></code></h1><p>Normal-mode key handling for the Ochat terminal UI.</p><p>The <a href="#"><code>Controller_normal</code></a> module implements the subset of the Vim-inspired key bindings that operate while the input area is in <em>Normal</em> editor mode. It receives raw <code>Notty.Unescape.event</code> values, mutates the in-memory <a href="../Model/index.html#type-t"><code>Chat_tui.Model.t</code></a> accordingly, and returns a <a href="../Controller_types/index.html#type-reaction"><code>Controller_types.reaction</code></a> telling the caller whether a screen refresh is required or additional action (e.g. <a href="../Controller_types/index.html#type-reaction.Submit_input"><code>Controller_types.reaction.Submit_input</code></a>) should be triggered.</p><p>The module has <b>no side-effects</b> besides changing the fields inside the mutable model ‚Äì network requests, file IO, or long-running function calls are all handled elsewhere. Keeping the logic pure makes unit testing easier and ensures that the controller focuses exclusively on user-interaction concerns such as cursor movement, scrolling and text editing.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#implementation-overview">Implementation overview</a></li></ul></nav></div><div class="odoc-content"><h2 id="implementation-overview"><a href="#implementation-overview" class="anchor"></a>Implementation overview</h2><p>‚Ä¢ High-level public API consists of a single entry point <a href="#val-handle_key_normal"><code>handle_key_normal</code></a> ‚Äì every other value is an implementation detail.</p><p>‚Ä¢ Helpers like <a href="#val-move_cursor_vertically"><code>move_cursor_vertically</code></a>, <a href="#val-skip_space_backward"><code>skip_space_backward</code></a> and <a href="#val-skip_word_forward"><code>skip_word_forward</code></a> encapsulate reusable cursor-navigation logic.</p><p>‚Ä¢ Two reference cells, <a href="#val-pending_g"><code>pending_g</code></a> and <a href="#val-pending_dd"><code>pending_dd</code></a>, keep track of multi-keystroke commands (&quot;gg&quot; and &quot;dd&quot;).</p><p>All byte indices refer to the UTF-8 encoded <a href="../Model/index.html#type-t.input_line"><code>Model.t.input_line</code></a>. The controller therefore treats the string as a raw byte sequence ‚Äì full Unicode support is postponed until a later milestone (see issue #142).</p><div class="odoc-spec"><div class="spec module anchored" id="module-UC"><a href="#module-UC" class="anchor"></a><code><span><span class="keyword">module</span> UC</span><span> = <span class="xref-unresolved">Stdlib</span>.Uchar</span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Scroll_box"><a href="#module-Scroll_box" class="anchor"></a><code><span><span class="keyword">module</span> Scroll_box</span><span> = <a href="../../Notty_scroll_box/index.html">Notty_scroll_box</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-move_cursor_vertically"><a href="#val-move_cursor_vertically" class="anchor"></a><code><span><span class="keyword">val</span> move_cursor_vertically : <span><a href="../Model/index.html#type-t">Model.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">dir</span>:int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>move_cursor_vertically model ~dir</code> moves the caret <code>dir</code> visual lines up (`dir = -1`) or down (`dir = 1`). The function keeps the <i>visual column</i> constant where possible, i.e.</p><ul><li>It first determines the current column by subtracting the byte index of the line start from <a href="../Model/index.html#type-t.cursor_pos"><code>Model.t.cursor_pos</code></a>.</li><li>It then seeks the first byte of the target line in the requested direction using <a href="../Controller_shared/index.html#val-line_bounds"><code>Controller_shared.line_bounds</code></a>.</li><li>Finally the caret is placed at the original column or, if the target line is shorter, at its end‚Äêof‚Äêline.</li></ul><p>The operation is no-op when the cursor is already on the first or last line of the input.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-skip_space_backward"><a href="#val-skip_space_backward" class="anchor"></a><code><span><span class="keyword">val</span> skip_space_backward : <span>string <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>skip_space_backward s j</code> returns the index of the first non-blank character to the <b>left</b> of <code>j</code>. Consecutive runs of whitespace are skipped first, followed by the preceding word. The helper mimics the behaviour of Vim's &quot;b&quot; command and is used by <a href="#val-handle_key_normal"><code>handle_key_normal</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-skip_word_forward"><a href="#val-skip_word_forward" class="anchor"></a><code><span><span class="keyword">val</span> skip_word_forward : <span>string <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>skip_word_forward s len j</code> returns the index after the next word to the <b>right</b> of <code>j</code> in <code>s</code>. Whitespace after the word is consumed as well so that the returned position corresponds to the first printable character of the following word (or <code>len</code> if at the end of the string). Implements the semantics of Vim's &quot;w&quot; motion.</p></div></div><p>State flags for multi-key commands.</p><p>‚Ä¢ <code>pending_g</code> ‚Äì set after receiving a solitary 'g'. A subsequent 'g' within the same <code>handle_key_normal</code> invocation triggers the &quot;gg&quot; motion (scroll to top). Any other key clears the flag.</p><p>‚Ä¢ <code>pending_dd</code> ‚Äì set after a single 'd'. A second 'd' performs a line deletion; anything else resets the flag.</p><div class="odoc-spec"><div class="spec value anchored" id="val-pending_g"><a href="#val-pending_g" class="anchor"></a><code><span><span class="keyword">val</span> pending_g : <span>bool <span class="xref-unresolved">Core</span>.ref</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pending_dd"><a href="#val-pending_dd" class="anchor"></a><code><span><span class="keyword">val</span> pending_dd : <span>bool <span class="xref-unresolved">Core</span>.ref</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-handle_key_normal"><a href="#val-handle_key_normal" class="anchor"></a><code><span><span class="keyword">val</span> handle_key_normal : 
  <span><span class="label">model</span>:<a href="../Model/index.html#type-t">Model.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">term</span>:<a href="../../Notty_eio/Term/index.html#type-t">Notty_eio.Term.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Notty</span>.Unescape.event <span class="arrow">&#45;&gt;</span></span>
  <a href="../Controller_types/index.html#type-reaction">Controller_types.reaction</a></span></code></div><div class="spec-doc"><p><code>handle_key_normal ~model ~term ev</code> processes the Normal-mode key event <code>ev</code> and mutates <code>model</code> accordingly.</p><p>The function recognises a small subset of common Vim commands that are useful inside a chat prompt ‚Äì cursor motions, word navigation, line editing commands, and scrolling. Whenever the resulting state change affects what is displayed on screen, the function returns <code>Redraw</code> so that the caller can re-render the UI. Some events need to propagate further to the main application (e.g. ':' opens command-line mode), which is signalled via other variants of <code>reaction</code>.</p><p>The exact mapping is intentionally kept minimal and intuitive rather than striving for full Vim parity ‚Äì more specialised or rarely used motions are left to future extensions.</p></div></div></div></body></html>
