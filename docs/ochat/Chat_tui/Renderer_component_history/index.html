<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Renderer_component_history (ochat.Chat_tui.Renderer_component_history)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_tui</a> &#x00BB; Renderer_component_history</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_tui.Renderer_component_history</span></code></h1><p>Virtualised history viewport renderer.</p><p>This module renders the scrollable transcript area of the chat page. It is ‚Äúvirtualised‚Äù in the sense that it only renders the messages that can intersect the current <code>height</code>-row viewport, while still returning an image whose <em>logical</em> height matches the full transcript. The caller can then feed the result to <a href="../../Notty_scroll_box/index.html#val-set_content"><code>Notty_scroll_box.set_content</code></a> and let <a href="../../Notty_scroll_box/index.html#val-render"><code>Notty_scroll_box.render</code></a> crop the visible window.</p><p>The implementation relies on (and mutates) renderer caches stored in <a href="../Model/Chat_page_state/index.html#type-t"><code>Chat_tui.Model.Chat_page_state.t</code></a>:</p><ul><li>a per-message image cache keyed by message index;</li><li>cached per-message heights and their prefix sums used to translate scroll offsets into visible indices.</li></ul><p>The module does <b>not</b> modify the scroll offset itself; it reads the current scroll position from <a href="../Model/index.html#val-scroll_box"><code>Chat_tui.Model.scroll_box</code></a>.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-render"><a href="#val-render" class="anchor"></a><code><span><span class="keyword">val</span> render : 
  <span><span class="label">model</span>:<a href="../Model/index.html#type-t">Model.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">width</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">height</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">messages</span>:<span><a href="../Types/index.html#type-message">Types.message</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">selected_idx</span>:<span>int option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">render_message</span>:<span>(<span><span class="label">idx</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span class="label">selected</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="../Types/index.html#type-message">Types.message</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Notty</span>.I.t)</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Notty</span>.I.t</span></code></div><div class="spec-doc"><p><code>render ~model ~width ~height ~messages ~selected_idx ~render_message</code> renders the transcript into a single image.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">model</span> <p>Mutable model holding caches and the current scroll position.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">width</span> <p>Target width in terminal cells. The returned image is <code>hsnap</code>-ed to this width.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">height</span> <p>Height of the scroll viewport in terminal cells.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">messages</span> <p>Transcript to render (top-to-bottom).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">selected_idx</span> <p>Zero-based index of the selected message (Normal mode), or <code>None</code> when nothing is selected.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">render_message</span> <p>Callback that renders one message. It is expected to produce an image sized for <code>width</code> (typically by <code>hsnap</code>-ing).</p></li></ul><p>The function updates the model's cached message images and height arrays. When <code>selected_idx</code> is set, the selected variant of the corresponding message is computed lazily and cached.</p><p>The returned image includes transparent padding above and below the visible block so that its logical height matches the full transcript height.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-top_visible_index"><a href="#val-top_visible_index" class="anchor"></a><code><span><span class="keyword">val</span> top_visible_index : 
  <span><span class="label">model</span>:<a href="../Model/index.html#type-t">Model.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">scroll_height</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">messages</span>:<span><a href="../Types/index.html#type-message">Types.message</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>int option</span></span></code></div><div class="spec-doc"><p><code>top_visible_index ~model ~scroll_height ~messages</code> returns the index of the first message whose <em>header</em> is sufficiently below the top of the visible scroll window.</p><p>The chat page uses this to implement a one-row ‚Äústicky‚Äù header: while the header of the first fully visible message is scrolled off-screen, the sticky header repeats it. When the real header is still visible in the top couple of rows, the function returns <code>None</code> to avoid duplicating the label.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">model</span> <p>Source of the current scroll offset (and cached heights).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">scroll_height</span> <p>Height of the scroll viewport, in terminal cells.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">messages</span> <p>Transcript to analyse.</p></li></ul><p>Returns <code>None</code> when <code>messages</code> is empty or when the cache arrays are missing/stale.</p></div></div></div></body></html>
