<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Controller (ochat.Chat_tui.Controller)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_tui</a> &#x00BB; Controller</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ğŸ” Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_tui.Controller</span></code></h1><p>Event controller for the Chat-TUI.</p><p><code>`Controller`</code> is the <b>single entry-point</b> that the main event loop uses to translate a raw <code>Notty.Unescape.event</code> into an in-memory mutation of the <a href="../Model/index.html#type-t"><code>Chat_tui.Model.t</code></a>. All logic in the file is <em>pure with respect to IO</em> â€“ it only edits the mutable record fields of the given <code>model</code> and returns a <a href="#type-reaction"><code>reaction</code></a> value that tells the caller what to do next.</p><p>Key maps are split into three sub-states that mirror Vim semantics:</p><p>â€¢ <b>Insert</b> â€“ free-form text editing (default) â€¢ <b>Normal</b> â€“ modal navigation &amp; message manipulation (see <a href="../Controller_normal/index.html"><code>Chat_tui.Controller_normal</code></a>) â€¢ <b>Cmdline</b> â€“ ':' command prompt (see <a href="../Controller_cmdline/index.html"><code>Chat_tui.Controller_cmdline</code></a>)</p><p><code>`Controller.handle_key`</code> is therefore a <em>dispatcher</em>: it selects a key-handler based on <code>model.mode</code> and forwards the event. Insert-mode is implemented locally in this compilation unit, whereas Normal- and Command-line modes live in their respective sub-modules.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#insert-mode-shortcuts">Insert-mode shortcuts</a></li><li><a href="#reactions">Reactions</a></li></ul></nav></div><div class="odoc-content"><h2 id="insert-mode-shortcuts"><a href="#insert-mode-shortcuts" class="anchor"></a>Insert-mode shortcuts</h2><p>The implementation provides a pragmatic subset of desktop-editor shortcuts. Selected examples:</p><ul><li>Arrow keys, <b>Home</b> / <b>End</b> â€“ caret movement</li><li>Meta+â†/â†’ or Ctrl+â†/â†’ â€“ word-wise movement</li><li>Ctrl-A / Ctrl-E â€“ beginning / end of line</li><li>Backspace â€“ delete previous character</li><li>Ctrl-K / Ctrl-U / Ctrl-W â€“ kill to EOL / BOL / previous word</li><li>Ctrl-Y â€“ yank the last killed text</li><li>Meta+Enter â€“ submit the current prompt (<code>Submit_input</code>)</li><li>PageUp / PageDown â€“ scroll conversation history</li><li>ESC â€“ cancel streaming or return to Normal mode</li></ul><p>The set of bindings is intentionally conservative; unsupported keys are returned as <a href="#type-reaction.Unhandled"><code>Unhandled</code></a> so that outer layers may implement fallbacks.</p><h2 id="reactions"><a href="#reactions" class="anchor"></a>Reactions</h2><p>All controller variants share the same <a href="#type-reaction"><code>reaction</code></a> type (defined in <a href="../Controller_types/index.html"><code>Chat_tui.Controller_types</code></a>):</p><pre class="language-ocaml"><code>| Redraw         â€“ visible state changed; re-render the UI
| Submit_input   â€“ draft is ready; send it to the assistant
| Cancel_or_quit â€“ ESC; cancel streaming or quit if idle
| Compact_context â€“ user requested context compaction
| Quit           â€“ immediate termination (Ctrl-C / 'q')
| Unhandled      â€“ event not recognised; try other handlers</code></pre><p><b>Performance</b>: all operations run in O(length input) at worst (duplicate line); typical keystrokes are sub-millisecond.</p><div class="odoc-spec"><div class="spec type anchored" id="type-reaction"><a href="#type-reaction" class="anchor"></a><code><span><span class="keyword">type</span> reaction</span><span> = <a href="../Controller_types/index.html#type-reaction">Controller_types.reaction</a></span><span> = </span></code><ol><li id="type-reaction.Redraw" class="def variant constructor anchored"><a href="#type-reaction.Redraw" class="anchor"></a><code><span>| </span><span><span class="constructor">Redraw</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The event modified the visible state â€“ caller should refresh.</p><span class="comment-delim">*)</span></div></li><li id="type-reaction.Submit_input" class="def variant constructor anchored"><a href="#type-reaction.Submit_input" class="anchor"></a><code><span>| </span><span><span class="constructor">Submit_input</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>User pressed Meta+Enter to submit the prompt.</p><span class="comment-delim">*)</span></div></li><li id="type-reaction.Cancel_or_quit" class="def variant constructor anchored"><a href="#type-reaction.Cancel_or_quit" class="anchor"></a><code><span>| </span><span><span class="constructor">Cancel_or_quit</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>ESC â€“ cancel running request or quit.</p><span class="comment-delim">*)</span></div></li><li id="type-reaction.Compact_context" class="def variant constructor anchored"><a href="#type-reaction.Compact_context" class="anchor"></a><code><span>| </span><span><span class="constructor">Compact_context</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Trigger conversation compaction.</p><span class="comment-delim">*)</span></div></li><li id="type-reaction.Quit" class="def variant constructor anchored"><a href="#type-reaction.Quit" class="anchor"></a><code><span>| </span><span><span class="constructor">Quit</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Immediate quit (Ctrl-C / q).</p><span class="comment-delim">*)</span></div></li><li id="type-reaction.Unhandled" class="def variant constructor anchored"><a href="#type-reaction.Unhandled" class="anchor"></a><code><span>| </span><span><span class="constructor">Unhandled</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Controller didnâ€™t deal with the event.</p><span class="comment-delim">*)</span></div></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-handle_key"><a href="#val-handle_key" class="anchor"></a><code><span><span class="keyword">val</span> handle_key : 
  <span><span class="label">model</span>:<a href="../Model/index.html#type-t">Model.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">term</span>:<a href="../../Notty_eio/Term/index.html#type-t">Notty_eio.Term.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Notty</span>.Unescape.event <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-reaction">reaction</a></span></code></div><div class="spec-doc"><p><code>handle_key ~model ~term ev</code> is the <b>single</b> public function of the controller hierarchy. It examines <code>model.mode</code> and forwards <code>ev</code> to the appropriate key-map â€“ Insert (local), Normal or Cmdline â€“ then returns the resulting <a href="#type-reaction"><code>reaction</code></a>.</p><p>Parameters</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">model</span> <p>The mutable snapshot of the UI state that will be modified <i>in-place</i>. Only the record fields are changed â€“ no network or disk IO happens here.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">term</span> <p>The Notty terminal abstraction used to query run-time geometry with <a href="../../Notty_eio/Term/index.html#val-size"><code>Notty_eio.Term.size</code></a>. The value is <i>never</i> modified.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">ev</span> <p>The raw event received from <code>Notty.Unescape.event</code>.</p></li></ul><p>Return value</p><p>A <a href="../Controller_types/index.html#type-reaction"><code>Controller_types.reaction</code></a>. The caller <b>must</b> pattern-match on the result and perform the side-effects described by the variant:</p><ul><li><a href="#type-reaction.Redraw"><code>Redraw</code></a> â€“ re-render the viewport</li><li><a href="#type-reaction.Submit_input"><code>Submit_input</code></a> â€“ wrap the draft into an OpenAI request and append a pending entry to the history</li><li><a href="#type-reaction.Cancel_or_quit"><code>Cancel_or_quit</code></a> â€“ either cancel an in-flight stream or quit when idle</li><li><a href="#type-reaction.Compact_context"><code>Compact_context</code></a> â€“ asynchronously trigger context compaction</li><li><a href="#type-reaction.Quit"><code>Quit</code></a> â€“ stop the application immediately</li><li><a href="#type-reaction.Unhandled"><code>Unhandled</code></a> â€“ fall back to global shortcuts or ignore the event</li></ul><p>Example</p><p>Dispatch an event inside the main loop:</p><pre class="language-ocaml"><code>  let reaction = Chat_tui.Controller.handle_key ~model ~term ev in
  match reaction with
  | Redraw -&gt; Renderer.draw ~model ~term
  | Submit_input -&gt; send_prompt_to_assistant model
  | Cancel_or_quit -&gt; handle_escape model
  | Quit -&gt; exit 0
  | Unhandled -&gt; ()
  | Compact_context -&gt; Context_compaction.request ()</code></pre></div></div></div></body></html>
