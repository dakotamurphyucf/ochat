<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>App_streaming (ochat.Chat_tui.App_streaming)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_tui</a> &#x00BB; App_streaming</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_tui.App_streaming</span></code></h1><p>OpenAI streaming worker for <a href="../App/index.html"><code>Chat_tui.App</code></a>.</p><p>This module runs the OpenAI Responses streaming request and forwards incremental events back to the UI event loop via <a href="../App_events/index.html#type-internal_event"><code>Chat_tui.App_events.internal_event</code></a> messages.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec exception anchored" id="exception-Cancelled"><a href="#exception-Cancelled" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Cancelled</span></span></code></div><div class="spec-doc"><p>Raised to cancel an in-flight streaming request.</p><p><a href="../App_reducer/index.html"><code>Chat_tui.App_reducer</code></a> cancels streaming by failing the streaming switch with this exception.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-start"><a href="#val-start" class="anchor"></a><code><span><span class="keyword">val</span> start : 
  <span><span class="label">env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">history</span>:<span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">internal_stream</span>:<span><a href="../App_events/index.html#type-internal_event">App_events.internal_event</a> <span class="xref-unresolved">Eio</span>.Stream.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">system_event</span>:<span>string <span class="xref-unresolved">Eio</span>.Stream.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cfg</span>:<a href="../../Chat_response/Config/index.html#type-t">Chat_response.Config.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">tools</span>:<span><a href="../../Openai/Responses/Request/Tool/index.html#type-t">Openai.Responses.Request.Tool.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">tool_tbl</span>:
    <span><span>(string, <span>string <span class="arrow">&#45;&gt;</span></span> <a href="../../Openai/Responses/Tool_output/Output/index.html#type-t">Openai.Responses.Tool_output.Output.t</a>)</span> <span class="xref-unresolved">Core</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">datadir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">parallel_tool_calls</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">history_compaction</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">op_id</span>:int <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>start ~env ~history ~internal_stream ~system_event ~cfg ~tools ~tool_tbl ...</code> runs a single OpenAI streaming request and reports progress to <code>internal_stream</code>.</p><p>The worker emits:</p><ul><li><code>`Streaming_started</code> once a dedicated streaming switch exists;</li><li><code>`Stream</code> and <code>`Stream_batch</code> events for incremental deltas;</li><li><code>`Tool_output</code> items for tool call outputs;</li><li><code>`Streaming_done</code> with the final item list; or</li><li><code>`Streaming_error</code> on failure or cancellation.</li></ul><p>The function catches all exceptions and converts them into a <code>`Streaming_error</code> event.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">env</span> <p>Provides network, filesystem, and clock resources.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">history</span> <p>OpenAI item history that seeds the request.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">internal_stream</span> <p>Receives streaming lifecycle and delta events.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">system_event</span> <p>Queue of out-of-band notes that should be included in the assistant context but must not be rendered in the transcript.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">cfg</span> <p>Model settings (temperature, model name, token limits, ...).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">tools</span> <p>Tool declaration list exposed to the assistant.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">tool_tbl</span> <p>Maps tool names to implementations that produce tool outputs.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">datadir</span> <p>Directory used for response cache and tool artefacts.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">parallel_tool_calls</span> <p>Controls whether tool calls may run concurrently.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">history_compaction</span> <p>Forwards to the driverâ€™s lightweight history compaction.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">op_id</span> <p>Tags events so the reducer can ignore stale messages.</p></li></ul><p>Example (the app typically passes a partially-applied <code>start</code> into the reducer):</p><pre class="language-ocaml"><code>  let handle_submit =
    Chat_tui.App_streaming.start
      ~cfg
      ~tools
      ~tool_tbl
  in
  ignore handle_submit</code></pre></div></div></div></body></html>
