<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>App_reducer (ochat.Chat_tui.App_reducer)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_tui</a> &#x00BB; App_reducer</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_tui.App_reducer</span></code></h1><p>Main event loop for the terminal UI.</p><p><a href="#val-run"><code>Chat_tui.App_reducer.run</code></a> is the central &quot;reducer&quot; loop that consumes terminal input events and internal events (streaming, compaction, redraw), mutates the <code>Model.t</code> and requests re-renders.</p><p>The reducer enforces a simple concurrency policy:</p><ul><li>At most one operation (streaming or compaction) is active at a time.</li><li>Additional submits/compactions are queued in FIFO order.</li><li><code>Esc</code> cancels the active operation; when idle, it exits the UI.</li></ul></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-run"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : 
  <span><span class="label">env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ui_sw</span>:<span class="xref-unresolved">Eio</span>.Switch.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cwd</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cache</span>:<a href="../../Chat_response/Cache/index.html#type-t">Chat_response.Cache.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">datadir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">session</span>:<span><a href="../../Session/index.html#type-t">Session.t</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">term</span>:<a href="../../Notty_eio/Term/index.html#type-t">Notty_eio.Term.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">runtime</span>:<a href="../App_runtime/index.html#type-t">App_runtime.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">input_stream</span>:<span><a href="../App_events/index.html#type-input_event">App_events.input_event</a> <span class="xref-unresolved">Eio</span>.Stream.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">internal_stream</span>:<span><a href="../App_events/index.html#type-internal_event">App_events.internal_event</a> <span class="xref-unresolved">Eio</span>.Stream.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">system_event</span>:<span>string <span class="xref-unresolved">Eio</span>.Stream.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">throttler</span>:<a href="../Redraw_throttle/index.html#type-t">Redraw_throttle.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">redraw_immediate</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">redraw</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">handle_submit</span>:<a href="../App_submit/index.html#type-handle_submit">App_submit.handle_submit</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">parallel_tool_calls</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cancelled</span>:exn <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  bool</span></code></div><div class="spec-doc"><p><code>run ...</code> runs the main event loop and blocks until the UI should stop.</p><p>The reducer is single-threaded with respect to the UI model: it is the only place that should mutate <code>runtime.model</code>. Background fibres communicate by pushing <a href="../App_events/index.html#type-internal_event"><code>App_events.internal_event</code></a> values into <code>internal_stream</code>.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">env</span> <p>Provides stdin/stdout, filesystem access, and a clock.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">ui_sw</span> <p>UI switch used to fork background fibres (streaming, compaction, redraw throttle).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">cwd</span> <p>User working directory used for resolving relative paths in prompt parsing and tool execution.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">cache</span> <p>Shared chat-response cache used by raw-XML conversion.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">datadir</span> <p>Per-run/per-session directory for caches and tool outputs.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">session</span> <p>Active session (if any) used for persistence and compaction.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">term</span> <p>Active Notty terminal used by the controller and redraw.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">runtime</span> <p>Shared mutable runtime state holding <code>runtime.model</code>.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">input_stream</span> <p>Terminal input events from <a href="../../Notty_eio/Term/index.html#val-run"><code>Notty_eio.Term.run</code></a>.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">internal_stream</span> <p>Streaming/compaction lifecycle events and redraw requests.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">system_event</span> <p>Out-of-band notes to include in assistant context without rendering them as user-visible messages.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">throttler</span> <p>Coalesces frequent redraw requests into a target FPS.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">redraw_immediate</span> <p>Renders immediately (bypassing the throttle).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">redraw</span> <p>Renders the current model (typically invoked by the throttle).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">handle_submit</span> <p>Asynchronous streaming worker invoked on submit.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">parallel_tool_calls</span> <p>Controls whether tool calls may run concurrently during streaming.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">cancelled</span> <p>Exception used to cancel streaming (typically <a href="../App_streaming/index.html#exception-Cancelled"><code>Chat_tui.App_streaming.Cancelled</code></a>).</p></li></ul><ul class="at-tags"><li class="returns"><span class="at-tag">returns</span> <p><code>true</code> iff the user quit via <code>Esc</code> while idle.</p></li></ul><p>Example (as used by <code>Chat_tui.App.run_chat</code>):</p><pre class="language-ocaml"><code>  let quit_via_esc =
    Chat_tui.App_reducer.run
      ~env
      ~ui_sw
      ~cwd
      ~cache
      ~datadir
      ~session
      ~term
      ~runtime
      ~input_stream
      ~internal_stream
      ~system_event
      ~throttler
      ~redraw_immediate
      ~redraw
      ~handle_submit
      ~parallel_tool_calls:true
      ~cancelled:Chat_tui.App_streaming.Cancelled
      ()
  in
  ignore quit_via_esc</code></pre></div></div></div></body></html>
