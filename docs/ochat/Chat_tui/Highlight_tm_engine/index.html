<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Highlight_tm_engine (ochat.Chat_tui.Highlight_tm_engine)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_tui</a> &#x00BB; Highlight_tm_engine</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_tui.Highlight_tm_engine</span></code></h1><p>Terminal text-highlighting engine producing Notty spans.</p><p>Convert plain text into per-line sequences of <code>(attr * text)</code> spans that render with <code>Notty.I.string</code>. <code>attr</code> is a <code>Notty.A.t</code> describing the styling to apply to <code>text</code>.</p><p>When configured with a TextMate registry via <a href="#val-with_registry"><code>with_registry</code></a>, tokenize each line using the resolved grammar for <code>lang</code> with the textmate-language library and map token scopes to <code>Notty.A.t</code> via <a href="../Highlight_theme/index.html"><code>Highlight_theme</code></a>. If no registry is provided or <code>lang</code> cannot be resolved, fall back to a plain rendering that produces a single <code>Notty.A.empty</code> span per line.</p><p>Invariants</p><ul><li>Each span belongs to exactly one input line and contains no newlines.</li><li>The number of output lines equals <code>Core.String.split_lines text</code>.</li><li>Concatenating all <code>text</code> fragments of a line reconstructs that line.</li></ul><p>Notes</p><ul><li><code>Notty.I.string</code> rejects control characters (including newlines). The engine never emits newlines in span text but does not filter other control characters. Ensure <code>text</code> is renderable by Notty.</li><li>The TextMate tokenizer requires newline-terminated input lines; the engine appends a newline when tokenizing and strips it from spans.</li></ul><p>See also</p><ul><li><a href="../Highlight_theme/index.html"><code>Highlight_theme</code></a> for how themes map scopes to attributes.</li><li><a href="../Highlight_tm_loader/index.html"><code>Highlight_tm_loader</code></a> for loading and resolving TextMate grammars to use with <a href="#val-with_registry"><code>with_registry</code></a>.</li></ul></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Opaque highlighter handle. Holds the selected theme and, optionally, a grammar registry used to resolve <code>lang</code> hints.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-span"><a href="#type-span" class="anchor"></a><code><span><span class="keyword">type</span> span</span><span> = <span class="xref-unresolved">Notty</span>.A.t * string</span></code></div><div class="spec-doc"><p>A highlighted text fragment: <code>(attr, segment)</code>.</p><p><code>segment</code> is a substring of a single input line (never includes a newline); <code>attr</code> is the display attribute to use when rendering that segment.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-scoped_span"><a href="#type-scoped_span" class="anchor"></a><code><span><span class="keyword">type</span> scoped_span</span><span> = </span><span>{</span></code><ol><li id="type-scoped_span.attr" class="def record field anchored"><a href="#type-scoped_span.attr" class="anchor"></a><code><span>attr : <span class="xref-unresolved">Notty</span>.A.t;</span></code></li><li id="type-scoped_span.text" class="def record field anchored"><a href="#type-scoped_span.text" class="anchor"></a><code><span>text : string;</span></code></li><li id="type-scoped_span.scopes" class="def record field anchored"><a href="#type-scoped_span.scopes" class="anchor"></a><code><span>scopes : <span>string list</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A highlighted text fragment that also preserves the tokenizer scopes used to compute <code>attr</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span><span class="label">theme</span>:<a href="../Highlight_theme/index.html#type-t">Highlight_theme.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ~theme</code> creates a highlighter configured to use <code>theme</code> when mapping token scopes to attributes.</p><p>The <code>theme</code> is used to convert TextMate scopes (e.g. <code>&quot;keyword&quot;</code>, <code>&quot;string&quot;</code>, <code>&quot;entity.name.function&quot;</code>) to Notty attributes.</p><p>Quick start â€“ create an engine and highlight a short snippet:</p><pre class="language-ocaml"><code>  let engine =
    Chat_tui.Highlight_tm_engine.create
      ~theme:Chat_tui.Highlight_theme.github_dark
  in
  let lines =
    Chat_tui.Highlight_tm_engine.highlight_text
      engine ~lang:(Some &quot;ocaml&quot;) ~text:&quot;let x = 1\nin x&quot;
  in
  List.length lines = 2</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_theme"><a href="#val-with_theme" class="anchor"></a><code><span><span class="keyword">val</span> with_theme : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">theme</span>:<a href="../Highlight_theme/index.html#type-t">Highlight_theme.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>with_theme t ~theme</code> returns a highlighter identical to <code>t</code> but using <code>theme</code>. Useful for switching between light/dark palettes.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_registry"><a href="#val-with_registry" class="anchor"></a><code><span><span class="keyword">val</span> with_registry : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">registry</span>:<a href="../Highlight_tm_loader/index.html#type-registry">Highlight_tm_loader.registry</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Extend the highlighter with a TextMate grammar registry. The registry is created and populated via <a href="../Highlight_tm_loader/index.html"><code>Highlight_tm_loader</code></a>. When present, <a href="#val-highlight_text"><code>highlight_text</code></a> will attempt to resolve <code>lang</code> against the registry and colourise the text accordingly. Without a registry the function falls back to plain, monospaced rendering.</p><p>The call is side-effect free; it returns a new value and does not mutate the original highlighter.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-fallback_reason"><a href="#type-fallback_reason" class="anchor"></a><code><span><span class="keyword">type</span> fallback_reason</span><span> = </span></code><ol><li id="type-fallback_reason.No_registry" class="def variant constructor anchored"><a href="#type-fallback_reason.No_registry" class="anchor"></a><code><span>| </span><span><span class="constructor">No_registry</span></span></code></li><li id="type-fallback_reason.Unknown_language" class="def variant constructor anchored"><a href="#type-fallback_reason.Unknown_language" class="anchor"></a><code><span>| </span><span><span class="constructor">Unknown_language</span> <span class="keyword">of</span> string</span></code></li><li id="type-fallback_reason.Tokenize_error" class="def variant constructor anchored"><a href="#type-fallback_reason.Tokenize_error" class="anchor"></a><code><span>| </span><span><span class="constructor">Tokenize_error</span></span></code></li></ol></div><div class="spec-doc"><p>Additional information about a highlighting run.</p></div></div><p>Reason a plain, non-colourized fallback was used.</p><ul><li><code>No_registry</code> â€” the highlighter did not carry a TextMate registry.</li><li><code>Unknown_language l</code> â€” no grammar could be resolved for <code>l</code>.</li><li><code>Tokenize_error</code> â€” tokenization failed for at least one line; the engine falls back to plain spans for the whole input.</li></ul><div class="odoc-spec"><div class="spec type anchored" id="type-info"><a href="#type-info" class="anchor"></a><code><span><span class="keyword">type</span> info</span><span> = </span><span>{</span></code><ol><li id="type-info.fallback" class="def record field anchored"><a href="#type-info.fallback" class="anchor"></a><code><span>fallback : <span><a href="#type-fallback_reason">fallback_reason</a> option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>fallback</code> is <code>Some _</code> if <a href="#val-highlight_text"><code>highlight_text</code></a> used plain rendering for all lines. When <code>None</code>, colourisation was applied.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-highlight_text"><a href="#val-highlight_text" class="anchor"></a><code><span><span class="keyword">val</span> highlight_text : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">lang</span>:<span>string option</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">text</span>:string <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-span">span</a> list</span> list</span></span></code></div><div class="spec-doc"><p><code>highlight_text t ~lang ~text</code> splits <code>text</code> into lines and produces, for each line, a list of <code>(attr, text)</code> spans to render left-to-right.</p><p>Behaviour</p><ul><li>With a registry and known <code>lang</code>, returns zero or more spans per input line, each with an attribute derived from the tokenâ€™s scopes.</li><li>Without a registry or on lookup/tokenization failure, returns one span per input line with attribute <code>Notty.A.empty</code>.</li><li><code>lang</code> is a common language tag such as <code>&quot;ocaml&quot;</code>, <code>&quot;bash&quot;</code>, <code>&quot;diff&quot;</code>, resolved via <a href="../Highlight_tm_loader/index.html#val-find_grammar_by_lang_tag"><code>Highlight_tm_loader.find_grammar_by_lang_tag</code></a>.</li><li>The TextMate tokenizer requires newline-terminated input lines; the engine appends a newline internally before tokenizing and strips it from the produced spans.</li></ul><p>Turning spans into a Notty image:</p><pre class="language-ocaml"><code>  let engine =
    Chat_tui.Highlight_tm_engine.create
      ~theme:Chat_tui.Highlight_theme.github_dark
  in
  let lines =
    Chat_tui.Highlight_tm_engine.highlight_text
      engine ~lang:None ~text:&quot;hello\nworld&quot;
  in
  (* Horizontally compose spans on a line, then stack lines vertically. *)
  let row spans =
    List.fold_left
      (fun img (attr, s) -&gt; Notty.I.(img &lt;|&gt; Notty.I.string attr s))
      Notty.I.empty
      spans
  in
  let image =
    List.fold_left (fun acc l -&gt; Notty.I.(acc &lt;-&gt; row l)) Notty.I.empty lines
  in
  let (_ : Notty.image) = image in
  ()</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-highlight_text_with_scopes"><a href="#val-highlight_text_with_scopes" class="anchor"></a><code><span><span class="keyword">val</span> highlight_text_with_scopes : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">lang</span>:<span>string option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">text</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-scoped_span">scoped_span</a> list</span> list</span></span></code></div><div class="spec-doc"><p>Like <a href="#val-highlight_text"><code>highlight_text</code></a> but preserves TextMate scope information per segment. This is intended for callers that need to filter output based on scopes (e.g. removing markdown delimiter punctuation) before collapsing to plain <code>(attr * text)</code> spans.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-highlight_text_with_info"><a href="#val-highlight_text_with_info" class="anchor"></a><code><span><span class="keyword">val</span> highlight_text_with_info : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">lang</span>:<span>string option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">text</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-span">span</a> list</span> list</span> * <a href="#type-info">info</a></span></code></div><div class="spec-doc"><p><code>highlight_text_with_info</code> is like <a href="#val-highlight_text"><code>highlight_text</code></a> but also returns diagnostic information describing whether a fallback occurred.</p><p><code>fallback = Some (Unknown_language l)</code> indicates that no grammar could be resolved for <code>l</code>; <code>Some No_registry</code> means the engine was not configured with a registry; <code>Some Tokenize_error</code> signals that tokenization failed and plain rendering was used.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-highlight_text_with_scopes_with_info"><a href="#val-highlight_text_with_scopes_with_info" class="anchor"></a><code><span><span class="keyword">val</span> highlight_text_with_scopes_with_info : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">lang</span>:<span>string option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">text</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-scoped_span">scoped_span</a> list</span> list</span> * <a href="#type-info">info</a></span></code></div><div class="spec-doc"><p>Like <a href="#val-highlight_text_with_info"><code>highlight_text_with_info</code></a>, but returns scope-preserving spans.</p></div></div></div></body></html>
