<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>App_submit (ochat.Chat_tui.App_submit)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_tui</a> &#x00BB; App_submit</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_tui.App_submit</span></code></h1><p>Local (synchronous) effects of a user submit, plus spawning the streaming worker.</p><p>When the user hits enter, the UI applies immediate local updates (append the user message, clear the editor, show a &quot;(thinkingâ€¦)&quot; placeholder, request a redraw) and then spawns the asynchronous OpenAI request. This module owns those submit-specific steps.</p><p>The helper is intentionally stateful: it mutates the supplied <a href="../Model/index.html#type-t"><code>Model.t</code></a> and uses <a href="../App_runtime/index.html#type-t"><code>Chat_tui.App_runtime.t</code></a> to record that streaming is starting.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-request"><a href="#type-request" class="anchor"></a><code><span><span class="keyword">type</span> request</span><span> = <a href="../App_runtime/index.html#type-submit_request">App_runtime.submit_request</a></span></code></div><div class="spec-doc"><p>Captured editor state at the time of submission.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-capture_request"><a href="#val-capture_request" class="anchor"></a><code><span><span class="keyword">val</span> capture_request : <span><span class="label">model</span>:<a href="../Model/index.html#type-t">Model.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-request">request</a></span></code></div><div class="spec-doc"><p><code>capture_request ~model</code> snapshots the current editor buffer.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">model</span> <p>UI model supplying the current input buffer and draft mode.</p></li></ul><p>The returned value is used as an immutable submit payload so subsequent edits do not affect the request being processed.</p><p>Example:</p><pre class="language-ocaml"><code>  let req = Chat_tui.App_submit.capture_request ~model in
  ignore (req : Chat_tui.App_submit.request)</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear_editor"><a href="#val-clear_editor" class="anchor"></a><code><span><span class="keyword">val</span> clear_editor : <span><span class="label">model</span>:<a href="../Model/index.html#type-t">Model.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>clear_editor ~model</code> resets the draft buffer after a submit.</p><p>This clears the input text, resets the cursor position to 0 and switches the draft mode back to <a href="../Model/index.html#type-draft_mode.Plain"><code>Model.draft_mode.Plain</code></a>.</p><p>The helper also invalidates and clears any in-flight type-ahead state by:</p><ul><li>bumping <a href="../Model/index.html#type-t.typeahead_generation"><code>Model.t.typeahead_generation</code></a> so stale completions cannot apply;</li><li>clearing <a href="../Model/index.html#type-typeahead_completion"><code>Model.typeahead_completion</code></a>; and</li><li>closing the preview popup.</li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">model</span> <p>UI model to mutate in-place.</p></li></ul></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Context"><a href="#module-Context" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Context/index.html">Context</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-start"><a href="#val-start" class="anchor"></a><code><span><span class="keyword">val</span> start : <span><a href="Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>start ... submit_request</code> applies local submit effects and then spawns the streaming worker fibre.</p><p>The function:</p><ul><li>moves the draft into the transcript (as plain text or raw XML);</li><li>clears the editor and scrolls to the bottom;</li><li>injects an assistant placeholder message;</li><li>marks the runtime as <code>Starting_streaming</code>; and</li><li>forks a fibre that runs the streaming worker and reports results via the internal event stream.</li></ul><p>All inputs other than <code>submit_request</code> are bundled in <a href="Context/index.html#type-t"><code>Chat_tui.App_submit.Context.t</code></a>.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">submit_request</span> <p>Captured editor snapshot to submit.</p></li></ul><p>Example:</p><pre class="language-ocaml"><code>  let req = Chat_tui.App_submit.capture_request ~model in
  Chat_tui.App_submit.clear_editor ~model;
  Chat_tui.App_submit.start ctx req</code></pre></div></div></div></body></html>
