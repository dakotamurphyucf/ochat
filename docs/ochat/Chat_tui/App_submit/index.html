<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>App_submit (ochat.Chat_tui.App_submit)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_tui</a> &#x00BB; App_submit</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_tui.App_submit</span></code></h1><p>Local (synchronous) effects of a user submit, plus spawning the streaming worker.</p><p>When the user hits enter, the UI applies immediate local updates (append the user message, clear the editor, show a &quot;(thinkingâ€¦)&quot; placeholder, request a redraw) and then spawns the asynchronous OpenAI request. This module owns those submit-specific steps.</p><p>The helper is intentionally stateful: it mutates the supplied <code>Model.t</code> and uses <a href="../App_runtime/index.html#type-t"><code>Chat_tui.App_runtime.t</code></a> to record that streaming is starting.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-request"><a href="#type-request" class="anchor"></a><code><span><span class="keyword">type</span> request</span><span> = <a href="../App_runtime/index.html#type-submit_request">App_runtime.submit_request</a></span></code></div><div class="spec-doc"><p>Captured editor state at the time of submission.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-capture_request"><a href="#val-capture_request" class="anchor"></a><code><span><span class="keyword">val</span> capture_request : <span><span class="label">model</span>:<a href="../Model/index.html#type-t">Model.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-request">request</a></span></code></div><div class="spec-doc"><p><code>capture_request ~model</code> snapshots the current editor buffer.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">model</span> <p>UI model supplying the current input buffer and draft mode.</p></li></ul><p>The returned value is used as an immutable submit payload so subsequent edits do not affect the request being processed.</p><p>Example:</p><pre class="language-ocaml"><code>  let req = Chat_tui.App_submit.capture_request ~model in
  ignore (req : Chat_tui.App_submit.request)</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear_editor"><a href="#val-clear_editor" class="anchor"></a><code><span><span class="keyword">val</span> clear_editor : <span><span class="label">model</span>:<a href="../Model/index.html#type-t">Model.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>clear_editor ~model</code> resets the draft buffer after a submit.</p><p>This clears the input text, resets the cursor position to 0 and switches the draft mode back to <code>Model.Plain</code>.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">model</span> <p>UI model to mutate in-place.</p></li></ul></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-handle_submit"><a href="#type-handle_submit" class="anchor"></a><code><span><span class="keyword">type</span> handle_submit</span><span> =
  <span><span class="label">env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">history</span>:<span><a href="../../Openai/Responses/Item/index.html#type-t">Openai.Responses.Item.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">internal_stream</span>:<span><a href="../App_events/index.html#type-internal_event">App_events.internal_event</a> <span class="xref-unresolved">Eio</span>.Stream.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">system_event</span>:<span>string <span class="xref-unresolved">Eio</span>.Stream.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">datadir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">parallel_tool_calls</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">history_compaction</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">op_id</span>:int <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Signature of the streaming worker that will be spawned after local submit effects are applied.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">env</span> <p>Provides network and clock resources for the request.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">history</span> <p>OpenAI item history snapshot that seeds the request.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">internal_stream</span> <p>Receives streaming lifecycle and delta events.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">system_event</span> <p>Receives out-of-band notes that should enter the next requestâ€™s context but must not be rendered as user messages.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">datadir</span> <p>Directory used for response caches and tool artefacts.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">parallel_tool_calls</span> <p>Controls whether tool calls may run concurrently.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">history_compaction</span> <p>Forwards to the chat-response driverâ€™s lightweight compaction pipeline.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">op_id</span> <p>Tags events so the reducer can ignore stale messages.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-start"><a href="#val-start" class="anchor"></a><code><span><span class="keyword">val</span> start : 
  <span><span class="label">env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ui_sw</span>:<span class="xref-unresolved">Eio</span>.Switch.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cwd</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">cache</span>:<a href="../../Chat_response/Cache/index.html#type-t">Chat_response.Cache.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">datadir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">term</span>:<a href="../../Notty_eio/Term/index.html#type-t">Notty_eio.Term.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">runtime</span>:<a href="../App_runtime/index.html#type-t">App_runtime.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">internal_stream</span>:<span><a href="../App_events/index.html#type-internal_event">App_events.internal_event</a> <span class="xref-unresolved">Eio</span>.Stream.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">system_event</span>:<span>string <span class="xref-unresolved">Eio</span>.Stream.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">throttler</span>:<a href="../Redraw_throttle/index.html#type-t">Redraw_throttle.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">handle_submit</span>:<a href="#type-handle_submit">handle_submit</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">parallel_tool_calls</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>start ... submit_request</code> applies local submit effects and then spawns the streaming worker fibre.</p><p>The function:</p><ul><li>moves the draft into the transcript (as plain text or raw XML);</li><li>clears the editor and scrolls to the bottom;</li><li>injects an assistant placeholder message;</li><li>marks the runtime as <code>Starting_streaming</code>; and</li><li>forks a fibre that runs <code>handle_submit</code> and reports results via <code>internal_stream</code>.</li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">env</span> <p>Supplies filesystem and clock resources used during submission.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">ui_sw</span> <p>UI switch used to fork background fibres.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">cwd</span> <p>Directory used to resolve relative paths in raw-XML drafts.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">cache</span> <p>Shared chat-response cache used when converting raw-XML.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">datadir</span> <p>Per-run/per-session directory for cache and tool output.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">term</span> <p>Terminal used to compute viewport height for scrolling.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">runtime</span> <p>Updated to <code>Starting_streaming</code> and provides <code>runtime.model</code>.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">internal_stream</span> <p>Receives streaming lifecycle events and redraw requests.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">system_event</span> <p>Queue used to enqueue notes when submitting during an active streaming operation.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">throttler</span> <p>Used to request a redraw after local effects are applied.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">handle_submit</span> <p>Asynchronous worker that performs the OpenAI request.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">parallel_tool_calls</span> <p>Forwarded to <code>handle_submit</code>.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">submit_request</span> <p>Captured editor snapshot to submit.</p></li></ul><p>Example:</p><pre class="language-ocaml"><code>  let req = Chat_tui.App_submit.capture_request ~model in
  Chat_tui.App_submit.clear_editor ~model;
  Chat_tui.App_submit.start
    ~env
    ~ui_sw
    ~cwd
    ~cache
    ~datadir
    ~term
    ~runtime
    ~internal_stream
    ~system_event
    ~throttler
    ~handle_submit
    ~parallel_tool_calls:true
    req</code></pre></div></div></div></body></html>
