<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Recursive_mp (ochat.Meta_prompting.Recursive_mp)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Meta_prompting</a> &#x00BB; Recursive_mp</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Meta_prompting.Recursive_mp</span></code></h1><p>Recursive meta-prompting â€“ an iterative prompt refinement engine.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#overview">Overview</a></li><li><a href="#usage-example">Usage example</a><ul><li><a href="#environment-variables">Environment variables</a></li></ul></li></ul></nav></div><div class="odoc-content"><h2 id="overview"><a href="#overview" class="anchor"></a>Overview</h2><p>The <code>Recursive_mp</code> module implements the refinement loop described in &quot;Self-refine: Recursive chunk-based prompting for large language models&quot; and similar papers. Starting from an initial prompt it repeatedly applies a <em>transformation strategy</em> to obtain a candidate prompt, evaluates the candidate with a set of <em>judges</em>, and decides â€“ using Bayesian early stopping as well as an optional Thompson-sampling multi-armed bandit â€“ whether to keep refining or return the current best.</p><p>The algorithm is completely generic:</p><p>â€¢ Transformation is provided by a value of type <a href="#type-transform_strategy"><code>transform_strategy</code></a>. â€¢ Evaluation is delegated to the <a href="../Evaluator/index.html"><code>Evaluator</code></a> abstraction.</p><p>This makes it easy to plug in a heuristic string manipulation, an LLM-based re-writer, or any other strategy without changing the control flow.</p><h2 id="usage-example"><a href="#usage-example" class="anchor"></a>Usage example</h2><p>Refining a plain string prompt with the defaults:</p><pre class="language-ocaml"><code>  open Meta_prompting

  let improved : string =
    let prompt =
      Prompt_intf.make
        ~body:&quot;Explain the HTTP protocol in one paragraph.&quot;
        ()
    in
    Recursive_mp.refine prompt |&gt; Prompt_intf.to_string</code></pre><p>Changing a single parameter â€“ here the maximum number of iterations â€“ is done inline via optional arguments:</p><pre class="language-ocaml"><code>  let improved = Recursive_mp.refine ~max_iters:5 prompt</code></pre><p>For more advanced control compose a full <code>refine_params</code> value:</p><pre class="language-ocaml"><code>  let params =
    Recursive_mp.make_params
      ~judges:[ Evaluator.Judge Recursive_mp.Evaluator.rubric_critic_judge ]
      ~bandit_enabled:true
      ~strategies:
        [ Recursive_mp.default_llm_strategy
        ; Recursive_mp.meta_factory_online_strategy
        ]
      ()
  in
  let improved = Recursive_mp.refine ~params prompt</code></pre><h3 id="environment-variables"><a href="#environment-variables" class="anchor"></a>Environment variables</h3><p>The implementation honours several environment variables that influence the default behaviour. All of them are optional.</p><p>â€¢ <code>OPENAI_API_KEY</code> â€“ enables LLM-based transformation and evaluation.\\ â€¢ <code>META_PROPOSER_MODEL</code> â€“ default model for the proposer agent.\\ â€¢ <code>META_PROMPT_BUDGET</code> â€“ soft limit for the number of output tokens.\\ â€¢ <code>META_PROMPT_GUIDELINES</code> â€“ toggle injection of extra guidelines.\\ â€¢ <code>META_PROMPT_CTX_K</code> â€“ number of vector-DB context snippets to retrieve.</p><p>Refer to the README for a complete list.</p><div class="odoc-spec"><div class="spec type anchored" id="type-transform_strategy"><a href="#type-transform_strategy" class="anchor"></a><code><span><span class="keyword">type</span> transform_strategy</span><span> = </span><span>{</span></code><ol><li id="type-transform_strategy.name" class="def record field anchored"><a href="#type-transform_strategy.name" class="anchor"></a><code><span>name : string;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Human-readable identifier used for logging and bandit arms.</p><span class="comment-delim">*)</span></div></li><li id="type-transform_strategy.apply" class="def record field anchored"><a href="#type-transform_strategy.apply" class="anchor"></a><code><span>apply : <span><a href="../Prompt_intf/index.html#type-t">Prompt_intf.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">iteration</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">context</span>:<a href="../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Prompt_intf/index.html#type-t">Prompt_intf.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>apply p ~iteration ~context</code> must return a new prompt. The optional <code>env</code> can be used when the strategy needs network or file system access.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A <em>transformation strategy</em> takes the current prompt, the iteration counter, and an execution <code>Context.t</code> and returns a (hopefully improved) prompt.</p><p>Implementations <b>must</b> be deterministic with respect to their explicit arguments (they may of course consult an LLM or random generator internally), and <b>should not</b> mutate the input prompt value.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span><span> = </span></code><ol><li id="type-t.Return" class="def variant constructor anchored"><a href="#type-t.Return" class="anchor"></a><code><span>| </span><span><span class="constructor">Return</span> <span class="keyword">of</span> <span class="type-var">'a</span></span></code></li><li id="type-t.Bind" class="def variant constructor anchored"><a href="#type-t.Bind" class="anchor"></a><code><span>| </span><span><span class="constructor">Bind</span> <span class="keyword">of</span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span> * <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Lightweight continuation monad used to stage recursive calls inside the refinement loop. It is <b>not</b> intended for general consumption but is exposed â€“ together with the constructors â€“ so that expect tests and helper utilities can pattern-match on intermediate results.</p><span class="comment-delim">*)</span></div></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-refine_params"><a href="#type-refine_params" class="anchor"></a><code><span><span class="keyword">type</span> refine_params</span><span> = </span><span>{</span></code><ol><li id="type-refine_params.evaluator" class="def record field anchored"><a href="#type-refine_params.evaluator" class="anchor"></a><code><span>evaluator : <a href="../Evaluator/index.html#type-t">Evaluator.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Scoring function used to rank candidates.</p><span class="comment-delim">*)</span></div></li><li id="type-refine_params.max_iters" class="def record field anchored"><a href="#type-refine_params.max_iters" class="anchor"></a><code><span>max_iters : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Hard upper bound on the number of refinement iterations.</p><span class="comment-delim">*)</span></div></li><li id="type-refine_params.score_epsilon" class="def record field anchored"><a href="#type-refine_params.score_epsilon" class="anchor"></a><code><span>score_epsilon : float;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Minimal score improvement considered meaningful. Values â‰¤ this threshold are treated as &quot;no progress&quot; for Bayesian convergence detection.</p><span class="comment-delim">*)</span></div></li><li id="type-refine_params.plateau_window" class="def record field anchored"><a href="#type-refine_params.plateau_window" class="anchor"></a><code><span>plateau_window : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Deprecated. Kept for backwards compatibility but ignored.</p><span class="comment-delim">*)</span></div></li><li id="type-refine_params.bayes_alpha" class="def record field anchored"><a href="#type-refine_params.bayes_alpha" class="anchor"></a><code><span>bayes_alpha : float;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Significance level for the Bayesian success-rate estimate. The loop stops once the posterior expectation of making further progress falls below <code>bayes_alpha</code>.</p><span class="comment-delim">*)</span></div></li><li id="type-refine_params.bandit_enabled" class="def record field anchored"><a href="#type-refine_params.bandit_enabled" class="anchor"></a><code><span>bandit_enabled : bool;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Enable Thompson sampling over <a href="#type-refine_params.strategies"><code>strategies</code></a>.</p><span class="comment-delim">*)</span></div></li><li id="type-refine_params.strategies" class="def record field anchored"><a href="#type-refine_params.strategies" class="anchor"></a><code><span>strategies : <span><a href="#type-transform_strategy">transform_strategy</a> list</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Ordered list of candidate strategies. At least one element is required.</p><span class="comment-delim">*)</span></div></li><li id="type-refine_params.proposer_model" class="def record field anchored"><a href="#type-refine_params.proposer_model" class="anchor"></a><code><span>proposer_model : <span><a href="../../Openai/Responses/Request/index.html#type-model">Openai.Responses.Request.model</a> option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Override the default OpenAI model used by transformation strategies that call the LLM.</p><span class="comment-delim">*)</span></div></li><li id="type-refine_params.executor_model" class="def record field anchored"><a href="#type-refine_params.executor_model" class="anchor"></a><code><span>executor_model : <span><a href="../../Openai/Responses/Request/index.html#type-model">Openai.Responses.Request.model</a> option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Reserved for future use â€“ at present only logged.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Fine-tuning knobs for <a href="#val-refine"><code>refine</code></a>. Use <a href="#val-default_params"><code>default_params</code></a> or <a href="#val-make_params"><code>make_params</code></a> for construction.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_llm_strategy"><a href="#val-default_llm_strategy" class="anchor"></a><code><span><span class="keyword">val</span> default_llm_strategy : <a href="#type-transform_strategy">transform_strategy</a></span></code></div><div class="spec-doc"><p><code>default_llm_strategy</code> delegates the heavy lifting to an LLM via the OpenAI <code>/responses</code> endpoint. The actual model is resolved from <a href="#type-refine_params.proposer_model"><code>refine_params.proposer_model</code></a> (or the <code>`META_PROPOSER_MODEL`</code> environment variable), allowing callers to switch models without touching the strategy value.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-meta_factory_online_strategy"><a href="#val-meta_factory_online_strategy" class="anchor"></a><code><span><span class="keyword">val</span> meta_factory_online_strategy : <a href="#type-transform_strategy">transform_strategy</a></span></code></div><div class="spec-doc"><p><code>meta_factory_online_strategy</code> submits the current prompt to the online *meta-prompt factory* template, extracts the `&lt;Revised_Prompt&gt;` block from the LLM reply and uses it as the next candidate. When the LLM cannot be reached (for instance because `OPENAI_API_KEY` is unset) the function degrades gracefully to a metadata-only no-op, thereby preserving the monotonicity guarantee of the refinement loop.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_params"><a href="#val-default_params" class="anchor"></a><code><span><span class="keyword">val</span> default_params : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="#type-refine_params">refine_params</a></span></code></div><div class="spec-doc"><p><code>default_params ()</code> returns a parameter set that performs up to three iterations using <a href="#val-default_llm_strategy"><code>default_llm_strategy</code></a> and the default <a href="../Evaluator/index.html"><code>Evaluator</code></a>. Bayesian convergence is active with <code>~bayes_alpha = 0.05</code> and <code>~score_epsilon = 1e-6</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-make_params"><a href="#val-make_params" class="anchor"></a><code><span><span class="keyword">val</span> make_params : 
  <span><span class="optlabel">?judges</span>:<span><a href="../Evaluator/index.html#type-judge">Evaluator.judge</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?max_iters</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?score_epsilon</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?plateau_window</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?bayes_alpha</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?bandit_enabled</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?strategies</span>:<span><a href="#type-transform_strategy">transform_strategy</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?proposer_model</span>:<a href="../../Openai/Responses/Request/index.html#type-model">Openai.Responses.Request.model</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?executor_model</span>:<a href="../../Openai/Responses/Request/index.html#type-model">Openai.Responses.Request.model</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-refine_params">refine_params</a></span></code></div><div class="spec-doc"><p>Flexible constructor mirroring the record fields. When <code>~judges</code> is supplied a fresh <a href="../Evaluator/index.html#type-t"><code>Evaluator.t</code></a> is created internally. Otherwise the default evaluator is used. Unspecified optional arguments fall back to the values of <a href="#val-default_params"><code>default_params</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-refine"><a href="#val-refine" class="anchor"></a><code><span><span class="keyword">val</span> refine : 
  <span><span class="optlabel">?context</span>:<a href="../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?params</span>:<a href="#type-refine_params">refine_params</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?judges</span>:<span><a href="../Evaluator/index.html#type-judge">Evaluator.judge</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?max_iters</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?score_epsilon</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?plateau_window</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?bayes_alpha</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?bandit_enabled</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?strategies</span>:<span><a href="#type-transform_strategy">transform_strategy</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?proposer_model</span>:<a href="../../Openai/Responses/Request/index.html#type-model">Openai.Responses.Request.model</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?executor_model</span>:<a href="../../Openai/Responses/Request/index.html#type-model">Openai.Responses.Request.model</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Prompt_intf/index.html#type-t">Prompt_intf.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Prompt_intf/index.html#type-t">Prompt_intf.t</a></span></code></div><div class="spec-doc"><p><code>refine p</code> returns an improved variant of <code>p</code>.</p><p>The algorithm proceeds as follows:</p><ol><li>Score the current best prompt using <code>evaluator</code>.</li><li>Select a transformation strategy (uniformly at first, then via Thompson-sampling if <code>~bandit_enabled</code> was set).</li><li>Apply the strategy, score the candidate, and update the best prompt if it improved.</li><li>Update Bayesian success statistics and stop early when further progress is deemed unlikely.</li></ol><p>Optional arguments mirror <a href="#val-make_params"><code>make_params</code></a> for convenience so that users can tweak a single knob without constructing a full parameter record. A dedicated <code>context</code> can be provided to supply an <code>env</code>, guidelines or prompt-type metadata.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Let_syntax"><a href="#module-Let_syntax" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Let_syntax/index.html">Let_syntax</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Monad operations exposed mainly for let-syntax inside the implementation. External users will rarely need these.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-return"><a href="#val-return" class="anchor"></a><code><span><span class="keyword">val</span> return : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p>Alias of <a href="Let_syntax/index.html#val-return"><code>Let_syntax.return</code></a> exposed at the toplevel for convenience and for property-based tests shipped with the library.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bind"><a href="#val-bind" class="anchor"></a><code><span><span class="keyword">val</span> bind : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p>Monadic bind â€“ see <a href="Let_syntax/index.html#val-bind"><code>Let_syntax.bind</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-join"><a href="#val-join" class="anchor"></a><code><span><span class="keyword">val</span> join : <span><span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p>Flatten one level of monadic structure.</p></div></div></div></body></html>
