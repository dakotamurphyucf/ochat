<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Evaluator (ochat.Evaluator)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../';
let search_urls = ['../db.js','../../sherlodoc.js'];
</script><script src="../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ochat</a> &#x00BB; Evaluator</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Evaluator</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#regex-based-judge">Regex-based judge</a></li><li><a href="#log-probability-judge">Log-probability judge</a></li><li><a href="#llm-powered-judge">LLM-powered judge</a></li><li><a href="#rubric-critic-judge">Rubric critic judge</a></li><li><a href="#reward-model-judge">Reward model judge</a></li><li><a href="#self-consistency-wrapper">Self-consistency wrapper</a></li></ul></nav></div><div class="odoc-content"><p>Evaluator ‚Äì flexible scoring framework for prompt quality. An <code>Evaluator.t</code> combines one or more <em>judges</em>. Each judge maps a candidate answer (here represented simply as <code>string</code>) to a numeric score. The evaluator caches results and can parallelise judgements in the future via a task-pool (left TODO ‚Äì the current implementation executes sequentially).</p><p>The module deliberately avoids any heavyweight dependencies so that unit tests do not require network access. Back-ends that need external resources (e.g. OpenAI) should degrade gracefully when the required environment variables are missing.</p><div class="odoc-spec"><div class="spec type anchored" id="type-score"><a href="#type-score" class="anchor"></a><code><span><span class="keyword">type</span> score</span><span> = float</span></code></div></div><div class="odoc-spec"><div class="spec module-type anchored" id="module-type-Judge"><a href="#module-type-Judge" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-Judge/index.html">Judge</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Guidelines_judge"><a href="#module-Guidelines_judge" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Guidelines_judge/index.html">Guidelines_judge</a></span><span> : <a href="module-type-Judge/index.html">Judge</a></span></code></div></div><div class="odoc-spec"><div class="spec module-type anchored" id="module-type-Pairwise_judge"><a href="#module-type-Pairwise_judge" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-Pairwise_judge/index.html">Pairwise_judge</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-judge"><a href="#type-judge" class="anchor"></a><code><span><span class="keyword">type</span> judge</span><span> = </span></code><ol><li id="type-judge.Judge" class="def variant constructor anchored"><a href="#type-judge.Judge" class="anchor"></a><code><span>| </span><span><span class="constructor">Judge</span> <span class="keyword">of</span> <span>(<span class="keyword">module</span> <a href="module-type-Judge/index.html">Judge</a>)</span></span></code></li><li id="type-judge.Pairwise_judge" class="def variant constructor anchored"><a href="#type-judge.Pairwise_judge" class="anchor"></a><code><span>| </span><span><span class="constructor">Pairwise_judge</span> <span class="keyword">of</span> <span>(<span class="keyword">module</span> <a href="module-type-Pairwise_judge/index.html">Pairwise_judge</a>)</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Pairwise_arena_judge"><a href="#module-Pairwise_arena_judge" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Pairwise_arena_judge/index.html">Pairwise_arena_judge</a></span><span> : <a href="module-type-Pairwise_judge/index.html">Pairwise_judge</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pairwise_arena_judge"><a href="#val-pairwise_arena_judge" class="anchor"></a><code><span><span class="keyword">val</span> pairwise_arena_judge : <span>(<span class="keyword">module</span> <a href="module-type-Pairwise_judge/index.html">Pairwise_judge</a>)</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-judge_timeout_seconds"><a href="#val-judge_timeout_seconds" class="anchor"></a><code><span><span class="keyword">val</span> judge_timeout_seconds : <span>unit <span class="arrow">&#45;&gt;</span></span> float</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pool_size"><a href="#val-pool_size" class="anchor"></a><code><span><span class="keyword">val</span> pool_size : <span>unit <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_exception_guard"><a href="#val-with_exception_guard" class="anchor"></a><code><span><span class="keyword">val</span> with_exception_guard : 
  <span><span class="label">clock</span>:<span><span>[&gt; <span>float <span class="xref-unresolved">Eio</span>.Time.clock_ty</span> ]</span> <span class="xref-unresolved">Eio</span>.Time.clock</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">timeout_s</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-judge">judge</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?best</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-score">score</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_exception_guard_sequential"><a href="#val-with_exception_guard_sequential" class="anchor"></a><code><span><span class="keyword">val</span> with_exception_guard_sequential : 
  <span><a href="#type-judge">judge</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?best</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-score">score</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Mock_judge"><a href="#module-Mock_judge" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Mock_judge/index.html">Mock_judge</a></span><span> : <a href="module-type-Judge/index.html">Judge</a></span></code></div></div><h3 id="regex-based-judge"><a href="#regex-based-judge" class="anchor"></a>Regex-based judge</h3><p>Accepts a POSIX regular expression and returns 1.0 when the pattern matches, else 0.0. Useful in unit tests.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Answer_regex_judge"><a href="#module-Answer_regex_judge" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Answer_regex_judge/index.html">Answer_regex_judge</a></span><span> (<a href="Answer_regex_judge/argument-1-P/index.html">P</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span>) : <a href="module-type-Judge/index.html">Judge</a></span></code></div></div><h3 id="log-probability-judge"><a href="#log-probability-judge" class="anchor"></a>Log-probability judge</h3><p>Very naive proxy: longer answers get lower scores. A proper implementation would call the model with <code>logprobs=True</code> and sum the token log-probs.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Logprob_judge"><a href="#module-Logprob_judge" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Logprob_judge/index.html">Logprob_judge</a></span><span> : <a href="module-type-Judge/index.html">Judge</a></span></code></div></div><h3 id="llm-powered-judge"><a href="#llm-powered-judge" class="anchor"></a>LLM-powered judge</h3><p>This is a stub that attempts to call the OpenAI chat completion endpoint with an evaluation prompt √† la &quot;Score the following answer from 0-10&quot;. When the required API key is absent it returns the fallback score 0.5 so that tests pass offline.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Llm_judge"><a href="#module-Llm_judge" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Llm_judge/index.html">Llm_judge</a></span><span> : <a href="module-type-Judge/index.html">Judge</a></span></code></div></div><h3 id="rubric-critic-judge"><a href="#rubric-critic-judge" class="anchor"></a>Rubric critic judge</h3><p>Scores a single candidate answer against a five-aspect rubric (correctness, completeness, depth, style, safety). The grader model must respond with a JSON object containing exactly these keys mapped to floating-point scores in the inclusive range <code>0,10</code>. The judge parses the JSON, computes the arithmetic mean of the provided sub-scores and normalises to <code>0,1</code> by dividing by ten.</p><p>When the OPENAI_API_KEY environment variable is absent or an error occurs, the judge deterministically returns the fallback score 0.5 so that unit tests remain offline-friendly.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Rubric_critic_judge"><a href="#module-Rubric_critic_judge" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Rubric_critic_judge/index.html">Rubric_critic_judge</a></span><span> : <a href="module-type-Judge/index.html">Judge</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rubric_critic_judge"><a href="#val-rubric_critic_judge" class="anchor"></a><code><span><span class="keyword">val</span> rubric_critic_judge : <span>(<span class="keyword">module</span> <a href="module-type-Judge/index.html">Judge</a>)</span></span></code></div></div><h3 id="reward-model-judge"><a href="#reward-model-judge" class="anchor"></a>Reward model judge</h3><p>Leverages OpenAI‚Äôs public *grader* endpoint (alpha) to obtain a high-fidelity scalar reward in the range <code>0,1</code>. A <em>score model</em> grader is used with a succinct system instruction asking for a single floating-point score only. If the <code>OPENAI_API_KEY</code> variable is missing or any error occurs, the judge deterministically returns the fallback value 0.5 so that unit tests remain offline-friendly.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Reward_model_judge"><a href="#module-Reward_model_judge" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Reward_model_judge/index.html">Reward_model_judge</a></span><span> : <a href="module-type-Judge/index.html">Judge</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reward_model_judge"><a href="#val-reward_model_judge" class="anchor"></a><code><span><span class="keyword">val</span> reward_model_judge : <span>(<span class="keyword">module</span> <a href="module-type-Judge/index.html">Judge</a>)</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-sc_strategy"><a href="#type-sc_strategy" class="anchor"></a><code><span><span class="keyword">type</span> sc_strategy</span><span> = </span></code><ol><li id="type-sc_strategy.Mean" class="def variant constructor anchored"><a href="#type-sc_strategy.Mean" class="anchor"></a><code><span>| </span><span><span class="constructor">Mean</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Arithmetic mean of the <code>k</code> scores</p><span class="comment-delim">*)</span></div></li><li id="type-sc_strategy.Majority" class="def variant constructor anchored"><a href="#type-sc_strategy.Majority" class="anchor"></a><code><span>| </span><span><span class="constructor">Majority</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Majority vote interpreting a score &gt; 0.5 as ‚Äúsuccess‚Äù. Ties resolve to <code>0.0</code>.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>Strategy used to aggregate the <code>k</code> individual scores produced by a judge when running in self-consistency mode.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-string_of_sc_strategy"><a href="#val-string_of_sc_strategy" class="anchor"></a><code><span><span class="keyword">val</span> string_of_sc_strategy : <span><a href="#type-sc_strategy">sc_strategy</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div></div><h3 id="self-consistency-wrapper"><a href="#self-consistency-wrapper" class="anchor"></a>Self-consistency wrapper</h3><p><code>Self_consistency_judge</code> is a functor that wraps an existing <code>Judge</code> and evaluates it <code>k</code> times on the same candidate string. The resulting list of scores is then aggregated using the user-selected <a href="#type-sc_strategy"><code>sc_strategy</code></a>. This implements the so-called *self-consistency* evaluator described in the research literature, where multiple stochastic executions are combined to obtain a more robust signal.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Self_consistency_judge"><a href="#module-Self_consistency_judge" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Self_consistency_judge/index.html">Self_consistency_judge</a></span><span> (<a href="Self_consistency_judge/argument-1-Config/index.html">Config</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span>) (<a href="Self_consistency_judge/argument-2-Base/index.html">Base</a> : <a href="module-type-Judge/index.html">Judge</a>) : <a href="module-type-Judge/index.html">Judge</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wrap_self_consistency_judge"><a href="#val-wrap_self_consistency_judge" class="anchor"></a><code><span><span class="keyword">val</span> wrap_self_consistency_judge : 
  <span><span class="label">k</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">strategy</span>:<a href="#type-sc_strategy">sc_strategy</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <a href="module-type-Judge/index.html">Judge</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>(<span class="keyword">module</span> <a href="module-type-Judge/index.html">Judge</a>)</span></span></code></div><div class="spec-doc"><p>Convenience wrapper to create a self-consistency judge without resorting to first-class modules on the caller side.</p></div></div><p><code>Evaluator.t</code> is a container for multiple judges and an optional aggregation strategy. It caches results to avoid redundant evaluations. The <code>aggregate</code> function combines the raw scores from all judges into a single score, which is then cached per candidate string.</p><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = </span><span>{</span></code><ol><li id="type-t.judges" class="def record field anchored"><a href="#type-t.judges" class="anchor"></a><code><span>judges : <span><a href="#type-judge">judge</a> list</span>;</span></code></li><li id="type-t.pw_judges" class="def record field anchored"><a href="#type-t.pw_judges" class="anchor"></a><code><span>pw_judges : <span><span>(<span class="keyword">module</span> <a href="module-type-Pairwise_judge/index.html">Pairwise_judge</a>)</span> list</span>;</span></code></li><li id="type-t.aggregate" class="def record field anchored"><a href="#type-t.aggregate" class="anchor"></a><code><span>aggregate : <a href="../Aggregator/index.html#type-t">Aggregator.t</a>;</span></code></li><li id="type-t.cache" class="def record field anchored"><a href="#type-t.cache" class="anchor"></a><code><span>cache : <span><span>(string, <a href="#type-score">score</a>)</span> <span class="xref-unresolved">Core</span>.Hashtbl.t</span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="optlabel">?judges</span>:<span><a href="#type-judge">judge</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?pw_judges</span>:<span><span>(<span class="keyword">module</span> <a href="module-type-Pairwise_judge/index.html">Pairwise_judge</a>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?aggregate</span>:<a href="../Aggregator/index.html#type-t">Aggregator.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default"><a href="#val-default" class="anchor"></a><code><span><span class="keyword">val</span> default : <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-aggregate"><a href="#val-aggregate" class="anchor"></a><code><span><span class="keyword">val</span> aggregate : <span><span><a href="#type-score">score</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-score">score</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-evaluate"><a href="#val-evaluate" class="anchor"></a><code><span><span class="keyword">val</span> evaluate : 
  <span><span class="optlabel">?env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?best</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-score">score</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-evaluate_default"><a href="#val-evaluate_default" class="anchor"></a><code><span><span class="keyword">val</span> evaluate_default : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-score">score</a></span></code></div></div></div></body></html>
