<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make (ochat.Lru_cache.Make)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Lru_cache</a> &#x00BB; Make</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Lru_cache.Make</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#parameters">Parameters</a></li><li><a href="#signature">Signature</a></li><li><a href="#read-only-operations">Read-only operations</a></li><li><a href="#mutating-operations">Mutating operations</a></li></ul></nav></div><div class="odoc-content"><h2 id="parameters"><a href="#parameters" class="anchor"></a>Parameters</h2><div class="odoc-spec"><div class="spec parameter anchored" id="argument-1-H"><a href="#argument-1-H" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="argument-1-H/index.html">H</a></span><span> : <a href="../module-type-H/index.html">H</a></span></code></div></div><h2 id="signature"><a href="#signature" class="anchor"></a>Signature</h2><div class="odoc-spec"><div class="spec type anchored" id="type-key"><a href="#type-key" class="anchor"></a><code><span><span class="keyword">type</span> key</span><span> = <a href="argument-1-H/index.html#type-t">H.t</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sexp_of_t"><a href="#val-sexp_of_t" class="anchor"></a><code><span><span class="keyword">val</span> sexp_of_t : <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="optlabel">?destruct</span>:<span>(<span><span><span>(<a href="#type-key">key</a> * <span class="type-var">'a</span>)</span> <span class="xref-unresolved">Core</span>.Queue.t</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">max_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>create ?destruct ~max_size ()</code> returns a fresh cache that can store at most <code>max_size</code> bindings.</p><p>A binding is an association <code>(key, data)</code>. When an insertion would grow the cache beyond <code>max_size</code>, the least-recently-used bindings are evicted until the size constraint is satisfied.</p><p>If provided, <code>destruct</code> is invoked once for every batch of evicted bindings. It receives the bindings in LRU-to-MRU order wrapped in a <code>Core.Queue.t</code>. The queue can be safely traversed or drained by the callback. Exceptions raised by <code>destruct</code> are re-raised in the context of the operation that triggered the eviction so that callers can react (e.g. log, retry, abort).</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">destruct</span> <p>clean-up callback executed on every eviction or explicit removal. Optional.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">max_size</span> <p>upper bound on the number of bindings that may be stored. Must be non-negative. Zero disables caching entirely.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_alist"><a href="#val-to_alist" class="anchor"></a><code><span><span class="keyword">val</span> to_alist : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="#type-key">key</a> * <span class="type-var">'a</span>)</span> list</span></span></code></div><div class="spec-doc"><p><code>to_alist t</code> returns the contents of <code>t</code> as an association list ordered from the least-recently-used binding to the most-recently-used. The list is a snapshot â€“ it is not affected by subsequent cache mutations.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-length"><a href="#val-length" class="anchor"></a><code><span><span class="keyword">val</span> length : <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>length t</code> returns the current number of bindings.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_empty"><a href="#val-is_empty" class="anchor"></a><code><span><span class="keyword">val</span> is_empty : <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>is_empty t</code> is <code>true</code> iff <code>length t = 0</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-stats"><a href="#val-stats" class="anchor"></a><code><span><span class="keyword">val</span> stats : <span><span class="optlabel">?sexp_of_key</span>:<span>(<span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Core</span>.Sexp.t)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Core</span>.Sexp.t</span></code></div><div class="spec-doc"><p><code>stats ?sexp_of_key t</code> exposes internal statistics useful for debugging and testing. The resulting S-expression contains the current length, <code>max_size</code>, <a href="#val-hit_rate"><code>hit_rate</code></a>, and the list of cached keys. <code>sexp_of_key</code> allows callers to control the representation of keys in the output.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-max_size"><a href="#val-max_size" class="anchor"></a><code><span><span class="keyword">val</span> max_size : <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>max_size t</code> returns the current capacity. Use <a href="#val-set_max_size"><code>set_max_size</code></a> to modify it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hit_rate"><a href="#val-hit_rate" class="anchor"></a><code><span><span class="keyword">val</span> hit_rate : <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> float</span></code></div><div class="spec-doc"><p><code>hit_rate t</code> is the ratio of successful look-ups to total look-ups since <code>t</code> was created. A *look-up* is any call to <a href="#val-mem"><code>mem</code></a>, <a href="#val-find"><code>find</code></a>, or <a href="#val-find_and_remove"><code>find_and_remove</code></a>. The value is in the inclusive range <code>[0.; 1.]</code>.</p></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="xref-unresolved">Core</span>.Invariant.S1 <span class="keyword">with</span> <span><span class="keyword">type</span> <span>'a <span class="xref-unresolved">t</span></span> := <span><span class="type-var">'a</span> <span class="xref-unresolved">t</span></span></span></span></code></summary><div class="odoc-spec"><div class="spec value anchored" id="val-invariant"><a href="#val-invariant" class="anchor"></a><code><span><span class="keyword">val</span> invariant : <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Base__Invariant_intf</span>.inv</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="xref-unresolved">Base__Invariant_intf</span>.inv</span></span></code></div></div></details></div><h2 id="read-only-operations"><a href="#read-only-operations" class="anchor"></a>Read-only operations</h2><p>All read-only operations count as uses: they promote the accessed binding to the back of the internal LRU queue so that it is considered *most recently used*.</p><div class="odoc-spec"><div class="spec value anchored" id="val-mem"><a href="#val-mem" class="anchor"></a><code><span><span class="keyword">val</span> mem : <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>mem t key</code> is <code>true</code> iff <code>key</code> is present in <code>t</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find"><a href="#val-find" class="anchor"></a><code><span><span class="keyword">val</span> find : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>find t key</code> returns the data bound to <code>key</code>, or <code>None</code> if the key is absent.</p></div></div><h2 id="mutating-operations"><a href="#mutating-operations" class="anchor"></a>Mutating operations</h2><p>Mutations may evict bindings so that the cache respects its size constraint. All evictions happen *before* the corresponding function returns.</p><div class="odoc-spec"><div class="spec value anchored" id="val-clear"><a href="#val-clear" class="anchor"></a><code><span><span class="keyword">val</span> clear : <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>[ <span>`Dropped of int</span> ]</span></span></code></div><div class="spec-doc"><p><code>clear t</code> removes every binding from <code>t</code> and returns <code>`Dropped n</code> where <code>n</code> is the number of bindings that were present. The <code>destruct</code> callback is invoked once (if any bindings were present).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_max_size"><a href="#val-set_max_size" class="anchor"></a><code><span><span class="keyword">val</span> set_max_size : <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">max_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span>[ <span>`Dropped of int</span> ]</span></span></code></div><div class="spec-doc"><p><code>set_max_size t ~max_size</code> changes the capacity of <code>t</code> and immediately evicts bindings if the new capacity is smaller than <code>length t</code>. The result <code>`Dropped n</code> reports how many bindings were removed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span><span class="keyword">val</span> remove : <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span>[ `Ok <span>| `No_such_key</span> ]</span></span></code></div><div class="spec-doc"><p><code>remove t key</code> deletes <code>key</code> from <code>t</code> and returns:</p><ul><li><code>`Ok</code> â€“ the key was present and has been removed;</li><li><code>`No_such_key</code> â€“ no binding for <code>key</code> existed.</li></ul><p>When a binding is removed, <code>destruct</code> is invoked with a queue containing exactly that binding.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set"><a href="#val-set" class="anchor"></a><code><span><span class="keyword">val</span> set : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">key</span>:<a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">data</span>:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set t ~key ~data</code> adds the binding <code>(key, data)</code>. If <code>key</code> was already present its previous value is discarded (after the <code>destruct</code> callback). The binding is considered most-recently-used after the call.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_or_add"><a href="#val-find_or_add" class="anchor"></a><code><span><span class="keyword">val</span> find_or_add : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">default</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>find_or_add t key ~default</code> is equivalent to:</p><pre class="language-ocaml"><code>  match find t key with
  | Some v -&gt; v                       (* cache hit *)
  | None -&gt;                           (* cache miss *)
    let v = default () in
    set t ~key ~data:v;
    v</code></pre><p>The final value is returned to the caller. The binding is considered most-recently-used.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_and_remove"><a href="#val-find_and_remove" class="anchor"></a><code><span><span class="keyword">val</span> find_and_remove : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>find_and_remove t key</code> returns the data bound to <code>key</code> if present and immediately removes the binding. The call counts as a cache hit for the purpose of <a href="#val-hit_rate"><code>hit_rate</code></a>.</p></div></div></div></body></html>
