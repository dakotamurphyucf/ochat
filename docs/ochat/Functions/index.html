<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Functions (ochat.Functions)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../';
let search_urls = ['../db.js','../../sherlodoc.js'];
</script><script src="../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ochat</a> &#x00BB; Functions</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Functions</span></code></h1><p>Ready-made Ochat **tools** implemented on top of <a href="../Ochat_function/index.html" title="Ochat_function">Ochat_function</a>.</p><p>The values exposed by this module are *registrations* ‚Äì each one is the result of a call to <a href="../Ochat_function/index.html#val-create_function"><code>Ochat_function.create_function</code></a>. They can be mixed and matched freely when building the tool-list for <a href="../Openai/Completions/index.html#val-post_chat_completion"><code>Openai.Completions.post_chat_completion</code></a>:</p><pre class="language-ocaml"><code>  let tools, dispatch_tbl =
    Ochat_function.functions
      [ Functions.get_contents ~dir:cwd
      ; Functions.apply_patch  ~dir:cwd
      ; Functions.odoc_search  ~dir:cwd ~net
      ]</code></pre><p>All helpers are *side-effect free* until their <code>`run`</code> callback is executed; the required capabilities (filesystem directory, network handle, domain manager, ‚Ä¶) are injected explicitly via labelled arguments. This capability-style design makes the functions easy to reason about in a concurrent <code>`Eio`</code> application.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#categories">Categories</a></li><li><a href="#filesystem-helpers">Filesystem helpers</a></li><li><a href="#search-helpers">Search helpers</a></li><li><a href="#web-helper">Web helper</a></li><li><a href="#miscellaneous">Miscellaneous</a></li></ul></nav></div><div class="odoc-content"><h2 id="categories"><a href="#categories" class="anchor"></a>Categories</h2><p>‚Ä¢ Filesystem ‚Äì <a href="#val-get_contents" title="get_contents">get_contents</a>, <a href="#val-apply_patch" title="apply_patch">apply_patch</a>, <a href="#val-append_to_file" title="append_to_file">append_to_file</a>, <a href="#val-find_and_replace" title="find_and_replace">find_and_replace</a>, <a href="#val-read_dir" title="read_dir">read_dir</a>, <a href="#val-mkdir" title="mkdir">mkdir</a></p><p>‚Ä¢ Search ‚Äì <a href="#val-odoc_search" title="odoc_search">odoc_search</a>, <a href="#val-query_vector_db" title="query_vector_db">query_vector_db</a>, <a href="#val-markdown_search" title="markdown_search">markdown_search</a></p><p>‚Ä¢ Indexing ‚Äì <a href="#val-index_ocaml_code" title="index_ocaml_code">index_ocaml_code</a>, <a href="#val-index_markdown_docs" title="index_markdown_docs">index_markdown_docs</a></p><p>‚Ä¢ Web ‚Äì <a href="#val-get_url_content" title="get_url_content">get_url_content</a>, <a href="#val-webpage_to_markdown" title="webpage_to_markdown">webpage_to_markdown</a></p><div class="odoc-spec"><div class="spec value anchored" id="val-add_line_numbers"><a href="#val-add_line_numbers" class="anchor"></a><code><span><span class="keyword">val</span> add_line_numbers : <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Prefix each line of <code>text</code> with a 1-based line counter.</p><p>The helper is primarily used for pretty-printing code snippets in tool responses so that large fragments can be referred to unambiguously by the LLM (e.g. ‚Äúchange line 42‚Äù). No trailing newline is added.</p></div></div><h2 id="filesystem-helpers"><a href="#filesystem-helpers" class="anchor"></a>Filesystem helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-get_contents"><a href="#val-get_contents" class="anchor"></a><code><span><span class="keyword">val</span> get_contents : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`read_file`</code> tool.</p><p>‚Ä¢ **Schema** ‚Äì expects an argument object with:</p><ul><li><code>file</code> (string) ‚Äì path to read (preferred field);</li><li><code>path</code> (string) ‚Äì legacy alias accepted by the decoder;</li><li><code>offset</code> (int, optional) ‚Äì 0-based line offset to start reading from;</li><li><code>line_count</code> (int, optional) ‚Äì number of lines to return.</li></ul><p>‚Ä¢ **Behaviour** ‚Äì returns the UTF-8 contents of <code>`file`</code>, read via <code>Eio.Buf_read</code> with a fixed byte cap. The returned text is prefixed with a small metadata header of the form:</p><pre class="language-ocaml"><code> path:START-END:\n[total_lines=N]\n... </code></pre><p>The tool refuses to read binary files (best-effort heuristic) and returns a human-readable error message instead.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_url_content"><a href="#val-get_url_content" class="anchor"></a><code><span><span class="keyword">val</span> get_url_content : <span><span class="label">net</span>:<span><span class="type-var">_</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span> <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`get_url_content`</code> tool.</p><p>Downloads an HTTP resource using <a href="../Io/Net/index.html" title="Io.Net">Io.Net</a>, strips all HTML tags with <code>LambdaSoup</code>, and returns the visible text. Content larger than the current chat context window is not truncated automatically ‚Äì callers should post-process the string if necessary.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-index_ocaml_code"><a href="#val-index_ocaml_code" class="anchor"></a><code><span><span class="keyword">val</span> index_ocaml_code : 
  <span><span class="label">env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">net</span>:<span><span class="type-var">_</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`index_ocaml_code`</code> tool.</p><p>Recursively walks <code>folder_to_index</code> (argument) and builds a hybrid vector</p><ol><li>BM-25 index under <code>vector_db_folder</code>. The heavy lifting is delegated to <a href="../Indexer/index.html"><code>Indexer</code></a>. Progress reporting happens on stdout; the returned string is always <code>&quot;code has been indexed&quot;</code>.</li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-query_vector_db"><a href="#val-query_vector_db" class="anchor"></a><code><span><span class="keyword">val</span> query_vector_db : 
  <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">net</span>:<span><span class="type-var">_</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`query_vector_db`</code> tool.</p><p>Given a query string, combines OpenAI embeddings with a BM-25 overlay to search a pre-built index. The result is a Markdown list of code snippets wrapped in <code>```ocaml</code> fences. See <a href="../Vector_db/index.html#val-query_hybrid"><code>Vector_db.query_hybrid</code></a> for the scoring details.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-index_markdown_docs"><a href="#val-index_markdown_docs" class="anchor"></a><code><span><span class="keyword">val</span> index_markdown_docs : 
  <span><span class="label">env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`index_markdown_docs`</code> tool. Crawls a directory of Markdown files, chunks them into token‚Äìbounded windows, embeds the text with OpenAI, and writes a vector database under <code>.md_index/&lt;index_name&gt;</code>. The helper is a thin wrapper around <a href="../Markdown_indexer/index.html#val-index_directory"><code>Markdown_indexer.index_directory</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-markdown_search"><a href="#val-markdown_search" class="anchor"></a><code><span><span class="keyword">val</span> markdown_search : 
  <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">net</span>:<span><span class="type-var">_</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`markdown_search`</code> tool ‚Äì semantic search across Markdown indices previously created with <a href="#val-index_markdown_docs"><code>index_markdown_docs</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_patch"><a href="#val-apply_patch" class="anchor"></a><code><span><span class="keyword">val</span> apply_patch : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`apply_patch`</code> tool that applies a *Ochat diff* to the workspace rooted at <code>dir</code>. The helper is a thin wrapper around <a href="../Apply_patch/index.html#val-process_patch"><code>Apply_patch.process_patch</code></a>. It supports additions, deletions, in-place modifications, and file moves.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_dir"><a href="#val-read_dir" class="anchor"></a><code><span><span class="keyword">val</span> read_dir : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`read_directory`</code> tool. Returns the entry list of the given sub-directory without recursion.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mkdir"><a href="#val-mkdir" class="anchor"></a><code><span><span class="keyword">val</span> mkdir : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`mkdir`</code> tool. Creates the specified sub-directory with mode 0o700. The action is idempotent when the folder already exists.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-append_to_file"><a href="#val-append_to_file" class="anchor"></a><code><span><span class="keyword">val</span> append_to_file : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`append_to_file`</code> tool. Appends a string to a file, creating it if necessary. The input is a tuple of <code>file</code> and <code>text</code>. The action is idempotent when the text is already present at the end of the file.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_and_replace"><a href="#val-find_and_replace" class="anchor"></a><code><span><span class="keyword">val</span> find_and_replace : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`find_and_replace`</code> tool. Searches for a string in a file and replaces it with another string. The input is a tuple of <code>file</code>, <code>search</code>, <code>replace</code>, and a boolean <code>all</code> that controls whether all occurrences should be replaced or only the first one. The action is idempotent when the search string is not found or already replaced.</p></div></div><h2 id="search-helpers"><a href="#search-helpers" class="anchor"></a>Search helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-odoc_search"><a href="#val-odoc_search" class="anchor"></a><code><span><span class="keyword">val</span> odoc_search : 
  <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">net</span>:<span><span class="type-var">_</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`odoc_search`</code> tool ‚Äì a semantic search over locally indexed OCaml documentation. The tool embeds the textual query with OpenAI and performs cosine similarity against an <code>Owl</code> matrix of pre-computed snippet embeddings. Results are rendered in the same Markdown format as the original command-line utility bundled in this repository.</p></div></div><h2 id="web-helper"><a href="#web-helper" class="anchor"></a>Web helper</h2><div class="odoc-spec"><div class="spec value anchored" id="val-webpage_to_markdown"><a href="#val-webpage_to_markdown" class="anchor"></a><code><span><span class="keyword">val</span> webpage_to_markdown : 
  <span><span class="label">env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dir</span>:<span><span class="type-var">_</span> <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">net</span>:<span><span class="type-var">_</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`webpage_to_markdown`</code> tool that converts a remote web page to Markdown using a heuristic readability extractor. See <a href="../Webpage_markdown/Tool/index.html"><code>Webpage_markdown.Tool</code></a>. The environment capability <code>env</code> is used to access the host‚Äôs standard network stack and DNS.</p></div></div><h2 id="miscellaneous"><a href="#miscellaneous" class="anchor"></a>Miscellaneous</h2><div class="odoc-spec"><div class="spec value anchored" id="val-fork"><a href="#val-fork" class="anchor"></a><code><span><span class="keyword">val</span> fork : <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Placeholder registration for the <code>`fork`</code> tool. Its implementation is a stub and should never be called directly; it exists only so that the JSON schema can be advertised to the model.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-meta_refine"><a href="#val-meta_refine" class="anchor"></a><code><span><span class="keyword">val</span> meta_refine : <span><span class="label">env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span> <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Apply *Recursive Meta-Prompting* refinement to a raw prompt. The tool receives the full prompt in its JSON <code>prompt</code> field and returns the improved version produced by <a href="../Meta_prompting/Recursive_mp/index.html#val-refine"><code>Meta_prompting.Recursive_mp.refine</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-import_image"><a href="#val-import_image" class="anchor"></a><code><span><span class="keyword">val</span> import_image : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <a href="../Ochat_function/index.html#type-t">Ochat_function.t</a></span></code></div><div class="spec-doc"><p>Register the <code>`import_image`</code> tool.</p><p>The tool reads an image file from disk and returns a structured tool output payload containing a data-URI (base64) suitable for OpenAI ‚Äúimage input‚Äù parts.</p><p>If the file does not exist, a textual error is returned instead.</p></div></div></div></body></html>
