<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chatml_typechecker (ochat.Chatml_typechecker)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../';
let search_urls = ['../db.js','../../sherlodoc.js'];
</script><script src="../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ochat</a> &#x00BB; Chatml_typechecker</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chatml_typechecker</span></code></h1><p>Hindleyâ€“Milner type-checker for the ChatML language.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#overview">Overview</a></li></ul></nav></div><div class="odoc-content"><h2 id="overview"><a href="#overview" class="anchor"></a>Overview</h2><p>This module provides a self-contained Hindleyâ€“Milner (HM) type-checker for the <a href="../Chatml/Chatml_lang/index.html"><code>Chatml.Chatml_lang</code></a> abstract syntax tree. It performs full type inference with:</p><p>â€¢ classical `let`-polymorphism, â€¢ row-polymorphic records and variants, â€¢ first-class functions, arrays and references, â€¢ built-in support for a small prelude of primitives (see <a href="#val-init_env"><code>init_env</code></a>).</p><p>The checker is optional at runtimeâ€”the ChatML interpreter works fine without itâ€”but running it gives early feedback to users and enables richer editor tooling.</p><p>The public surface is intentionally tiny:</p><ul><li><a href="#val-infer_program"><code>infer_program</code></a> validates a parsed program and prints diagnostics.</li><li><a href="#val-type_lookup_for_program"><code>type_lookup_for_program</code></a> returns a lookup function that maps an arbitrary <a href="../Source/index.html#type-span"><code>Source.span</code></a> back to the principal type inferred for that AST node.</li></ul><p>Everything else in this file exists to implement the inference engine itself and is **not** part of the stable API.</p><p>---------------------------------------------------------------------</p><p>1. Utility environment (string maps).</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec module anchored" id="module-Env"><a href="#module-Env" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Env/index.html">Env</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><p>---------------------------------------------------------------------</p><p>2. Types and type variables</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec type anchored" id="type-name"><a href="#type-name" class="anchor"></a><code><span><span class="keyword">type</span> name</span><span> = string</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-typ"><a href="#type-typ" class="anchor"></a><code><span><span class="keyword">type</span> typ</span><span> = </span></code><ol><li id="type-typ.Fun" class="def variant constructor anchored"><a href="#type-typ.Fun" class="anchor"></a><code><span>| </span><span><span class="constructor">Fun</span> <span class="keyword">of</span> <span><a href="#type-typ">typ</a> list</span> * <a href="#type-typ">typ</a></span></code></li><li id="type-typ.Generic" class="def variant constructor anchored"><a href="#type-typ.Generic" class="anchor"></a><code><span>| </span><span><span class="constructor">Generic</span> <span class="keyword">of</span> <a href="#type-name">name</a></span></code></li><li id="type-typ.Var" class="def variant constructor anchored"><a href="#type-typ.Var" class="anchor"></a><code><span>| </span><span><span class="constructor">Var</span> <span class="keyword">of</span> <span><a href="#type-tv">tv</a> <span class="xref-unresolved">Core</span>.ref</span></span></code></li><li id="type-typ.Ref" class="def variant constructor anchored"><a href="#type-typ.Ref" class="anchor"></a><code><span>| </span><span><span class="constructor">Ref</span> <span class="keyword">of</span> <a href="#type-typ">typ</a></span></code></li><li id="type-typ.Record" class="def variant constructor anchored"><a href="#type-typ.Record" class="anchor"></a><code><span>| </span><span><span class="constructor">Record</span> <span class="keyword">of</span> <a href="#type-typ">typ</a></span></code></li><li id="type-typ.Variant" class="def variant constructor anchored"><a href="#type-typ.Variant" class="anchor"></a><code><span>| </span><span><span class="constructor">Variant</span> <span class="keyword">of</span> <a href="#type-typ">typ</a></span></code></li><li id="type-typ.Tuple" class="def variant constructor anchored"><a href="#type-typ.Tuple" class="anchor"></a><code><span>| </span><span><span class="constructor">Tuple</span> <span class="keyword">of</span> <span><a href="#type-typ">typ</a> list</span></span></code></li><li id="type-typ.Array" class="def variant constructor anchored"><a href="#type-typ.Array" class="anchor"></a><code><span>| </span><span><span class="constructor">Array</span> <span class="keyword">of</span> <a href="#type-typ">typ</a></span></code></li><li id="type-typ.TInt" class="def variant constructor anchored"><a href="#type-typ.TInt" class="anchor"></a><code><span>| </span><span><span class="constructor">TInt</span></span></code></li><li id="type-typ.TFloat" class="def variant constructor anchored"><a href="#type-typ.TFloat" class="anchor"></a><code><span>| </span><span><span class="constructor">TFloat</span></span></code></li><li id="type-typ.Number" class="def variant constructor anchored"><a href="#type-typ.Number" class="anchor"></a><code><span>| </span><span><span class="constructor">Number</span></span></code></li><li id="type-typ.Boolean" class="def variant constructor anchored"><a href="#type-typ.Boolean" class="anchor"></a><code><span>| </span><span><span class="constructor">Boolean</span></span></code></li><li id="type-typ.String" class="def variant constructor anchored"><a href="#type-typ.String" class="anchor"></a><code><span>| </span><span><span class="constructor">String</span></span></code></li><li id="type-typ.Row" class="def variant constructor anchored"><a href="#type-typ.Row" class="anchor"></a><code><span>| </span><span><span class="constructor">Row</span> <span class="keyword">of</span> <span><a href="#type-typ">typ</a> <a href="Env/index.html#type-t">Env.t</a></span> * <a href="#type-typ">typ</a></span></code></li><li id="type-typ.Empty_row" class="def variant constructor anchored"><a href="#type-typ.Empty_row" class="anchor"></a><code><span>| </span><span><span class="constructor">Empty_row</span></span></code></li><li id="type-typ.Unit" class="def variant constructor anchored"><a href="#type-typ.Unit" class="anchor"></a><code><span>| </span><span><span class="constructor">Unit</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-tv"><a href="#type-tv" class="anchor"></a><code><span><span class="keyword">and</span> tv</span><span> = </span></code><ol><li id="type-tv.Bound" class="def variant constructor anchored"><a href="#type-tv.Bound" class="anchor"></a><code><span>| </span><span><span class="constructor">Bound</span> <span class="keyword">of</span> <a href="#type-typ">typ</a></span></code></li><li id="type-tv.Free" class="def variant constructor anchored"><a href="#type-tv.Free" class="anchor"></a><code><span>| </span><span><span class="constructor">Free</span> <span class="keyword">of</span> <a href="#type-name">name</a> * int</span></code></li></ol></div></div><p>---------------------------------------------------------------------</p><p>3. Global state for the HM algorithm</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec value anchored" id="val-previous_id"><a href="#val-previous_id" class="anchor"></a><code><span><span class="keyword">val</span> previous_id : <span>int <span class="xref-unresolved">Core</span>.ref</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-current_id"><a href="#val-current_id" class="anchor"></a><code><span><span class="keyword">val</span> current_id : <span>int <span class="xref-unresolved">Core</span>.ref</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-current_lvl"><a href="#val-current_lvl" class="anchor"></a><code><span><span class="keyword">val</span> current_lvl : <span>int <span class="xref-unresolved">Core</span>.ref</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reset_levels"><a href="#val-reset_levels" class="anchor"></a><code><span><span class="keyword">val</span> reset_levels : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-enter_level"><a href="#val-enter_level" class="anchor"></a><code><span><span class="keyword">val</span> enter_level : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-exit_level"><a href="#val-exit_level" class="anchor"></a><code><span><span class="keyword">val</span> exit_level : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gensym"><a href="#val-gensym" class="anchor"></a><code><span><span class="keyword">val</span> gensym : <span>unit <span class="arrow">&#45;&gt;</span></span> string</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-span_key"><a href="#type-span_key" class="anchor"></a><code><span><span class="keyword">type</span> span_key</span><span> = int * int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compare_span_key"><a href="#val-compare_span_key" class="anchor"></a><code><span><span class="keyword">val</span> compare_span_key : <span><a href="#type-span_key">span_key</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-span_key">span_key</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-span_key_of_sexp"><a href="#val-span_key_of_sexp" class="anchor"></a><code><span><span class="keyword">val</span> span_key_of_sexp : <span><span class="xref-unresolved">Sexplib0</span>.Sexp.t <span class="arrow">&#45;&gt;</span></span> <a href="#type-span_key">span_key</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sexp_of_span_key"><a href="#val-sexp_of_span_key" class="anchor"></a><code><span><span class="keyword">val</span> sexp_of_span_key : <span><a href="#type-span_key">span_key</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash_fold_span_key"><a href="#val-hash_fold_span_key" class="anchor"></a><code><span><span class="keyword">val</span> hash_fold_span_key : 
  <span><span class="xref-unresolved">Ppx_hash_lib</span>.Std.Hash.state <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-span_key">span_key</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppx_hash_lib</span>.Std.Hash.state</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash_span_key"><a href="#val-hash_span_key" class="anchor"></a><code><span><span class="keyword">val</span> hash_span_key : <span><a href="#type-span_key">span_key</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppx_hash_lib</span>.Std.Hash.hash_value</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-span_to_key"><a href="#val-span_to_key" class="anchor"></a><code><span><span class="keyword">val</span> span_to_key : <span><a href="../Source/index.html#type-span">Source.span</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-span_key">span_key</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-SpanTbl"><a href="#module-SpanTbl" class="anchor"></a><code><span><span class="keyword">module</span> <a href="SpanTbl/index.html">SpanTbl</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-span_types"><a href="#val-span_types" class="anchor"></a><code><span><span class="keyword">val</span> span_types : <span><a href="#type-typ">typ</a> <a href="SpanTbl/index.html#type-t">SpanTbl.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reset_span_table"><a href="#val-reset_span_table" class="anchor"></a><code><span><span class="keyword">val</span> reset_span_table : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-record_span_type"><a href="#val-record_span_type" class="anchor"></a><code><span><span class="keyword">val</span> record_span_type : <span><a href="../Source/index.html#type-span">Source.span</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-lookup_span_type"><a href="#val-lookup_span_type" class="anchor"></a><code><span><span class="keyword">val</span> lookup_span_type : <span><a href="../Source/index.html#type-span">Source.span</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-typ">typ</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-new_var"><a href="#val-new_var" class="anchor"></a><code><span><span class="keyword">val</span> new_var : <span>int <span class="arrow">&#45;&gt;</span></span> <a href="#type-typ">typ</a></span></code></div></div><p>---------------------------------------------------------------------</p><p>4. Generalisation / instantiation</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec value anchored" id="val-instantiate"><a href="#val-instantiate" class="anchor"></a><code><span><span class="keyword">val</span> instantiate : <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-typ">typ</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-generalise"><a href="#val-generalise" class="anchor"></a><code><span><span class="keyword">val</span> generalise : <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-typ">typ</a></span></code></div><div class="spec-doc"><p>Generalisation We now adopt the same strategy that the Nox checker uses: all free type variables that were introduced at a deeper level than the current one are turned into universally-quantified (Generic) type variables.</p></div></div><p>---------------------------------------------------------------------</p><p>5. Row utilities</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec value anchored" id="val-merge_fields"><a href="#val-merge_fields" class="anchor"></a><code><span><span class="keyword">val</span> merge_fields : <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-typ">typ</a> <a href="Env/index.html#type-t">Env.t</a></span> * <a href="#type-typ">typ</a></span></code></div></div><p>---------------------------------------------------------------------</p><p>6. Occurs check</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec value anchored" id="val-occurs"><a href="#val-occurs" class="anchor"></a><code><span><span class="keyword">val</span> occurs : <span><span><a href="#type-tv">tv</a> <span class="xref-unresolved">Core</span>.ref</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Core__</span>.Import.bool</span></code></div></div><p>---------------------------------------------------------------------</p><p>7. Unification</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec exception anchored" id="exception-Type_error"><a href="#exception-Type_error" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Type_error</span> <span class="keyword">of</span> string</span></code></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-Type_error_with_loc"><a href="#exception-Type_error_with_loc" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Type_error_with_loc</span> <span class="keyword">of</span> string * <a href="../Source/index.html#type-span">Source.span</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-unify"><a href="#val-unify" class="anchor"></a><code><span><span class="keyword">val</span> unify : <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-unify_rows"><a href="#val-unify_rows" class="anchor"></a><code><span><span class="keyword">val</span> unify_rows : <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><p>---------------------------------------------------------------------</p><p>8. Pretty printer for types (used in error messages)</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec value anchored" id="val-show_type"><a href="#val-show_type" class="anchor"></a><code><span><span class="keyword">val</span> show_type : <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-name">name</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-show_row"><a href="#val-show_row" class="anchor"></a><code><span><span class="keyword">val</span> show_row : <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div></div><p>---------------------------------------------------------------------</p><p>9. Typing environment</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec type anchored" id="type-scheme"><a href="#type-scheme" class="anchor"></a><code><span><span class="keyword">type</span> scheme</span><span> = <a href="#type-typ">typ</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-tenv"><a href="#type-tenv" class="anchor"></a><code><span><span class="keyword">type</span> tenv</span><span> = <span><span><a href="#type-scheme">scheme</a> <a href="Env/index.html#type-t">Env.t</a></span> <span class="xref-unresolved">Core</span>.ref</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init_env"><a href="#val-init_env" class="anchor"></a><code><span><span class="keyword">val</span> init_env : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="#type-tenv">tenv</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-lookup"><a href="#val-lookup" class="anchor"></a><code><span><span class="keyword">val</span> lookup : <span><span><span><span>(string, <a href="#type-typ">typ</a>, <span class="type-var">'a</span>)</span> <span class="xref-unresolved">Core</span>.Map.t</span> <span class="xref-unresolved">Core</span>.ref</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-typ">typ</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add"><a href="#val-add" class="anchor"></a><code><span><span class="keyword">val</span> add : 
  <span><span><span><span>(<span class="xref-unresolved">Core</span>.String.Map.Key.t, <a href="#type-typ">typ</a>, <span class="xref-unresolved">Core</span>.String.Map.Key.comparator_witness)</span>
    <span class="xref-unresolved">Core</span>.Map.t</span>
    <span class="xref-unresolved">Core</span>.ref</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Core</span>.String.Map.Key.t <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-typ">typ</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><p>---------------------------------------------------------------------</p><p>10. Inference â€“ expressions</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec value anchored" id="val-infer_expr"><a href="#val-infer_expr" class="anchor"></a><code><span><span class="keyword">val</span> infer_expr : 
  <span><span><span><span>(<span class="xref-unresolved">Core</span>.String.Map.Key.t, <a href="#type-scheme">scheme</a>, <span class="xref-unresolved">Core</span>.String.Map.Key.comparator_witness)</span>
    <span class="xref-unresolved">Core</span>.Map.t</span>
    <span class="xref-unresolved">Core</span>.ref</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Chatml/Chatml_lang/index.html#type-expr">Chatml.Chatml_lang.expr</a> <a href="../Chatml/Chatml_lang/index.html#type-node">Chatml.Chatml_lang.node</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-scheme">scheme</a></span></code></div></div><p>---------------------------------------------------------------------</p><p>11. Inference â€“ statements</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec value anchored" id="val-infer_stmt"><a href="#val-infer_stmt" class="anchor"></a><code><span><span class="keyword">val</span> infer_stmt : 
  <span><span><span><span>(<span class="xref-unresolved">Core</span>.String.Map.Key.t, <a href="#type-scheme">scheme</a>, <span class="xref-unresolved">Core</span>.String.Map.Key.comparator_witness)</span>
    <span class="xref-unresolved">Core</span>.Map.t</span>
    <span class="xref-unresolved">Core</span>.ref</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Chatml/Chatml_lang/index.html#type-stmt">Chatml.Chatml_lang.stmt</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Core__</span>.Import.unit</span></code></div></div><p>---------------------------------------------------------------------</p><p>12. Entry point</p><p>---------------------------------------------------------------------</p><div class="odoc-spec"><div class="spec value anchored" id="val-infer_program"><a href="#val-infer_program" class="anchor"></a><code><span><span class="keyword">val</span> infer_program : <span><a href="../Chatml/Chatml_lang/index.html#type-program">Chatml.Chatml_lang.program</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>infer_program prog</code> runs the HM type-checker on <code>prog</code>.</p><p>All mutable checker state (identifier counters, levels and the span table) is reset before starting so the function can be called repeatedly on independent programs.</p><p>Successful runs print <code>&quot;Type checking succeeded!&quot;</code> to standard output. When a type error is detected the function catches the internal exception, produces a human-readable diagnostic that includes a source excerpt, and prints it; the exception does *not* escape the function boundary.</p><p>The global <a href="#val-span_types"><code>span_types</code></a> table is populated during the traversal; it can later be queried through <a href="#val-type_lookup_for_program"><code>type_lookup_for_program</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-type_lookup_for_program"><a href="#val-type_lookup_for_program" class="anchor"></a><code><span><span class="keyword">val</span> type_lookup_for_program : 
  <span><a href="../Chatml/Chatml_lang/index.html#type-program">Chatml.Chatml_lang.program</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Source/index.html#type-span">Source.span</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-typ">typ</a> option</span></span></code></div><div class="spec-doc"><p><code>type_lookup_for_program prog</code> returns a lookup closure for <code>prog</code>.</p><p>Internally the function first clears the span table, runs <a href="#val-infer_program"><code>infer_program</code></a> (silencing any error so that lookup still works on ill-typed programs) and takes a snapshot of the resulting mapping.</p><p>The returned function takes a <a href="../Source/index.html#type-span"><code>Source.span</code></a> and returns <code>Some ty</code> when a principal type could be inferred for the node spanning <code>span</code>, or <code>None</code> otherwise.</p><p>The snapshot is immutableâ€”subsequent calls to <a href="#val-infer_program"><code>infer_program</code></a> will not affect the closure.</p></div></div></div></body></html>
