<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Apply_patch (ochat.Apply_patch)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../';
let search_urls = ['../db.js','../../sherlodoc.js'];
</script><script src="../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ochat</a> &#x00BB; Apply_patch</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Apply_patch</span></code></h1><p>Multi-file patch application (OCaml port of OpenAI‚Äôs reference ¬´apply_patch¬ª helper).</p><p>This module parses patch descriptions in the ‚ÄúOchat diff‚Äù flavour and applies them to an arbitrary workspace via user-provided callback functions. The implementation is a near-literal rewrite of the reference Python/TypeScript code into OCaml with some additional Unicode‚Äìcanonicalisation tweaks. It is completely side-effect free apart from the functions you pass in ‚Äì *all* I/O happens through those callbacks. Consequently the module works equally well on a real file-system, an in-memory map (see <code>./test/apply_patch_test.ml</code>), or any other storage backend.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#patch-format">Patch format</a></li><li><a href="#public-interface">Public interface</a></li></ul></nav></div><div class="odoc-content"><h2 id="patch-format"><a href="#patch-format" class="anchor"></a>Patch format</h2><p>The expected syntax is a simplified, but multi-file capable, diff inspired by `git apply`. A patch starts with</p><pre>*** Begin Patch</pre><p>and must be terminated by</p><pre>*** End Patch</pre><p>In between, a sequence of *file sections* follows. The declarative keywords recognised are:</p><p>‚Ä¢ </p><pre class="language-ocaml"><code>*** Add File: &lt;path&gt;</code></pre><p>‚Ä¢ </p><pre class="language-ocaml"><code>*** Delete File: &lt;path&gt;</code></pre><p>‚Ä¢ </p><pre class="language-ocaml"><code>*** Update File: &lt;path&gt;</code></pre><p>‚Ä¢ (optional) </p><pre class="language-ocaml"><code>*** Move to: &lt;new-path&gt;</code></pre><p>‚Äì only valid directly after an <code>Update File</code> line.</p><p>An *update* section contains one or more unified-diff hunks marked by `@@` pairs. Context matching is fuzzy: the algorithm tolerates trailing whitespace differences, ASCII/Unicode punctuation mismatches (e.g. fancy quotes vs straight quotes), and can search the whole file if the exact line numbers drifted. The amount of deviation encountered is returned as the second component of <code>text_to_patch</code> for debugging.</p><h2 id="public-interface"><a href="#public-interface" class="anchor"></a>Public interface</h2><p>The library purposefully exposes only a single high-level helper besides the <code>Diff_error</code> exception ‚Äì everything else is considered private implementation detail. If you need lower-level access (e.g. to instrument commits) please open a feature request instead of relying on the internal types.</p><div class="odoc-spec"><div class="spec exception anchored" id="exception-Diff_error"><a href="#exception-Diff_error" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Diff_error</span> <span class="keyword">of</span> string</span></code></div><div class="spec-doc"><p>Raised when the patch is malformed or cannot be applied to the provided workspace. The payload describes the first error that was encountered.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-process_patch"><a href="#val-process_patch" class="anchor"></a><code><span><span class="keyword">val</span> process_patch : 
  <span><span class="label">text</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">open_fn</span>:<span>(<span>string <span class="arrow">&#45;&gt;</span></span> string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">write_fn</span>:<span>(<span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">remove_fn</span>:<span>(<span>string <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  string</span></code></div><div class="spec-doc"><p><code>process_patch ~text ~open_fn ~write_fn ~remove_fn</code> applies the multi-file patch <code>text</code> to the workspace.</p><p>The three callback functions abstract over the backing storage:</p><p>‚Ä¢ <code>open_fn path</code> must return the current contents of <code>path</code>. It is called for every file that is updated or deleted.</p><p>‚Ä¢ <code>write_fn path contents</code> is invoked for each newly added file or updated destination. When a file is renamed the *destination* path is passed.</p><p>‚Ä¢ <code>remove_fn path</code> must delete <code>path</code> from the workspace. It is called for every <code>Delete</code> action and for the *source* path of a rename.</p><p>On success the function returns the string </p><pre class="language-ocaml"><code>'Done!'</code></pre><p>. If any problem occurs a <a href="#exception-Diff_error"><code>Diff_error</code></a> is raised explaining the issue.</p></div></div></div></body></html>
