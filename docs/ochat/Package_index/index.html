<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Package_index (ochat.Package_index)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../';
let search_urls = ['../db.js','../../sherlodoc.js'];
</script><script src="../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ochat</a> &#x00BB; Package_index</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Package_index</span></code></h1><p>Package-level semantic search index using OpenAI embeddings.</p><p>This module keeps a small vector store mapping OPAM package names to the embedding of a short text blurb describing the package. It is intended to be used as a *coarse* first-stage filter when searching a large ODoc index: we score the similarity between the user query and each package blurb and keep only the top packages for the more expensive document-level search.</p><p>The index is â€¢ built once from a list of <code>(package, blurb)</code> pairs obtained when the documentation is generated, â€¢ persisted to disk in binary protocol format, and â€¢ queried at run time entirely in-memory.</p><p>All heavy lifting is delegated to the OpenAI embeddings end-point and the Owl library for basic linear-algebra operations. The vectors are Lâ‚‚-normalised so that the dot product is equal to cosine similarity.</p><p>The public interface purposefully exposes only the operations needed by the rest of the code-base; callers are not expected to inspect or mutate the vectors directly.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#building">Building</a></li><li><a href="#query">Query</a></li><li><a href="#persistence">Persistence</a></li></ul></nav></div><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-Entry"><a href="#module-Entry" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Entry/index.html">Entry</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <span><a href="Entry/index.html#type-t">Entry.t</a> array</span></span></code></div><div class="spec-doc"><p>The in-memory index. Each element is an <a href="Entry/index.html#type-t"><code>Entry.t</code></a>; the array is kept sorted in build order (which is irrelevant for queries).</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-path"><a href="#type-path" class="anchor"></a><code><span><span class="keyword">type</span> path</span><span> = <span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span></span></code></div><div class="spec-doc"><p>A convenient alias for an Eio file-system path that is already known to be a directory.</p></div></div><h2 id="building"><a href="#building" class="anchor"></a>Building</h2><div class="odoc-spec"><div class="spec value anchored" id="val-build"><a href="#val-build" class="anchor"></a><code><span><span class="keyword">val</span> build : <span><span class="label">net</span>:<span><span class="type-var">'a</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">descriptions</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>build ~net ~descriptions</code> contacts the OpenAI embeddings API and builds an index from <code>descriptions</code>. Each pair <code>(pkg, blurb)</code> should contain an OPAM package name and a short description (the first paragraph of its README or documentation usually works well).</p><p>The function blocks the calling fibre while the HTTP request is made and therefore must be run inside an Eio event loop. The returned vectors are Lâ‚‚-normalised.</p></div></div><h2 id="query"><a href="#query" class="anchor"></a>Query</h2><div class="odoc-spec"><div class="spec value anchored" id="val-query"><a href="#val-query" class="anchor"></a><code><span><span class="keyword">val</span> query : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">embedding</span>:<span>float array</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">k</span>:int <span class="arrow">&#45;&gt;</span></span> <span>string list</span></span></code></div><div class="spec-doc"><p><code>query t ~embedding ~k</code> returns at most <code>k</code> package names ranked by decreasing cosine similarity between <code>embedding</code> and the vectors stored in <code>t</code>.</p><p>The <code>embedding</code> MUST already be Lâ‚‚-normalised.</p><p>The result list contains package names only â€“ duplicates are not possible.</p></div></div><h2 id="persistence"><a href="#persistence" class="anchor"></a>Persistence</h2><div class="odoc-spec"><div class="spec value anchored" id="val-save"><a href="#val-save" class="anchor"></a><code><span><span class="keyword">val</span> save : <span><span class="label">dir</span>:<a href="#type-path">path</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>save ~dir t</code> writes <code>t</code> to <code>dir/package_index.binio</code> using <a href="../Bin_prot_utils_eio/index.html"><code>Bin_prot_utils_eio</code></a>. The file is created or truncated.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-load"><a href="#val-load" class="anchor"></a><code><span><span class="keyword">val</span> load : <span><span class="label">dir</span>:<a href="#type-path">path</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> option</span></span></code></div><div class="spec-doc"><p><code>load ~dir</code> attempts to read <code>dir/package_index.binio</code>. It returns <code>Some idx</code> on success or <code>None</code> if the file does not exist or is unreadable.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-build_and_save"><a href="#val-build_and_save" class="anchor"></a><code><span><span class="keyword">val</span> build_and_save : 
  <span><span class="label">net</span>:<span><span class="type-var">'a</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">descriptions</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dir</span>:<a href="#type-path">path</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>build_and_save ~net ~descriptions ~dir</code> is a convenience wrapper that simply calls <a href="#val-build"><code>build</code></a> and then <a href="#val-save"><code>save</code></a>. The freshly built index is also returned to the caller.</p></div></div></div></body></html>
