<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Markdown_snippet (ochat.Markdown_snippet)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../';
let search_urls = ['../db.js','../../sherlodoc.js'];
</script><script src="../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ochat</a> &#x00BB; Markdown_snippet</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Markdown_snippet</span></code></h1><p>Token-bounded slicing of arbitrary Markdown documents.</p><p>This module provides a single high-level function <a href="#val-slice"><code>slice</code></a> that breaks a Markdown buffer into overlapping windows that respect the token limits of common embedding models (OpenAI Ada, etc.). It is primarily used by the markdown-indexing pipeline but can be reused in any context where large documents need to be chunked before vectorisation.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#metadata">Metadata</a></li><li><a href="#chunking-strategy">Chunking strategy</a></li><li><a href="#thread-safety-&amp;-performance">Thread safety &amp; performance</a><ul><li><a href="#example">Example</a></li></ul></li></ul></nav></div><div class="odoc-content"><h2 id="metadata"><a href="#metadata" class="anchor"></a>Metadata</h2><p>Each slice comes with an accompanying <a href="Meta/index.html"><code>Meta</code></a> record describing its provenance. Values are stable under serialisation via <span class="xref-unresolved" title="Core.Sexp.sexp_of_t">S-expressions</span> and <span class="xref-unresolved" title="Bin_prot">Bin_prot</span> thanks to the <code>@@deriving</code> annotations in the implementation.</p><p>The <a href="Meta/index.html#type-t.id"><code>Meta.t.id</code></a> field is a deterministic MD5 hash of the *header* prepended to the slice plus the slice body itself. It can therefore be used as a primary key for deduplication across indexing runs.</p><h2 id="chunking-strategy"><a href="#chunking-strategy" class="anchor"></a>Chunking strategy</h2><p>â€¢ Target size : 64 â‰¤ tokens â‰¤ 320. â€¢ Overlap : 64 tokens (â‰ˆ 20 %). â€¢ Split points : ATX headings, thematic breaks (&quot;---&quot;, &quot;***&quot;, &quot;___&quot;), blank lines, fenced code fences, and GitHub-flavoured table rows.</p><p>The heavy lifting is done in an internal <code>Chunker</code> module. Entire code fences and tables are preserved â€“ they will never be broken across slice boundaries.</p><h2 id="thread-safety-&amp;-performance"><a href="#thread-safety-&amp;-performance" class="anchor"></a>Thread safety &amp; performance</h2><p>Token counting relies on <a href="../Tikitoken/index.html" title="Tikitoken">Tikitoken</a>. Calls are accelerated by a process-wide, <code>5000</code>-entry <a href="../Lru_cache/index.html"><code>Lru_cache</code></a>, guarded by an <code>Eio.Mutex</code>. All exposed functions are therefore safe to invoke concurrently from multiple fibres.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Meta"><a href="#module-Meta" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Meta/index.html">Meta</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-slice"><a href="#val-slice" class="anchor"></a><code><span><span class="keyword">val</span> slice : 
  <span><span class="label">index_name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">doc_path</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">markdown</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">tiki_token_bpe</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="Meta/index.html#type-t">Meta.t</a> * string)</span> list</span></span></code></div></div><p><code>slice ~index_name ~doc_path ~markdown ~tiki_token_bpe ()</code> returns a list of token-bounded slices.</p><p>Each element <code>(meta, text)</code> consists of the slice body <code>text</code> prefixed by a short OCaml comment header plus its corresponding <a href="Meta/index.html#type-t"><code>Meta.t</code></a> meta-data.</p><p>The function guarantees:</p><p>â€¢ <code>text</code> length in tokens lies within the inclusive range <b>64 â€“ 320</b> unless the document itself is shorter. â€¢ Consecutive slices overlap by 64 tokens to preserve context. â€¢ No slice breaks inside fenced code blocks or GitHub-style tables.</p><p>The header injected at the top of every slice encodes provenance in a machine-parsable form:</p><pre>(** Package:&lt;index_name&gt; Doc:&lt;doc_path&gt; Lines:&lt;line_start&gt;-&lt;line_end&gt; *)</pre><p>The function is deterministic: repeated invocations with identical inputs (including the <code>tiki_token_bpe</code> vocabulary) yield byte-identical output.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">index_name</span> <p>Logical name of the index (e.g. project slug). Used in the header and <a href="Meta/index.html#type-t.index"><code>Meta.t.index</code></a>.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">doc_path</span> <p>Relative file path of the source Markdown document.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">markdown</span> <p>Full contents of the Markdown file (UTF-8).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">tiki_token_bpe</span> <p>Contents of a TikToken BPE vocabulary file. The codec is cached and reused across calls.</p></li></ul><ul class="at-tags"><li class="returns"><span class="at-tag">returns</span> <p>Ordered list of slices, top-to-bottom.</p></li></ul><h3 id="example"><a href="#example" class="anchor"></a>Example</h3><pre class="language-ocaml"><code>  let tiki_bpe = In_channel.read_all &quot;ochat4.tiktoken&quot; in
  let markdown = In_channel.read_all &quot;README.md&quot; in
  let slices = Markdown_snippet.slice
    ~index_name:&quot;my-project&quot;
    ~doc_path:&quot;README.md&quot;
    ~markdown
    ~tiki_token_bpe:tiki_bpe
    ()
  in
  List.iter slices ~f:(fun (meta, txt) -&gt;
    printf &quot;%s\n---\n%!&quot; (Sexp.to_string_hum (Meta.sexp_of_t meta));
    printf &quot;%s\n&quot; txt)</code></pre></div></body></html>
