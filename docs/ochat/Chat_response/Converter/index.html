<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Converter (ochat.Chat_response.Converter)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Chat_response</a> &#x00BB; Converter</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Chat_response.Converter</span></code></h1><p>ChatMarkdown â†’ OpenAI JSON conversion.</p><p>The module translates the *Abstract-Syntax Tree* produced by <a href="../../Prompt/Chat_markdown/index.html"><code>Prompt.Chat_markdown</code></a> into the value types exposed by <a href="../../Openai/Responses/index.html"><code>Openai.Responses</code></a>. The generated OCaml structures serialise to the exact JSON shape expected by the OpenAI Assistant and Chat Completions endpoints.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#side-effects">Side-effects</a></li><li><a href="#design-choices">Design choices</a></li><li><a href="#example">Example</a></li></ul></nav></div><div class="odoc-content"><h2 id="side-effects"><a href="#side-effects" class="anchor"></a>Side-effects</h2><p>The conversion itself is pure with two explicit exceptions:</p><p>â€¢ <a href="../Fetch/index.html#val-get"><code>Fetch.get</code></a>/ <a href="../Fetch/index.html#val-get_html"><code>Fetch.get_html</code></a> may be invoked when a content item references an external document or image. â€¢ `<a href="../Cache/index.html#val-find_or_add"><code>Cache.find_or_add</code></a>` is used to memoise nested `&lt;agent/&gt;` calls so that identical prompts are only executed once per session.</p><p>Both operations depend on the immutable execution context <a href="../Ctx/index.html#type-t"><code>Ctx.t</code></a> passed to every helper.</p><h2 id="design-choices"><a href="#design-choices" class="anchor"></a>Design choices</h2><p>â€¢ The public interface is intentionally tiny: <a href="#val-to_items"><code>to_items</code></a> is the single entry-point. Internal helpers are kept hidden to allow for future refactors without breaking callers.</p><p>â€¢ A first-class callback <code>~run_agent</code> is threaded through the call-graph to avoid a static dependency on <a href="../Driver/index.html"><code>Driver</code></a>. This keeps the compilation unit free of cycles.</p><h2 id="example"><a href="#example" class="anchor"></a>Example</h2><pre class="language-ocaml"><code>  let ctx = Ctx.create ~env ~dir ~cache in
  (* Delegate actual assistant invocation to Driver.run_agent *)
  let run_agent ~ctx prompt_xml inline_items =
    Driver.run_agent ~ctx prompt_xml inline_items
  in
  let items : Openai.Responses.Item.t list =
    Converter.to_items ~ctx ~run_agent parsed_elements</code></pre><div class="odoc-spec"><div class="spec module anchored" id="module-CM"><a href="#module-CM" class="anchor"></a><code><span><span class="keyword">module</span> CM</span><span> = <a href="../../Prompt/Chat_markdown/index.html">Prompt.Chat_markdown</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Res"><a href="#module-Res" class="anchor"></a><code><span><span class="keyword">module</span> Res</span><span> = <a href="../../Openai/Responses/index.html">Openai.Responses</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-ctx"><a href="#type-ctx" class="anchor"></a><code><span><span class="keyword">type</span> <span>'env ctx</span></span><span> = <span><span class="type-var">'env</span> <a href="../Ctx/index.html#type-t">Ctx.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-string_of_items"><a href="#val-string_of_items" class="anchor"></a><code><span><span class="keyword">val</span> string_of_items : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">run_agent</span>:
    <span>(<span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span>string <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  string</span></code></div><div class="spec-doc"><p><code>string_of_items ~ctx ~run_agent items</code> concatenates <code>items</code> into a plain UTF-8 string.</p><p>Each element of <code>items</code> is rendered according to the following rules:</p><p>â€¢ Inline images â€“ converted to `&lt;img src=&quot;â€¦&quot;/&gt;` tags so that the assistant can reason about them. â€¢ Local references â€“ resolved relative to <code>Ctx.dir ctx</code> and inlined into the prompt when possible. â€¢ Nested <code>`&lt;agent/&gt;`</code>(https://github.com/benchlab/chatmarkdown#agent) â€“ executed through the user-supplied <code>~run_agent</code> callback and cached (see <a href="../Cache/index.html"><code>Cache</code></a>).</p><p>The helper is private but centralised here so that both *input* message construction and *function-call* argument serialisation share the exact same rendering logic.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-convert_basic_item"><a href="#val-convert_basic_item" class="anchor"></a><code><span><span class="keyword">val</span> convert_basic_item : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Prompt/Chat_markdown/index.html#type-basic_content_item">CM.basic_content_item</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../Openai/Responses/Input_message/index.html#type-content_item">Res.Input_message.content_item</a></span></code></div><div class="spec-doc"><p><code>convert_basic_item ~ctx b</code> converts a <a href="../../Prompt/Chat_markdown/index.html#type-basic_content_item"><code>Prompt.Chat_markdown.basic_content_item</code></a> into a <a href="../../Openai/Responses/Input_message/index.html#type-content_item"><code>Openai.Responses.Input_message.content_item</code></a>.</p><p>Behaviour matrix:</p><p>| ChatMarkdown attributes | OpenAI output | |------------------------------------------------------|---------------| | `image_url` present | `Image` with `detail = &quot;auto&quot;` | | `document_url` present and <code>`cleanup_html`</code> is `true` | `Text` where the HTML has been stripped with <a href="../Fetch/index.html#val-get_html"><code>Fetch.get_html</code></a>. | | `document_url` present and <code>`cleanup_html`</code>=`false` | `Text` containing the raw document fetched with <a href="../Fetch/index.html#val-get"><code>Fetch.get</code></a>. | | No URL attributes | `Text` built from <code>`text`</code> (defaults to the empty string). |</p><p>Local paths are converted to data-URIs through <a href="../../Io/Base64/index.html#val-file_to_data_uri"><code>Io.Base64.file_to_data_uri</code></a> so that the resulting JSON can be sent verbatim to OpenAI without further processing.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-convert_content_item"><a href="#val-convert_content_item" class="anchor"></a><code><span><span class="keyword">val</span> convert_content_item : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">run_agent</span>:
    <span>(<span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span>string <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../Openai/Responses/Input_message/index.html#type-content_item">Res.Input_message.content_item</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-convert_msg"><a href="#val-convert_msg" class="anchor"></a><code><span><span class="keyword">val</span> convert_msg : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">run_agent</span>:
    <span>(<span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span>string <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Prompt/Chat_markdown/index.html#type-msg">CM.msg</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../Openai/Responses/Item/index.html#type-t">Res.Item.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-convert_system_msg"><a href="#val-convert_system_msg" class="anchor"></a><code><span><span class="keyword">val</span> convert_system_msg : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">run_agent</span>:
    <span>(<span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span>string <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Prompt/Chat_markdown/index.html#type-system_msg">CM.system_msg</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../Openai/Responses/Item/index.html#type-t">Res.Item.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-convert_developer_msg"><a href="#val-convert_developer_msg" class="anchor"></a><code><span><span class="keyword">val</span> convert_developer_msg : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">run_agent</span>:
    <span>(<span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span>string <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Prompt/Chat_markdown/index.html#type-developer_msg">CM.developer_msg</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../Openai/Responses/Item/index.html#type-t">Res.Item.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-convert_user_msg"><a href="#val-convert_user_msg" class="anchor"></a><code><span><span class="keyword">val</span> convert_user_msg : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">run_agent</span>:
    <span>(<span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span>string <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Prompt/Chat_markdown/index.html#type-user_msg">CM.user_msg</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../Openai/Responses/Item/index.html#type-t">Res.Item.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-convert_assistant_msg"><a href="#val-convert_assistant_msg" class="anchor"></a><code><span><span class="keyword">val</span> convert_assistant_msg : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">run_agent</span>:
    <span>(<span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span>string <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Prompt/Chat_markdown/index.html#type-assistant_msg">CM.assistant_msg</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../Openai/Responses/Item/index.html#type-t">Res.Item.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-convert_tool_call_msg"><a href="#val-convert_tool_call_msg" class="anchor"></a><code><span><span class="keyword">val</span> convert_tool_call_msg : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">run_agent</span>:
    <span>(<span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span>string <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Prompt/Chat_markdown/index.html#type-tool_call_msg">CM.tool_call_msg</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../Openai/Responses/Item/index.html#type-t">Res.Item.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-convert_tool_response_msg"><a href="#val-convert_tool_response_msg" class="anchor"></a><code><span><span class="keyword">val</span> convert_tool_response_msg : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">run_agent</span>:
    <span>(<span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span>string <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Prompt/Chat_markdown/index.html#type-tool_response_msg">CM.tool_response_msg</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../Openai/Responses/Item/index.html#type-t">Res.Item.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-convert_reasoning"><a href="#val-convert_reasoning" class="anchor"></a><code><span><span class="keyword">val</span> convert_reasoning : <span><a href="../../Prompt/Chat_markdown/index.html#type-reasoning">CM.reasoning</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Openai/Responses/Item/index.html#type-t">Res.Item.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_items"><a href="#val-to_items" class="anchor"></a><code><span><span class="keyword">val</span> to_items : 
  <span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">run_agent</span>:
    <span>(<span><span class="label">ctx</span>:<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <a href="../Ctx/index.html#type-t">Ctx.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span>string <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../Prompt/Chat_markdown/index.html#type-content_item">CM.content_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Prompt/Chat_markdown/index.html#type-top_level_elements">CM.top_level_elements</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Openai/Responses/Item/index.html#type-t">Res.Item.t</a> list</span></span></code></div><div class="spec-doc"><p><code>to_items ~ctx ~run_agent els</code> walks the ChatMarkdown document and produces the list of <a href="../../Openai/Responses/Item/index.html#type-t"><code>Openai.Responses.Item.t</code></a> that forms the request history.</p><p>The traversal is *total*: every constructor of <a href="../../Prompt/Chat_markdown/index.html#type-top_level_elements"><code>Prompt.Chat_markdown.top_level_elements</code></a> is handled. Elements that are processed elsewhere in the pipeline â€“ namely <code>`&lt;config/&gt;`</code> and <code>`&lt;tool/&gt;`</code> declarations â€“ are silently ignored.</p><p>Invariants: â€¢ The output list preserves the order of appearance. â€¢ No item is mutated after creation; the resulting value can therefore be shared between fibres.</p><p>Example â€“ converting a small prompt:</p><pre class="language-ocaml"><code>  let open Prompt.Chat_markdown in
  let doc =
    [ Msg { role = &quot;user&quot;; content = Some (Text &quot;Hello!&quot;); id = None
           ; status = None; tool_call_id = None; tool_call = None }
    ; Assistant { role = &quot;assistant&quot;; content = Some (Text &quot;Hi!&quot;)
                 ; id = None; status = None; tool_call_id = None }
    ]
  in
  let ctx = Ctx.create ~env ~dir ~cache in
  let items = Converter.to_items ~ctx ~run_agent doc in
  assert (List.length items = 2)</code></pre></div></div></div></body></html>
