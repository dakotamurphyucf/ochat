<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Io (ochat.Io)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../';
let search_urls = ['../db.js','../../sherlodoc.js'];
</script><script src="../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ochat</a> &#x00BB; Io</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Io</span></code></h1><p>IO convenience helpers built on top of <span class="xref-unresolved" title="Eio">Eio</span>.</p><p>This module gathers a set of small but often-needed utilities that are scattered throughout the Ochat code-base:</p><p>â€¢ Filesystem helpers (<code>save_doc</code>, <code>append_doc</code>, etc.) to treat paths as first-class capabilities, in the spirit of Eio. â€¢ Simple logging helpers (both file-based and console). â€¢ Small wrappers around <span class="xref-unresolved" title="Cohttp_eio">Cohttp_eio</span> for HTTP interactions in <a href="Net/index.html" title="Net">Net</a>. â€¢ A minimal worker pool abstraction in <a href="Task_pool/index.html"><code>Task_pool</code></a> that demonstrates how to combine <code>Eio.Stream</code> with <code>Eio.Domain_manager</code>. â€¢ Reference echo-server / client implementations useful for tests. â€¢ A helper to embed local images as Base-64 data-URIs.</p><p>All functions expose explicit capabilities instead of relying on ambient authority, making them easy to reason about when writing concurrent or sandboxed code.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-(/)"><a href="#val-(/)" class="anchor"></a><code><span><span class="keyword">val</span> (/) : <span><span><span>(<span>[&gt; <span class="xref-unresolved">Eio</span>.Fs.dir_ty ]</span> <span class="keyword">as</span> 'a)</span> <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Eio</span>.Path.t</span></span></code></div><div class="spec-doc"><p>Append a sub-path.</p><p><code>base / name</code> is a convenience alias for <code>Eio.Path.( / ) base name</code> which joins <code>name</code> onto the capability <code>base</code>. Only the string component of the path is modified; the underlying directory capability is preserved.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_res"><a href="#val-to_res" class="anchor"></a><code><span><span class="keyword">val</span> to_res : <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'a</span>, string)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>to_res f</code> executes <code>f ()</code> and converts its outcome to <code>`('a, string) result`</code>.</p><p>â€¢ Returns <code>Ok (f ())</code> when no exception is raised. â€¢ Returns <code>Error msg</code> if <code>f</code> raises, using <code>Eio.Exn.pp</code> to format the exception.</p><p>Handy at API boundaries where callers prefer a result type over exceptions.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-log"><a href="#val-log" class="anchor"></a><code><span><span class="keyword">val</span> log : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?file</span>:string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>log ~dir ?file msg</code> appends <code>msg</code> to <code>file</code> under <code>dir</code>.</p><p>The function opens (or creates with mode <code>0o600</code>) the target file in append mode and writes the string <i>verbatim</i> (no newline is added). Using <code>Eio.Path.with_open_out</code> makes the operation atomic with respect to other fibres in the current process.</p><p>Default <code>file</code> is <b>&quot;./logs.txt&quot;</b>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-console_log"><a href="#val-console_log" class="anchor"></a><code><span><span class="keyword">val</span> console_log : <span><span class="label">stdout</span>:<span><span>[&gt; <span class="xref-unresolved">Eio</span>.Flow.sink_ty ]</span> <span class="xref-unresolved">Eio</span>.Resource.t</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>console_log ~stdout msg</code> writes <code>msg</code> directly to <code>stdout</code>.</p><p>Thin wrapper over <code>Eio.Flow.copy_string</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-save_doc"><a href="#val-save_doc" class="anchor"></a><code><span><span class="keyword">val</span> save_doc : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Overwrite a file with <code>contents</code>.</p><p><code>save_doc ~dir file contents</code> is a convenience wrapper around <code>Eio.Path.save ~create:(`Or_truncate 0o777)</code>. The whole string is written in one go and the file is truncated beforehand if it exists.</p><p>Note that permissions <code>0o777</code> mimic the behaviour of the original code but may be too permissive for security-sensitive contexts.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-append_doc"><a href="#val-append_doc" class="anchor"></a><code><span><span class="keyword">val</span> append_doc : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Append <code>contents</code> to an existing file.</p><p>Behaviour is the same as <a href="#val-save_doc"><code>save_doc</code></a> except that data is added at the end of the file instead of overwriting it. A new file is created with mode <code>0o777</code> when missing.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-load_doc"><a href="#val-load_doc" class="anchor"></a><code><span><span class="keyword">val</span> load_doc : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Read a whole file into a string.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-delete_doc"><a href="#val-delete_doc" class="anchor"></a><code><span><span class="keyword">val</span> delete_doc : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Delete a file if it exists.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mkdir"><a href="#val-mkdir" class="anchor"></a><code><span><span class="keyword">val</span> mkdir : <span><span class="optlabel">?exists_ok</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Create a sub-directory.</p><p><code>mkdir ~dir sub</code> is equivalent to <code>Eio.Path.mkdirs ~perm:0o700 (dir / sub)</code>.</p><p>When <code>exists_ok</code> is <code>true</code> (default: <code>false</code>) no exception is raised if the directory is already present.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-directory"><a href="#val-directory" class="anchor"></a><code><span><span class="keyword">val</span> directory : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>string list</span></span></code></div><div class="spec-doc"><p>List entries of a directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_dir"><a href="#val-is_dir" class="anchor"></a><code><span><span class="keyword">val</span> is_dir : <span><span class="label">dir</span>:<span><span class="xref-unresolved">Eio</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Test whether a path is a directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_dir"><a href="#val-with_dir" class="anchor"></a><code><span><span class="keyword">val</span> with_dir : 
  <span><span class="label">dir</span>:<span><span>[&gt; <span class="xref-unresolved">Eio</span>.Fs.dir_ty ]</span> <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span>[ `Close <span>| `Dir</span> ]</span> <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Open <code>dir</code> and invoke <code>f</code> with an <code>Eio.Path.t</code> rooted at it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ensure_chatmd_dir"><a href="#val-ensure_chatmd_dir" class="anchor"></a><code><span><span class="keyword">val</span> ensure_chatmd_dir : 
  <span><span class="label">cwd</span>:<span><span>(<span>[&gt; <span class="xref-unresolved">Eio</span>.Fs.dir_ty ]</span> <span class="keyword">as</span> 'a)</span> <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="xref-unresolved">Eio</span>.Path.t</span></span></code></div><div class="spec-doc"><p>Guarantee that the hidden <code>\.chatmd</code> data-directory exists.</p><p><code>ensure_chatmd_dir ~cwd</code> returns <code>cwd /.chatmd</code>, creating the directory (permissions 0o700) on the first call. Subsequent calls are idempotent.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Net"><a href="#module-Net" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Net/index.html">Net</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module-type anchored" id="module-type-Task_pool_config"><a href="#module-type-Task_pool_config" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-Task_pool_config/index.html">Task_pool_config</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Task_pool"><a href="#module-Task_pool" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Task_pool/index.html">Task_pool</a></span><span> (<a href="Task_pool/argument-1-C/index.html">C</a> : <a href="module-type-Task_pool_config/index.html">Task_pool_config</a>) : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>A minimal domain-aware worker pool.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run_main"><a href="#val-run_main" class="anchor"></a><code><span><span class="keyword">val</span> run_main : <span><span>(<span><span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Convenience entry-point for CLI binaries.</p><p><code>run_main main</code> is equivalent to <code>Eio_main.run</code> but also initialises the default Mirage-crypto RNG (required by <code>tls-eio</code>) before delegating to <code>main</code>.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Server"><a href="#module-Server" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Server/index.html">Server</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Simple line-based echo server (demonstration purposes only).</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Client"><a href="#module-Client" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Client/index.html">Client</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Matching client implementation for <a href="Server/index.html"><code>Server</code></a>.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Run_server"><a href="#module-Run_server" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Run_server/index.html">Run_server</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Helper to spin up a local server and two test clients.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Base64"><a href="#module-Base64" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Base64/index.html">Base64</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Encode a local file into a &quot;data:&quot; URI.</p></div></div></div></body></html>
