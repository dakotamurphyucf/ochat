<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make (ochat.Ttl_lru_cache.Make)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ochat</a> &#x00BB; <a href="../index.html">Ttl_lru_cache</a> &#x00BB; Make</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Ttl_lru_cache.Make</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#parameters">Parameters</a></li><li><a href="#signature">Signature</a></li><li><a href="#types">Types</a></li><li><a href="#construction">Construction</a></li><li><a href="#ttl-helpers">TTL helpers</a></li><li><a href="#write-operations-with-ttl">Write operations with TTL</a></li><li><a href="#low-level-accessors">Low-level accessors</a></li><li><a href="#read-operations">Read operations</a></li><li><a href="#mutating-operations-inherited-from-">Mutating operations inherited from <code>Lru_cache</code></a></li></ul></nav></div><div class="odoc-content"><h2 id="parameters"><a href="#parameters" class="anchor"></a>Parameters</h2><div class="odoc-spec"><div class="spec parameter anchored" id="argument-1-H"><a href="#argument-1-H" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="argument-1-H/index.html">H</a></span><span> : <a href="../../Lru_cache/module-type-H/index.html">Lru_cache.H</a></span></code></div></div><h2 id="signature"><a href="#signature" class="anchor"></a>Signature</h2><h2 id="types"><a href="#types" class="anchor"></a>Types</h2><div class="odoc-spec"><div class="spec type anchored" id="type-entry"><a href="#type-entry" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a entry</span></span><span> = </span><span>{</span></code><ol><li id="type-entry.data" class="def record field anchored"><a href="#type-entry.data" class="anchor"></a><code><span>data : <span class="type-var">'a</span>;</span></code></li><li id="type-entry.expires_at" class="def record field anchored"><a href="#type-entry.expires_at" class="anchor"></a><code><span>expires_at : <span class="xref-unresolved">Core</span>.Time_ns.Span.t;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Serializable record stored in the cache. The <code>data</code> payload is user supplied. <code>expires_at</code> is an absolute deadline â€“ the binding is treated as stale for all <code>now &gt;= expires_at</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sexp_of_entry"><a href="#val-sexp_of_entry" class="anchor"></a><code><span><span class="keyword">val</span> sexp_of_entry : <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Sexplib0</span>.Sexp.t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-entry_of_sexp"><a href="#val-entry_of_sexp" class="anchor"></a><code><span><span class="keyword">val</span> entry_of_sexp : <span><span>(<span><span class="xref-unresolved">Sexplib0</span>.Sexp.t <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Sexplib0</span>.Sexp.t <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bin_shape_entry"><a href="#val-bin_shape_entry" class="anchor"></a><code><span><span class="keyword">val</span> bin_shape_entry : <span><span class="xref-unresolved">Core</span>.Bin_prot.Shape.t <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Core</span>.Bin_prot.Shape.t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bin_size_entry"><a href="#val-bin_size_entry" class="anchor"></a><code><span><span class="keyword">val</span> bin_size_entry : 
  <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Core</span>.Bin_prot.Size.sizer</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="xref-unresolved">Core</span>.Bin_prot.Size.sizer</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bin_write_entry"><a href="#val-bin_write_entry" class="anchor"></a><code><span><span class="keyword">val</span> bin_write_entry : 
  <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Core</span>.Bin_prot.Write.writer</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="xref-unresolved">Core</span>.Bin_prot.Write.writer</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bin_writer_entry"><a href="#val-bin_writer_entry" class="anchor"></a><code><span><span class="keyword">val</span> bin_writer_entry : 
  <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Core</span>.Bin_prot.Type_class.writer</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="xref-unresolved">Core</span>.Bin_prot.Type_class.writer</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bin_read_entry"><a href="#val-bin_read_entry" class="anchor"></a><code><span><span class="keyword">val</span> bin_read_entry : 
  <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Core</span>.Bin_prot.Read.reader</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="xref-unresolved">Core</span>.Bin_prot.Read.reader</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-__bin_read_entry__"><a href="#val-__bin_read_entry__" class="anchor"></a><code><span><span class="keyword">val</span> __bin_read_entry__ : 
  <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Core</span>.Bin_prot.Read.reader</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span>)</span> <span class="xref-unresolved">Core</span>.Bin_prot.Read.reader</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bin_reader_entry"><a href="#val-bin_reader_entry" class="anchor"></a><code><span><span class="keyword">val</span> bin_reader_entry : 
  <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Core</span>.Bin_prot.Type_class.reader</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="xref-unresolved">Core</span>.Bin_prot.Type_class.reader</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bin_entry"><a href="#val-bin_entry" class="anchor"></a><code><span><span class="keyword">val</span> bin_entry : 
  <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Core</span>.Bin_prot.Type_class.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="xref-unresolved">Core</span>.Bin_prot.Type_class.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash_fold_entry"><a href="#val-hash_fold_entry" class="anchor"></a><code><span><span class="keyword">val</span> hash_fold_entry : 
  <span><span>(<span><span class="xref-unresolved">Ppx_hash_lib</span>.Std.Hash.state <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppx_hash_lib</span>.Std.Hash.state)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ppx_hash_lib</span>.Std.Hash.state <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppx_hash_lib</span>.Std.Hash.state</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compare_entry"><a href="#val-compare_entry" class="anchor"></a><code><span><span class="keyword">val</span> compare_entry : <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> int)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span></code></div><div class="spec-doc"><p>Cache handle. All operations have the same amortised complexity as their <a href="../../Lru_cache/index.html"><code>Lru_cache</code></a> counterparts.</p></div></div><h2 id="construction"><a href="#construction" class="anchor"></a>Construction</h2><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span><span class="label">max_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>create ~max_size ()</code> returns an empty cache that can grow to at most <code>max_size</code> bindings (same semantics as <a href="../../Lru_cache/Make/index.html#val-create"><code>Lru_cache.Make.create</code></a>). Negative sizes are rejected with an exception.</p></div></div><h2 id="ttl-helpers"><a href="#ttl-helpers" class="anchor"></a>TTL helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-is_expired"><a href="#val-is_expired" class="anchor"></a><code><span><span class="keyword">val</span> is_expired : <span><span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">now</span>:<span class="xref-unresolved">Core</span>.Time_ns.Span.t <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>is_expired entry ~now</code> is <code>true</code> iff <code>now &gt;= entry.expires_at</code>. Useful when post-processing a cache snapshot loaded from disk.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove_expired"><a href="#val-remove_expired" class="anchor"></a><code><span><span class="keyword">val</span> remove_expired : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>remove_expired t</code> iterates over the cache and purges *all* bindings that are already expired at the time of the call.</p><p>Warning: the traversal is O(length t). Prefer calling it sparingly or in maintenance windows for large caches.</p></div></div><h2 id="write-operations-with-ttl"><a href="#write-operations-with-ttl" class="anchor"></a>Write operations with TTL</h2><div class="odoc-spec"><div class="spec value anchored" id="val-set_with_ttl"><a href="#val-set_with_ttl" class="anchor"></a><code><span><span class="keyword">val</span> set_with_ttl : 
  <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">key</span>:<a href="argument-1-H/index.html#type-t">H.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data</span>:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ttl</span>:<span class="xref-unresolved">Core</span>.Time_ns.Span.t <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>set_with_ttl t ~key ~data ~ttl</code> stores <code>(key, data)</code> and marks it as valid for the next <code>ttl</code> seconds. Internally, <code>ttl</code> is added to <code>Time_ns.Span.since_unix_epoch ()</code> to compute <code>expires_at</code>. A negative <code>ttl</code> immediately expires the binding.</p></div></div><h2 id="low-level-accessors"><a href="#low-level-accessors" class="anchor"></a>Low-level accessors</h2><p>The following functions expose the underlying <a href="../../Lru_cache/index.html"><code>Lru_cache</code></a> API so that a cache can be persisted and re-loaded. They make no attempt to refresh TTLs.</p><div class="odoc-spec"><div class="spec value anchored" id="val-set"><a href="#val-set" class="anchor"></a><code><span><span class="keyword">val</span> set : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">key</span>:<a href="argument-1-H/index.html#type-t">H.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">data</span>:<span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Hydrate <code>t</code> with a previously serialised <code>entry</code>. The call respects the LRU semantics (the binding becomes most-recently-used) but does *not* validate the freshness â€“ callers are responsible for discarding stale entries.</p></div></div><h2 id="read-operations"><a href="#read-operations" class="anchor"></a>Read operations</h2><p>All reads promote the binding to most-recently-used *if and only if* it is still fresh. An expired binding is removed and the read behaves as a cache miss.</p><div class="odoc-spec"><div class="spec value anchored" id="val-find"><a href="#val-find" class="anchor"></a><code><span><span class="keyword">val</span> find : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="argument-1-H/index.html#type-t">H.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>find t key</code> returns <code>`Some data</code> if <code>key</code> is present **and** the binding has not expired, <code>`None</code> otherwise. The function has the side effect of deleting the binding when it is found to be stale.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mem"><a href="#val-mem" class="anchor"></a><code><span><span class="keyword">val</span> mem : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="argument-1-H/index.html#type-t">H.t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>mem t key</code> is equivalent to <code>Option.is_some (find t key)</code>.</p></div></div><h2 id="mutating-operations-inherited-from-"><a href="#mutating-operations-inherited-from-" class="anchor"></a>Mutating operations inherited from <a href="../../Lru_cache/index.html"><code>Lru_cache</code></a></h2><p>These functions have unchanged semantics and complexity.</p><div class="odoc-spec"><div class="spec value anchored" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span><span class="keyword">val</span> remove : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="argument-1-H/index.html#type-t">H.t</a> <span class="arrow">&#45;&gt;</span></span> <span>[ `No_such_key <span>| `Ok</span> ]</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear"><a href="#val-clear" class="anchor"></a><code><span><span class="keyword">val</span> clear : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>[ <span>`Dropped of int</span> ]</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-length"><a href="#val-length" class="anchor"></a><code><span><span class="keyword">val</span> length : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-max_size"><a href="#val-max_size" class="anchor"></a><code><span><span class="keyword">val</span> max_size : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hit_rate"><a href="#val-hit_rate" class="anchor"></a><code><span><span class="keyword">val</span> hit_rate : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> float</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-stats"><a href="#val-stats" class="anchor"></a><code><span><span class="keyword">val</span> stats : <span><span class="optlabel">?sexp_of_key</span>:<span>(<span><a href="argument-1-H/index.html#type-t">H.t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Core</span>.Sexp.t)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Core</span>.Sexp.t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_empty"><a href="#val-is_empty" class="anchor"></a><code><span><span class="keyword">val</span> is_empty : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_alist"><a href="#val-to_alist" class="anchor"></a><code><span><span class="keyword">val</span> to_alist : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="argument-1-H/index.html#type-t">H.t</a> * <span><span class="type-var">'a</span> <a href="#type-entry">entry</a></span>)</span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_max_size"><a href="#val-set_max_size" class="anchor"></a><code><span><span class="keyword">val</span> set_max_size : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">max_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span>[ <span>`Dropped of int</span> ]</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_or_add"><a href="#val-find_or_add" class="anchor"></a><code><span><span class="keyword">val</span> find_or_add : 
  <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="argument-1-H/index.html#type-t">H.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">default</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ttl</span>:<span class="xref-unresolved">Core</span>.Time_ns.Span.t <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>find_or_add t key ~default ~ttl</code> is equivalent to:</p><pre class="language-ocaml"><code>  match find t key with
  | Some v -&gt; v                         (* cache hit *)
  | None -&gt;                              (* miss or expired *)
    let v = default () in
    set_with_ttl t ~key ~data:v ~ttl;
    v</code></pre><p>The newly inserted binding expires after <code>ttl</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_and_remove"><a href="#val-find_and_remove" class="anchor"></a><code><span><span class="keyword">val</span> find_and_remove : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="argument-1-H/index.html#type-t">H.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>find_and_remove t key</code> returns the data bound to <code>key</code> if present and fresh, then deletes the binding unconditionally (expired or not). The operation counts as a cache hit when the result is <code>`Some _</code>.</p></div></div></div></body></html>
