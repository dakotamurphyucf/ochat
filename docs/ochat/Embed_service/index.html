<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Embed_service (ochat.Embed_service)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../';
let search_urls = ['../db.js','../../sherlodoc.js'];
</script><script src="../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ochat</a> &#x00BB; Embed_service</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Embed_service</span></code></h1><p>Throttled access to the OpenAI *Embeddings* endpoint.</p><p>The returned <code>embed</code> function may be invoked concurrently from any fibre. Internally, requests are serialised through a single background daemon so that at most <code>rate_per_sec</code> HTTP calls are issued. Each request is retried up to three times with 1&amp;nbsp;s exponential back-off before the error is propagated to the caller.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#guarantees">Guarantees</a></li><li><a href="#example">Example</a></li></ul></nav></div><div class="odoc-content"><h2 id="guarantees"><a href="#guarantees" class="anchor"></a>Guarantees</h2><p>â€¢ <b>Concurrency-safe</b>: no global locks are required at call-sites. â€¢ <b>Rate-limited</b>: wall-clock throughput never exceeds <code>rate_per_sec</code> requests/second. â€¢ <b>Resilient</b>: transient failures are transparently retried.</p><h2 id="example"><a href="#example" class="anchor"></a>Example</h2><pre class="language-ocaml"><code>  let embed =
    Embed_service.create
      ~sw
      ~clock
      ~net
      ~codec:Tikitoken.Cl100k_base.codec
      ~rate_per_sec:10
      ~get_id:Digest.string
  in
  let snippets = [ (&quot;module.ml&quot;, &quot;let x = 1&quot;) ] in
  let (_meta, _text, vec) :: _ = embed snippets in
  Float.equal (Array.length vec.vector |&gt; Float.of_int) 1536.</code></pre><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="label">sw</span>:<span class="xref-unresolved">Eio</span>.Switch.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">clock</span>:<span><span class="type-var">'a</span> <span class="xref-unresolved">Eio</span>.Time.clock</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">net</span>:<span><span class="type-var">'b</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">codec</span>:<a href="../Tikitoken/index.html#type-codec">Tikitoken.codec</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">rate_per_sec</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">get_id</span>:<span>(<span><span class="type-var">'meta</span> <span class="arrow">&#45;&gt;</span></span> string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'meta</span> * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'meta</span> * string * <a href="../Vector_db/Vec/index.html#type-t">Vector_db.Vec.t</a>)</span> list</span></span></code></div><div class="spec-doc"><p><code>create ~sw ~clock ~net ~codec ~rate_per_sec ~get_id</code> returns an embedding function.</p><p><code>embed snippets</code> maps each <code>(meta, text)</code> pair in <code>snippets</code> to a triple <code>(meta, text, vec)</code> where <code>vec</code> is the unnormalised embedding returned by <a href="../Openai/Embeddings/index.html#val-post_openai_embeddings"><code>Openai.Embeddings.post_openai_embeddings</code></a>.</p><p>Parameters: â€¢ <code>sw</code> â€“ parent <code>Eio.Switch.t</code> for the background daemon. â€¢ <code>clock</code> â€“ wall clock for throttling and back-off. â€¢ <code>net</code> â€“ network capability used for HTTPS calls. â€¢ <code>codec</code> â€“ <a href="../Tikitoken/index.html#type-codec"><code>Tikitoken.codec</code></a> used to count tokens locally. â€¢ <code>rate_per_sec</code> â€“ maximum number of requests per second (&gt; 0). â€¢ <code>get_id</code> â€“ maps the caller-supplied metadata to a stable identifier.</p><p>Behaviour: â€¢ The call returns immediately after enqueuing; the actual HTTP request runs in the daemon fibre. â€¢ Token length is computed locally and copied into the resulting <a href="../Vector_db/Vec/index.html#type-t"><code>Vector_db.Vec.t</code></a>. â€¢ If the remote endpoint fails, the call is retried up to three times; the final failure is re-raised.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Failure</code> <p>if <code>rate_per_sec</code> â‰¤ 0</p></li></ul></div></div></div></body></html>
