<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Odoc_indexer (ochat.Odoc_indexer)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../';
let search_urls = ['../db.js','../../sherlodoc.js'];
</script><script src="../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ochat</a> &#x00BB; Odoc_indexer</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Odoc_indexer</span></code></h1><p>End-to-end indexing of documentation produced by the <a href="https://ocaml.org/p/odoc/latest">odoc</a> tool-chain.</p><p>The function <a href="#val-index_packages"><code>index_packages</code></a> turns the HTML pages located under the <code>_doc/_html</code> directory created by</p><pre class="language-ocaml"><code> dune build @doc </code></pre><p>into a multi-modal search corpus made up of:</p><p>â€¢ dense vector embeddings suitable for nearest-neighbour search (saved via <a href="../Vector_db/Vec/index.html#val-write_vectors_to_disk"><code>Vector_db.Vec.write_vectors_to_disk</code></a>); â€¢ lexical BM-25 indices (saved via <a href="../Bm25/index.html#val-write_to_disk"><code>Bm25.write_to_disk</code></a>); â€¢ the raw Markdown snippets, one file per chunk, so that the caller can display the full context of a hit.</p><p>The pipeline executed for each *opam package* folder is:</p><ol><li>traverse the directory tree with <a href="../Odoc_crawler/index.html#val-crawl"><code>Odoc_crawler.crawl</code></a>;</li><li>slice every HTML / README into 64â€“320-token windows with <a href="../Odoc_snippet/index.html#val-slice"><code>Odoc_snippet.slice</code></a>;</li><li>batch the chunks in groups of â‰¤ 300 and obtain embeddings from the OpenAI *Embedding* API; requests are funneled through a single fibre that enforces a per-second cap (see <a href="../Embed_service/index.html"><code>Embed_service</code></a>);</li><li>write the embeddings, BM25 index and Markdown files to <code>output/pkg/</code>;</li><li>gather a short blurb (first non-empty line) for each package and store it in <a href="../Package_index/index.html"><code>Package_index</code></a>.</li></ol><p>Concurrency model:</p><p>â€¢ CPU-bound slicing runs in a <a href="../Io/Task_pool/index.html"><code>Io.Task_pool</code></a> backed by one domain per physical core. â€¢ IO-bound embedding calls are executed by the main fibre but throttled to respect provider quotas.</p><p>Cancellation: the whole operation is enclosed in a <code>Switch</code>; aborting the switch propagates to every child fibre and ensures no partial files are left behind.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-I"><a href="#module-I" class="anchor"></a><code><span><span class="keyword">module</span> I</span><span> = <a href="../Io/index.html">Io</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-token_count"><a href="#val-token_count" class="anchor"></a><code><span><span class="keyword">val</span> token_count : <span><span class="label">codec</span>:<a href="../Tikitoken/index.html#type-codec">Tikitoken.codec</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>token_count ~codec text</code> returns the approximate number of BPE tokens in <code>text</code>. If <code>Tikitoken.encode</code> raises (e.g. because the text contains invalid UTF-8) or if the fallback heuristic is considered quicker, the function falls back to whitespace splitting. This helper is *internal* and its behaviour is not stable â€“ do not rely on it from outside the module.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-meta_to_string"><a href="#val-meta_to_string" class="anchor"></a><code><span><span class="keyword">val</span> meta_to_string : <span><a href="../Odoc_snippet/index.html#type-meta">Odoc_snippet.meta</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>meta_to_string m</code> renders <code>m</code> in the *legacy* pseudo-ocamldoc header format used by early experiments. New code should rely on the serialised <a href="../Odoc_snippet/index.html#type-meta"><code>Odoc_snippet.meta</code></a> record and avoid parsing this textual representation. The function is kept only because some historical corpora still expect it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_vectors"><a href="#val-get_vectors" class="anchor"></a><code><span><span class="keyword">val</span> get_vectors : 
  <span><span class="optlabel">?attempts</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">net</span>:<span><span>[&gt; <span><span>[&gt; `Generic ]</span> <span class="xref-unresolved">Eio</span>.Net.ty</span> ]</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">codec</span>:<a href="../Tikitoken/index.html#type-codec">Tikitoken.codec</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Odoc_snippet/index.html#type-meta">Odoc_snippet.meta</a> * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../Odoc_snippet/index.html#type-meta">Odoc_snippet.meta</a> * string * <a href="../Vector_db/Vec/index.html#type-t">Vector_db.Vec.t</a>)</span> list</span></span></code></div><div class="spec-doc"><p><code>get_vectors ~net ~codec snippets</code> calls the OpenAI Embeddings endpoint and returns a triple of <code>(meta, text, vec)</code> for every snippet in <code>snippets</code>.</p><p>The function retries up to three times on transient network failures. Each retry attempts to re-encode the *whole* batch â€“ partial success is not currently supported.</p><p>Returned vectors are **not** L2-normalised; that is done by <a href="../Vector_db/index.html#val-create_corpus"><code>Vector_db.create_corpus</code></a> during loading.</p></div></div><p>Strategy for selecting which opam packages are crawled and (re-)indexed. The default <a href="#type-package_filter.All"><code>All</code></a> indexes every directory under <code>root</code>. <a href="#type-package_filter.Include"><code>Include</code></a> and <a href="#type-package_filter.Exclude"><code>Exclude</code></a> allow whitelisting / blacklisting, while <a href="#type-package_filter.Update"><code>Update</code></a> is geared towards incremental maintenance of an already-built corpus.</p><div class="odoc-spec"><div class="spec type anchored" id="type-package_filter"><a href="#type-package_filter" class="anchor"></a><code><span><span class="keyword">type</span> package_filter</span><span> = </span></code><ol><li id="type-package_filter.Include" class="def variant constructor anchored"><a href="#type-package_filter.Include" class="anchor"></a><code><span>| </span><span><span class="constructor">Include</span> <span class="keyword">of</span> <span>string list</span></span></code></li><li id="type-package_filter.Exclude" class="def variant constructor anchored"><a href="#type-package_filter.Exclude" class="anchor"></a><code><span>| </span><span><span class="constructor">Exclude</span> <span class="keyword">of</span> <span>string list</span></span></code></li><li id="type-package_filter.Update" class="def variant constructor anchored"><a href="#type-package_filter.Update" class="anchor"></a><code><span>| </span><span><span class="constructor">Update</span> <span class="keyword">of</span> <a href="#type-package_filter">package_filter</a> * <span>string list</span></span></code></li><li id="type-package_filter.All" class="def variant constructor anchored"><a href="#type-package_filter.All" class="anchor"></a><code><span>| </span><span><span class="constructor">All</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-index_packages"><a href="#val-index_packages" class="anchor"></a><code><span><span class="keyword">val</span> index_packages : 
  <span><span class="optlabel">?filter</span>:<a href="#type-package_filter">package_filter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">root</span>:<span><span>[&gt; <span class="xref-unresolved">Eio__</span>.Fs.dir_ty ]</span> <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">output</span>:<span><span class="xref-unresolved">Eio__</span>.Fs.dir_ty <span class="xref-unresolved">Eio</span>.Path.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">net</span>:<span><span>[&gt; <span><span>[&gt; `Generic ]</span> <span class="xref-unresolved">Eio</span>.Net.ty</span> ]</span> <span class="xref-unresolved">Eio</span>.Net.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>index_packages ?filter ~env ~root ~output ~net ()</code> builds a vector &amp; BM-25 search corpus for every package folder under <code>root</code> and stores the artefacts under <code>output</code>.</p><p>Parameters:</p><p>â€¢ <code>?filter</code> â€“ fine-grained selection of the packages to process. The value is of type <a href="#type-package_filter"><code>package_filter</code></a> and supports several modes:</p><ul><li><a href="#type-package_filter.All"><code>All</code></a> â€“ (default) index every first-level directory under <code>root</code>;</li><li><a href="#type-package_filter.Include"><code>Include</code></a> <code>pkgs</code> â€“ only the packages in <code>pkgs</code>;</li><li><a href="#type-package_filter.Exclude"><code>Exclude</code></a> <code>pkgs</code> â€“ all except the packages in <code>pkgs</code>;</li><li><a href="#type-package_filter.Update"><code>Update</code></a> (prev, pkgs) â€“ treat <code>pkgs</code> as a delta on top of <code>prev</code>. This is handy to perform incremental updates on an existing corpus without a full rebuild.</li></ul><p>â€¢ <code>env</code> â€“ capability bundle provided by <code>Eio_main.run</code>; its <code>clock</code>, <code>net</code> and <code>fs</code> fields are used for, respectively, time-outs, HTTP calls and file IO.</p><p>â€¢ <code>root</code> â€“ directory produced by </p><pre class="language-ocaml"><code> dune build @doc </code></pre><p>. Each first-level directory beneath <code>root</code> is treated as an opam package.</p><p>â€¢ <code>output</code> â€“ destination folder. For every package *foo* the function creates:</p><ul><li>*foo*/vectors.binio â€“ array of <a href="../Vector_db/Vec/index.html#type-t"><code>Vector_db.Vec.t</code></a>;</li><li>*foo*/bm25.binio â€“ <a href="../Bm25/index.html#type-t"><code>Bm25.t</code></a>;</li><li>*foo*/&lt;id&gt;.md â€“ raw Markdown snippet for each chunk.</li></ul><p>â€¢ <code>net</code> â€“ network capability used by <a href="../Openai/Embeddings/index.html"><code>Openai.Embeddings</code></a>.</p><p>Behaviour &amp; guarantees:</p><p>â€¢ Slicing and embedding happen concurrently â€“ CPU-bound work is off-loaded to a pool of domains, HTTP calls are batched and throttled.</p><p>â€¢ Progress is logged via <a href="../Log/index.html#val-emit"><code>Log.emit</code></a> and spanned so that a Jaeger/OpenTelemetry backend can visualise the trace.</p><p>â€¢ The function is synchronous; it returns only after *all* artefacts have been flushed to disk.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>exn</code> <p>on unrecoverable filesystem or network errors. All transient failures (OpenAI 5xx, time-outs) are retried up to 3 times before escalating.</p></li></ul></div></div></div></body></html>
