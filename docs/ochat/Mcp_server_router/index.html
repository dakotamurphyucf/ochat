<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Mcp_server_router (ochat.Mcp_server_router)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../';
let search_urls = ['../db.js','../../sherlodoc.js'];
</script><script src="../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ochat</a> &#x00BB; Mcp_server_router</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Mcp_server_router</span></code></h1><p>JSON-RPC message router for an MCP server.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#overview">Overview</a></li></ul></nav></div><div class="odoc-content"><h2 id="overview"><a href="#overview" class="anchor"></a>Overview</h2><p><code>`Mcp_server_router`</code> is a <b>pure</b> dispatcher that translates raw JSON-RPC 2.0 envelopes into high-level operations on a shared <a href="../Mcp_server_core/index.html#type-t"><code>Mcp_server_core.t</code></a> registry. The module contains <i>no</i> blocking I/O; all side-effects (tool execution, structured logging, progress streaming ‚Ä¶) are delegated to the injected registry or performed by the tool handlers themselves.</p><p>The only entry-point <a href="#val-handle"><code>handle</code></a> accepts either a single request or a batch (JSON array). For each valid request the function returns exactly one response ‚Äì unless the message is a <i>notification</i>, in which case no response is produced. Errors are <b>never</b> raised to the caller; they are converted into well-formed JSON-RPC error objects so that the transport layer can forward them verbatim.</p><p>Supported methods (Phase 1):</p><ul><li><code>&quot;initialize&quot;</code> ‚Äì protocol and capability negotiation</li><li><code>&quot;tools/list&quot;</code> ‚Äì list registered tools</li><li><code>&quot;tools/call&quot;</code> ‚Äì invoke a tool by name</li><li><code>&quot;prompts/list&quot;</code> ‚Äì list registered prompts</li><li><code>&quot;prompts/get&quot;</code> ‚Äì fetch a single prompt</li><li><code>&quot;roots/list&quot;</code> ‚Äì enumerate project roots</li><li><code>&quot;resources/list&quot;</code>, <code>&quot;resources/read&quot;</code> ‚Äì minimal resource API</li><li><code>&quot;ping&quot;</code> ‚Äì liveness probe</li></ul><p>Additional methods can be added transparently; unknown ones yield a ‚ÄúMethod not found‚Äù JSON-RPC error.</p><div class="odoc-spec"><div class="spec module anchored" id="module-JT"><a href="#module-JT" class="anchor"></a><code><span><span class="keyword">module</span> JT</span><span> = <a href="../Mcp_types/index.html">Mcp_types</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-handle"><a href="#val-handle" class="anchor"></a><code><span><span class="keyword">val</span> handle : 
  <span><span class="label">core</span>:<a href="../Mcp_server_core/index.html#type-t">Mcp_server_core.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">env</span>:<span class="xref-unresolved">Eio_unix</span>.Stdenv.base <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Jsonaf</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Jsonaf</span>.t list</span></span></code></div><div class="spec-doc"><p><code>handle ~core ~env json</code> routes the RPC envelope <code>json</code> and returns the list of responses that must be sent back to the client in the same order.</p><p>Invariants:</p><ul><li>Never raises ‚Äì every exception is wrapped in a JSON-RPC error.</li><li>Notifications yield <code>[ ]</code> (empty list).</li><li>Batches preserve order and <em>at most</em> one response per element.</li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">core</span> <p>shared registry used for tools, prompts, logging, ‚Ä¶</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">env</span> <p>Eio standard environment, required for filesystem access inside the resource handlers.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">json</span> <p>one JSON-RPC 2.0 request/notification or an array thereof.</p></li></ul><p>Example ‚Äì answering a ping</p><pre class="language-ocaml"><code>{
  open Core

  let () =
    (* 1 ‚Äì bootstrap the registry *)
    let registry = Mcp_server_core.create () in

    (* 2 ‚Äì build a JSON-RPC request  *)
    let open Mcp_types.Jsonrpc in
    let req =
      make_request ~id:(Id.of_int 1) ~method_:&quot;ping&quot; ()
      |&gt; jsonaf_of_request
    in

    (* 3 ‚Äì route it (we run in the main domain; use a dummy env) *)
    Eio_main.run @@ fun env -&gt;
    let replies = Mcp_server_router.handle ~core:registry ~env req in
    List.iter replies ~f:(fun r -&gt; Format.printf &quot;%a@.&quot; Jsonaf.pp r)
}</code></pre></div></div></div></body></html>
