# `bin/main.ml` – OCaml source behind the `ochat` executable

This document describes the **implementation module** of the
`ochat` command-line application that ships with this repository.  The
public-facing manual of the tool (sub-command synopsis, usage examples,
etc.) lives in [`docs-src/bin/ochat.doc.md`](ochat.doc.md); the goal here is to
explain **how** the OCaml code wires everything together and to provide a
reference for maintainers.

---

## 1  Module role

`bin/main.ml` contains a single compilation unit which:

1. Instantiates *five* independent `Core.Command.basic` values – one per
   feature exposed at the CLI.
2. Collects them under a `Core.Command.group` called
   `main_command` and delegates execution to
   `Command_unix.run`.

The file does **not** export a `.mli` interface – the produced binary is
meant to be used externally only through its command-line surface.

---

## 2  Sub-command API

Below is a condensed overview of each value bound in the module.  All of
them follow the conventional `Core.Command` pattern and therefore share
common behaviour w.r.t flag parsing, `-help`, etc.

### 2.1  `index_command`

```ocaml
val index_command : Core.Command.t
```

Builds a dense-vector + BM-25 corpus from an OCaml source tree.  The
heavy work is delegated to `Indexer.index` while the surrounding code
merely:

* parses CLI flags;
* prints a few progress messages with `Io.log`;
* opens an `Eio.Switch` to enforce structured concurrency.

Example:

```console
$ ochat index -folder-to-index ./lib -vector-db-folder ./_index
```

### 2.2  `query_command`

```ocaml
val query_command : Core.Command.t
```

Performs **hybrid retrieval** (cosine ✕ BM-25) over a corpus generated by
`index_command`.  The function:

1. Loads vector and lexical indices from disk.
2. Fetches a single OpenAI embedding for the user query.
3. Calls `Vector_db.query_hybrid` to obtain the top-*k* snippet IDs.
4. Pretty-prints the associated code blocks.

```console
$ ochat query -vector-db-folder ./_index \
           -query-text "tail-recursive map" \
           -num-results 3
```

### 2.3  `chat_completion_command`

```ocaml
val chat_completion_command : Core.Command.t
```

Streams an assistant reply from the OpenAI *Chat Completion* endpoint
based on a *chatmd* conversation.  The implementation is a one-liner
around `Chat_response.Driver.run_completion_stream`.

Flags of interest:

| Flag | Default | Meaning |
|------|---------|---------|
| `-prompt-file`  | *(none)* | Template prepended once at the start of the transcript |
| `-output-file`  | `./prompts/default.md` | Running conversation log |

### 2.4  `tokenize_command`

```ocaml
val tokenize_command : Core.Command.t
```

Counts how many *cl100k_base* tokens a file occupies according to the
[Tikitoken](https://github.com/openai/tiktoken) encoding.

```console
$ ochat tokenize -file README.md
```

### 2.5  `html_to_markdown_command` / `h2md`

```ocaml
val html_to_markdown_command : Core.Command.t
```

Converts an HTML document to Markdown and prints the chunk boundaries
that `Odoc_snippet.Chunker` discovers.  Primarily useful for debugging
automatic snippet extraction.

```console
$ ochat h2md -file tutorial.html
```

### 2.6  `main_command`

```ocaml
val main_command : Core.Command.t
```

A `Core.Command.group` that ties all previous commands together.  The
call to `Command_unix.run` at the very end of the file is the *only*
side-effect executed at module initialisation time.

---

## 3  Internal helpers

The module opens `Io` and therefore uses `Io.run_main` and
`Io.console_log` for concise interaction with the underlying `Eio`
environment.  These helpers are *application-specific* and documented
separately in [`docs-src/lib/io.doc.md`](../lib/io.doc.md).

---

## 4  Known limitations

* **No unit tests** – behavioural changes of sub-commands are currently
  smoke-tested manually.
* **Hard-coded model names** – updating to newer OpenAI models requires a
  source edit.
* **Exit codes** – unhandled OCaml exceptions propagate to the top and
  result in a non-zero exit status without structured error handling.

---

## 5  Related modules

* [`Indexer`](../lib/indexer.doc.md) – building the corpus
* [`Vector_db`](../lib/vector_db.doc.md) – hybrid retrieval engine
* [`Chat_response.Driver`](../lib/chat_response.doc.md) – chatmd runtime
* [`Odoc_snippet`](../lib/odoc_snippet.doc.md) – Markdown chunking logic

---
